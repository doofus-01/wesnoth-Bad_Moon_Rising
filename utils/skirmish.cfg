#textdomain wesnoth-Bad_Moon_Rising

# this is not for skirmish, per se, but I think here is a good place for it.

#define BMR_SIDE_FIRST
    # this determines who gets the first move, depending upon who attacked who on the worldmap
    [event]
        name=side 1 turn 1
        [if]
            [variable]
                name=bmr_battle_ambushed
                equals=yes
            [/variable]
            [then]
                [end_turn]
                [/end_turn]
            [/then]
        [/if]
    [/event]
#enddef

#define BMR_BATTLE_RANDOM_MAP_old
    # place this in prestart

    [set_variable]
        name=map_num
        rand=1..4
    [/set_variable]
    [switch]
        variable=map_num
        [case]
            value=2
            [replace_map]
                map="{~add-ons/Bad_Moon_Rising/maps/World_Battle2.map}"
            [/replace_map]
        [/case]
        [case]
            value=3
            [replace_map]
                map="{~add-ons/Bad_Moon_Rising/maps/World_Battle3.map}"
            [/replace_map]
        [/case]
        [case]
            value=4
            [replace_map]
                map="{~add-ons/Bad_Moon_Rising/maps/World_Battle4.map}"
            [/replace_map]
        [/case]
    [/switch]
    {CLEAR_VARIABLE map_num}
#enddef

#define BMR_SKIRMISH_RANDOM_MAP
    map_generation="lua"
    [generator]
        id="BMR_WM_skirmish"
        config_name="Lua Map Generator 2"
        create_map = <<
         local rng = Rng:create()

         print(rng:draw())
         print(rng:draw())
         print(rng:draw())

         local w = 30
         local h = 30

         local s1x = (rng:draw() % 18) + 6 
         local s1y = (rng:draw() % 18) + 6 
         local s2x = (rng:draw() % 18) + 6 
         local s2y = (rng:draw() % 18) + 6 
	 if s1x == s2x and s1y == s2y then
		s1x = 9
		s2x = 22
		s1y = 9
		s2y = 22
	 end

         map=""

         for y=1,h do

            for x=1,w do
               if x == s1x and y == s1y then
                  map = map .. " 1 "
               end

               if x == s2x and y == s2y then
                  map = map .. " 2 "
               end

               local r0 = rng:draw() % 20 
               local r = rng:draw() % 20 
               local r2 = rng:draw() % 10
               local r3 = rng:draw() % 5
               if ((x + y) % 2) == r then
                  map = map .. "Cha"
               elseif ((x + y) % 2) == r0 then
                  map = map .. "Rb"
               elseif ((x + y) % 2) == r2 then
                  map = map .. "Re"
               elseif ((x - y) % 2) == r3 then
                  map = map .. "Hh"
               else
                  map = map .. "Gg"
               end

               if x ~= w then
                  map = map .. ","
               end
            end

            map = map .. "\n"
         end

         return map
      >>
    [/generator]
#enddef

#define BMR_BATTLE_RANDOM_MAP
    map_generation="lua"
    [generator]
        id="BMR_WM_battle"
        config_name="Lua Map Generator"
        create_map = <<
         local rng = Rng:create()

         print(rng:draw())
         print(rng:draw())
         print(rng:draw())

         local w = 33
         local h = 33

         map=""

         for y=1,h do

            for x=1,w do
               if x == 7 and y == 28 then
                  map = map .. " 1 "
               end

               if x == 27 and y == 10 then
                  map = map .. " 2 "
               end

               local r = rng:draw() % 12 
               local r2 = rng:draw() % 4
               local r3 = rng:draw() % 4
               if ((x + y) % 4) == r then
                  map = map .. "Re"
               elseif ((x + y) % 6) == r3 then
                  map = map .. "Aa^Fpa"
               elseif ((x - y) % 8) == r2 then
                  map = map .. "Ha"
               else
                  map = map .. "Aa"
               end

               if x ~= w then
                  map = map .. ","
               end
            end

            map = map .. "\n"
         end

         return map
      >>
    [/generator]
#enddef

#define BMR_SKIRMISH_RANDOM_MASK_INTERNAL TC1 TC2 TC3
    # mask for skirmish random map
    [terrain]
        terrain={TC1}
        [and]
            terrain=Gg
        [/and]
    [/terrain]
    [terrain]
        terrain={TC2}
        [and]
            terrain=Hh
        [/and]
    [/terrain]
    [terrain]
        terrain={TC3}
        [and]
            terrain=Re
        [/and]
    [/terrain]
    [set_variable]
        name=smr
        rand=1..4
    [/set_variable]
    [switch]
        variable=smr
        [case]
            value=1
            [terrain_mask]
                mask="{~add-ons/Bad_Moon_Rising/maps/skirmishes/mask_1.mask}"
                x=1
                y=1
                [rule]
                    old=Aa^Fpa
                    new=Aa^Fpa
                    terrain=Ai
                    use_old=no
                [/rule]
                [rule]
                    old=Ha
                    new=Aa^Fpa
                    layer=overlay
                    use_old=no
                [/rule]
                [rule]
                    old=Ha
                    new=Ha
                    terrain=Ms
                    use_old=no
                [/rule]
            [/terrain_mask]
        [/case]
        [case]
            value=2
            [terrain_mask]
                mask="{~add-ons/Bad_Moon_Rising/maps/skirmishes/mask_2.mask}"
                x=1
                y=1
                [rule]
                    old=Aa^Fpa
                    new=Aa^Fpa
                    terrain=Ai
                    use_old=no
                [/rule]
                [rule]
                    old=Ha
                    new=Aa^Fpa
                    layer=overlay
                    use_old=no
                [/rule]
                [rule]
                    old=Ha
                    new=Ha
                    terrain=Ms
                    use_old=no
                [/rule]
            [/terrain_mask]
        [/case]
        [case]
            value=3
            [terrain_mask]
                mask="{~add-ons/Bad_Moon_Rising/maps/skirmishes/mask_3.mask}"
                x=1
                y=1
                [rule]
                    old=Aa^Fpa
                    new=Aa^Fpa
                    terrain=Ai
                    use_old=no
                [/rule]
                [rule]
                    old=Ha
                    new=Aa^Fpa
                    layer=overlay
                    use_old=no
                [/rule]
                [rule]
                    old=Ha
                    new=Ha
                    terrain=Ms
                    use_old=no
                [/rule]
            [/terrain_mask]
        [/case]
        [case]
            value=4
            [terrain_mask]
                mask="{~add-ons/Bad_Moon_Rising/maps/skirmishes/mask_4.mask}"
                x=1
                y=1
                [rule]
                    old=Aa^Fpa
                    new=Aa^Fpa
                    terrain=Ai
                    use_old=no
                [/rule]
                [rule]
                    old=Ha
                    new=Aa^Fpa
                    layer=overlay
                    use_old=no
                [/rule]
                [rule]
                    old=Ha
                    new=Ha
                    terrain=Ms
                    use_old=no
                [/rule]
            [/terrain_mask]
        [/case]
    [/switch]
    [terrain]
        terrain=Aa^Fyak
        [and]
            terrain=Ai
            [filter_adjacent_location]
                terrain=Aa
                count=6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
    [terrain]
        terrain=Aa
        [and]
            terrain=Rb
            [filter_adjacent_location]
                terrain=!,R*
                count=6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
    [terrain]
        terrain=Aa
        [and]
            terrain=Ha
            [filter_adjacent_location]
                terrain=!,Ha,Rb
                count=6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
    [terrain]
        terrain=Ha
        [and]
            terrain=Ai
            [filter_adjacent_location]
                terrain=Ha
                count=1-6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
    [terrain]
        terrain=Aa
        [and]
            terrain=Cha
            [filter_adjacent_location]
                terrain=Aa
                count=4,5,6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
    [terrain]
        terrain=Aa
        [and]
            terrain=Cha
            [filter_adjacent_location]
                terrain=!,Cha
                count=6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
    [terrain]
        terrain=Rb
        [and]
            terrain=Aa
            [filter_adjacent_location]
                terrain=R*
                count=2-4
            [/filter_adjacent_location]
        [/and]
    [/terrain]
#enddef

#define BMR_SK_MAP_SNOW
    {BMR_SKIRMISH_RANDOM_MASK_INTERNAL (Aa) (Aa^Fpa) (Ha)}
    [terrain]
        terrain=Aa
        [and]
            terrain=Aa^Fpa
            [filter_adjacent_location]
                terrain=Aa
                count=5,6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
#enddef
#define BMR_SK_MAP_HILLS
    {BMR_SKIRMISH_RANDOM_MASK_INTERNAL (Ha) (Aa) (Aa^Fpa)}
    [terrain]
        terrain=Ha
        [and]
            terrain=Aa^Fpa
            [filter_adjacent_location]
                terrain=Ha
                count=5,6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
#enddef
#define BMR_SK_MAP_WOODS
    {BMR_SKIRMISH_RANDOM_MASK_INTERNAL (Aa^Fpa) (Aa) (Ha)}
    [terrain]
        terrain=Aa^Fpa
        [and]
            terrain=Aa
            [filter_adjacent_location]
                terrain=Aa^Fpa
                count=5,6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
#enddef

#define BMR_SK_MAP_FOREST
    # elves
    {BMR_SKIRMISH_RANDOM_MASK_INTERNAL (Gll^Fp) (Gs) (Gll)}
    [terrain]
        terrain=Gs^Ve
        [and]
            terrain=*^Voa,*^Vha
        [/and]
    [/terrain]
    [terrain]
        terrain=Ket
        [and]
            terrain=Koa
        [/and]
    [/terrain]
    [terrain]
        terrain=Ce
        [and]
            terrain=Cha
        [/and]
    [/terrain]
    [terrain]
        terrain=Ss
        [and]
            terrain=Aa
        [/and]
    [/terrain]
    [terrain]
        terrain=Gll^Fpa
        [and]
            terrain=Gs
            [filter_adjacent_location]
                terrain=*^Fpa
                count=5,6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
#enddef
#define BMR_SK_MAP_ROAD
    {BMR_SKIRMISH_RANDOM_MASK_INTERNAL (Aa) (Ha) (Rb)}
    [terrain]
        terrain=Rp
        [and]
            terrain=Aa^Fpa
            [filter_adjacent_location]
                terrain=R*
                count=4,5,6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
#enddef

#define BMR_BATTLE_RANDOM_MASK
    # mask for battle random map, place in prestart
    [terrain_mask]
        mask="{~add-ons/Bad_Moon_Rising/maps/World_Battle.map}"
        x=1
        y=1
        [rule]
            old=Aa,Ha
            new=Aa^Fpa
            layer=overlay
            use_old=no
        [/rule]
        [rule]
            old=Re
            new=Ha
            use_old=no
        [/rule]
        [rule]
            old=Re
            new=Aa^Fpa
            terrain=Ai
            use_old=no
        [/rule]
        [rule]
            old=Ha
            new=Ha
            terrain=Ms
            use_old=no
        [/rule]
    [/terrain_mask]
    [terrain]
        terrain=Aa^Fyak
        [and]
            terrain=Re
            [filter_adjacent_location]
                terrain=Aa
                count=6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
    [terrain]
        terrain=Aa
        [and]
            terrain=Re
            [filter_adjacent_location]
                terrain=!,R*
                count=6
            [/filter_adjacent_location]
        [/and]
    [/terrain]
    [terrain]
        terrain=Rb
        [and]
            terrain=Aa
            [filter_adjacent_location]
                terrain=R*
                count=2-4
            [/filter_adjacent_location]
        [/and]
    [/terrain]
    [item]
        image=items/gohere.png
        x,y=7,1
    [/item]
    {SCATTER_IMAGE (terrain=Aa) 1 scenery/rock1-snow.png}
    {SCATTER_IMAGE (terrain=Aa) 1 scenery/rock2-snow.png}
    {SCATTER_IMAGE (terrain=Aa) 1 scenery/rock3-snow.png}
    {SCATTER_IMAGE (terrain=Aa) 1 scenery/rock4-snow.png}
    [event]
        name=moveto
        [filter]
            side=1
            canrecruit=yes
            x,y=7,1
        [/filter]
        [message]
            speaker=unit
            message=_"I think we can lose them in this pass..."
        [/message]
        {CLEAR_VARIABLE bmr_battle_unit_id} # so the enemy unit doesn't disappear from worldmap
        [set_variable]
            name=bmr_battle_did_flee
            value=yes
        [/set_variable]
        [endlevel]
            {CONTINUE_NO_SAVE}
        [/endlevel]
    [/event]
#enddef

#define BMR_DID_FLEE_BATTLE ID1
    # this is so the player can get away from the unit on the worldmap that they just fled from

    [event]
        name=side 2 turn refresh
        # we only want this to trigger the first turn on the worldmap, so no first_time_only=no
        [if]
            [have_unit]
                side=2
                [and]
                    [filter_adjacent]
                        id={ID1}
                    [/filter_adjacent]
                [/and]
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        side=2
                        [and]
                            [filter_adjacent]
                                id={ID1}
                            [/filter_adjacent]
                        [/and]
                    [/filter]
                    variable=bmr_fled_from
                    kill=no
                [/store_unit]
                [set_variable]
                    name=bmr_fled_from.moves
                    value=0
                [/set_variable]
                [unstore_unit]
                    variable=bmr_fled_from
                    find_vacant=no
                [/unstore_unit]
                {CLEAR_VARIABLE bmr_fled_from}
            [/then]
        [/if]
    [/event]

#ifdef __UNUSED__
    [event]
        name=start
        [store_unit]
            [filter]
                side=2
                [and]
                    [filter_adjacent]
                        id={ID1}
                    [/filter_adjacent]
                [/and]
            [/filter]
            variable=bmr_fled_from
            kill=no
        [/store_unit]
    [/event]

    [event]
        name=enter_hex # this is an odd workaround for the thing that restores enemy moves
        [filter]
            id=$bmr_fled_from.id
        [/filter]
        # does this suppress the errors about retrieving non-existant variable bmr_fled_from.id? <-No, try changing this whole thing to a turn refresh event
        [filter_condition]
            [have_unit]
                id=$bmr_fled_from.id
            [/have_unit]
        [/filter_condition]
        {MODIFY_UNIT (id=$bmr_fled_from.id) moves 3}
        [end_turn]
        [/end_turn]
        {CLEAR_VARIABLE bmr_fled_from}
    [/event]
#endif

#enddef

#define BMR_HERO_DEATHS
    [event]
        name=last breath
        [filter]
            id=Lorenzon
        [/filter]
        [message]
            speaker=unit
            message= _ "What a dumb way to die..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Belleros
        [/filter]
        [message]
            speaker=unit
            message= _ "Oof..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Raenna
        [/filter]
        [message]
            speaker=unit
            message= _ "Ack..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Carghanna
        [/filter]
        [message]
            speaker=unit
            message= _ "Ouch..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Duval
        [/filter]
        [message]
            speaker=unit
            message= _ "Ouch..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Grat Gareth
        [/filter]
        [message]
            speaker=unit
            message= _ "Ouch..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Hrala Gareth
        [/filter]
        [message]
            speaker=unit
            message= _ "Ouch..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
#enddef

# This is very specific, not part of the general skirmish macros.  But it is part of skirmishes

#define BMR_CARUSOE_I

    [if]
        [have_location]
            x,y=12,8
            terrain=Ql
        [/have_location]
        [and]
            [variable]
                name=carusoe_sk
                numerical_equals=1
            [/variable]
        [/and]
        [then]
            [set_variable]
                name=carusoe_sk
                value=0
            [/set_variable]
            [unit]
                side=2
                type=Northern Ranger
                profile=portraits/carusoe.png
                id=Carusoe
                name=Carusoe
                x,y=20,7
                random_traits=yes
                facing=sw
            [/unit]
            {MOVE_UNIT id=Carusoe 16 2}
            [message]
                speaker=Carusoe
                message = _ "You've come back! Why?"
            [/message]
            [message]
                speaker=Raenna
                message = _ "To hunt you down and kill you!"
            [/message]
            [message]
                speaker=Carusoe
                message = _ "..."
            [/message]
            {MOVE_UNIT id=Carusoe 20 15}
            [kill]
                id=Carusoe
            [/kill]
        [/then]
    [/if]

    [if]
        [have_location]
            x,y=12,13
            terrain=Cea
        [/have_location]
        [and]
            [variable]
                name=carusoe_sk
                numerical_equals=1
            [/variable]
        [/and]
        [then]
            [set_variable]
                name=carusoe_sk
                value=0
            [/set_variable]
            [unit]
                side=2
                type=Northern Ranger
                id=Carusoe
                profile=portraits/carusoe.png
                name=Carusoe
                x,y=12,20
                random_traits=yes
                facing=ne
            [/unit]
            {MOVE_UNIT id=Carusoe 14 15}
            [message]
                speaker=Carusoe
                message = _ "You've come back! Why?"
            [/message]
            [message]
                speaker=Raenna
                message = _ "To hunt you down and kill you!"
            [/message]
            [message]
                speaker=Carusoe
                message = _ "..."
            [/message]
            {MOVE_UNIT id=Carusoe 4 20}
            [kill]
                id=Carusoe
            [/kill]
        [/then]
    [/if]

    [if]
        # what map is this for, is this obsolete?
        [have_location]
            x,y=13,6
            terrain=Coa
        [/have_location]
        [and]
            [variable]
                name=carusoe_sk
                numerical_equals=1
            [/variable]
        [/and]
        [then]
            [set_variable]
                name=carusoe_sk
                value=0
            [/set_variable]
            [unit]
                side=2
                type=Northern Ranger
                profile=portraits/carusoe.png
                id=Carusoe
                name=Carusoe
                x,y=1,12
                random_traits=yes
                facing=se
            [/unit]
            {MOVE_UNIT id=Carusoe 3 16}
            [message]
                speaker=Carusoe
                message = _ "You've come back! Why?"
            [/message]
            [message]
                speaker=Raenna
                message = _ "To hunt you down and kill you!"
            [/message]
            [message]
                speaker=Carusoe
                message = _ "..."
            [/message]
            {MOVE_UNIT id=Carusoe 1 20}
            [kill]
                id=Carusoe
            [/kill]
        [/then]
    [/if]

#enddef

# These are macros for the random skirmishes, used in the scenarios#/SkirmishCalls#.cfg

# this may no longer be needed
#define BMR_RECALL_STRENGTH
    # stores and counts the number of level 2 and 3 units on recall list
    # 2010-12-10: no longer recall list.
    # a separate macro so it can used with Astreya.
    # sets variable 'recallstrength'
    [store_unit]
        [filter]
            side=1
            #		x,y=recall,recall
            [filter_wml]
                [variables]
                    on_call=yes
                [/variables]
            [/filter_wml]
        [/filter]
        variable=recall_list_temp
        kill=no
    [/store_unit]
    [set_variable]
        name=index_temp
        value=0
    [/set_variable]
    # make this 1 instead of zero?
    [set_variable]
        name=recallstrength
        value=1
    [/set_variable]
    [while]
        [variable]
            name=index_temp
            less_than=$recall_list_temp.length
        [/variable]
        [do]
            [set_variable]
                name=recall_strength_temp
                value=$recall_list_temp[$index_temp].level
            [/set_variable]
            # we add one for level 2 opponent, two for level 3.
            [set_variable]
                name=recall_strength_temp
                add=-1
            [/set_variable]
            [if]
                [variable]
                    name=recall_strength_temp
                    less_than=0
                [/variable]
                [then]
                    [set_variable]
                        name=recall_strength_temp
                        value=0
                    [/set_variable]
                [/then]
            [/if]
            [set_variable]
                name=recallstrength
                add=$recall_strength_temp
            [/set_variable]
            [set_variable]
                name=index_temp
                add=1
            [/set_variable]
        [/do]
    [/while]
    # this was ramping too fast, adjust the scenarios harder, not the skirmishes
    [set_variable]
        name=recallstrength
        multiply=0.8
    [/set_variable]
    [set_variable]
        name=recallstrength
        ipart=$recallstrength
    [/set_variable]
    # OK, so we know this is working
    #	[set_variable]
    #	    name=recallstrength_testing
    #	    value=$recallstrength
    #	[/set_variable]
    {CLEAR_VARIABLE recall_list_temp}
    {CLEAR_VARIABLE recall_strength_temp}
    {CLEAR_VARIABLE index_temp}
    # so recallstrength is not negative
    [if]
        [variable]
            name=recallstrength
            less_than=0
        [/variable]
        [then]
            [set_variable]
                name=recallstrength
                value=0
            [/set_variable]
        [/then]
    [/if]
#enddef

#define BMR_SKIRMISH_FOES NUMBER INDEX
    # 11-5-2023 - this has gotten too complicated.  Move gear to a more general place, so it is in all scenarios
    # 11-19-2012: overhauling this...  Just orcs and despair done for now.
    # 1-2-2013: added primevals
    # 1-12-2013:added wolves
    # macro to set up the skirmish foes
    # has entries for orcs, humans, primeval, khthon (though not useful ATM)
    #	should probably add undead at some point
    # NUMBER is number of foes
    # INDEX is a number used to choose specific unit groups
    # 2010-11-29: There is an error in here, I think.  Strange things happen with the BMR_RECALL_STRENGTH macro and the [generator] tag causes a bogus error

    [event]
        name=prestart
        [set_variable]
            name=sk_overide
            rand=1..3
            # value=1
        [/set_variable]
        [if]
            [variable]
                name=sk_overide # overide the unit type, replace with wolves
                equals=1
            [/variable]
            [then]
                [store_unit]
                    [filter]
                        id=Leader
                    [/filter]
                    kill=no
                    variable=leaderkind
                [/store_unit]
                [switch]
                    variable=leaderkind.level
                    [case]
                        value=1
                        {TRANSFORM_UNIT (id=Leader) "Grey Wolf"}
                    [/case]
                    [case]
                        value=2
                        {TRANSFORM_UNIT (id=Leader) "Black Wolf"}
                    [/case]
                    [else]
                        {TRANSFORM_UNIT (id=Leader) "Night Wolf"}
                    [/else]
                [/switch]
                {MODIFY_UNIT (id=Leader) name "Pack Leader"}
                # to remove the "despair fog"
                [modify_side]
                    side=1
                    fog=no
                [/modify_side]
                {CLEAR_VARIABLE leaderkind}
            [/then]
        [/if]
        [set_variable]
            name=skindex
            value={INDEX}
        [/set_variable]
        [set_variable]
            name=sk_howmany
            rand=4..{NUMBER}
        [/set_variable]
        [store_unit]
            [filter]
                id=Leader
            [/filter]
            kill=no
            variable=leaderkind
        [/store_unit]
        [switch]
            variable=leaderkind.race
            [case]
                value="snow_wolf"
                [switch]
                    variable=skindex
                    [case]
                        value=0,1,2
                        {SCATTER_UNITS $sk_howmany ({BMR_SK_WOLF0}) 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=3,4
                        {SCATTER_UNITS $sk_howmany ({BMR_SK_WOLF0},{BMR_SK_WOLF1}) 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=5,6
                        {SCATTER_UNITS $sk_howmany ({BMR_SK_WOLF0},{BMR_SK_WOLF1},{BMR_SK_WOLF2}) 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=7,8
                        {SCATTER_UNITS $sk_howmany ({BMR_SK_WOLF0},{BMR_SK_WOLF1},{BMR_SK_WOLF2},{BMR_SK_WOLF3}) 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=9,10
                        {SCATTER_UNITS $sk_howmany ({BMR_SK_WOLF1},{BMR_SK_WOLF2},{BMR_SK_WOLF2},{BMR_SK_WOLF3}) 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=11,12
                        {SCATTER_UNITS $sk_howmany ({BMR_SK_WOLF1},{BMR_SK_WOLF2},{BMR_SK_WOLF3},{BMR_SK_WOLF3}) 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [else]
                        {SCATTER_UNITS $sk_howmany "Yeti" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/else]
                [/switch]
            [/case]
            [case]
                value="orc"
                [switch]
                    variable=skindex
                    [case]
                        value=0,1
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS0}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=2
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS0},{BMR_SK_ORCS0},{BMR_SK_ORCS1}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=3
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS0},{BMR_SK_ORCS1}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=4
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS0},{BMR_SK_ORCS1},{BMR_SK_ORCS1}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=5
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS0},{BMR_SK_ORCS1},{BMR_SK_ORCS2}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=6
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS0},{BMR_SK_ORCS1},{BMR_SK_ORCS2b},{BMR_SK_ORCS1},{BMR_SK_ORCS2}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=7
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS0},{BMR_SK_ORCS1},{BMR_SK_ORCS2b},{BMR_SK_ORCS3}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=8
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS2},{BMR_SK_ORCS1},{BMR_SK_ORCS2b},{BMR_SK_ORCS3b}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=9
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS1},{BMR_SK_ORCS2b},{BMR_SK_ORCS3},{BMR_SK_ORCS3b}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=10
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS1},{BMR_SK_ORCS3},{BMR_SK_ORCS2b},{BMR_SK_ORCS3b},{BMR_SK_ORCS4}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=11
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS1},{BMR_SK_ORCS2b},{BMR_SK_ORCS3},{BMR_SK_ORCS3b},{BMR_SK_ORCS3b},{BMR_SK_ORCS4}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=12
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ORCS1},{BMR_SK_ORCS2b},{BMR_SK_ORCS3b},{BMR_SK_ORCS5},{BMR_SK_ORCS4},{BMR_SK_ORCS4}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [else]
                        {SCATTER_UNITS $sk_howmany "Yeti" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/else]
                [/switch]
            [/case]
            [case]
                value="despair"
                [switch]
                    variable=skindex
                    [case]
                        value=0,1,2
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_DESP0}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=3,4
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_DESP0},{BMR_SK_DESP1}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=5,6
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_DESP0},{BMR_SK_DESP1},{BMR_SK_DESP2}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=7,8
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_DESP0},{BMR_SK_DESP1},{BMR_SK_DESP2},{BMR_SK_DESP3}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=9,10
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_DESP1},{BMR_SK_DESP2},{BMR_SK_DESP2},{BMR_SK_DESP3}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=11,12
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_DESP1},{BMR_SK_DESP2},{BMR_SK_DESP3},{BMR_SK_DESP4}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [else]
                        {SCATTER_UNITS $sk_howmany "Yeti" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/else]
                [/switch]
            [/case]
            [case]
                value="elf"
                [switch]
                    variable=skindex
                    [case]
                        value=0,1,2
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ELF0}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=3,4
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ELF0},{BMR_SK_ELF1}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=5,6
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ELF0},{BMR_SK_ELF1},{BMR_SK_ELF2}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=7,8
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ELF1},{BMR_SK_ELF1},{BMR_SK_ELF2},{BMR_SK_ELF3}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=9,10
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ELF1},{BMR_SK_ELF2},{BMR_SK_ELF3},{BMR_SK_ELF4}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=11,12
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_ELF5},{BMR_SK_ELF2},{BMR_SK_ELF3},{BMR_SK_ELF4}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [else]
                        {SCATTER_UNITS $sk_howmany "Yeti" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/else]
                [/switch]
            [/case]
            [case]
                value="primeval"
                [switch]
                    variable=skindex
                    [case]
                        value=0,1,2
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_PRIM0}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=3,4
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_PRIM0},{BMR_SK_PRIM1}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=5,6
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_PRIM0},{BMR_SK_PRIM1},{BMR_SK_PRIM2}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=7,8
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_PRIM0},{BMR_SK_PRIM1},{BMR_SK_PRIM2},{BMR_SK_PRIM3}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=9,10
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_PRIM1},{BMR_SK_PRIM2},{BMR_SK_PRIM2},{BMR_SK_PRIM3}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [case]
                        value=11,12
                        {SCATTER_UNITS $sk_howmany "{BMR_SK_PRIM1},{BMR_SK_PRIM2},{BMR_SK_PRIM3},{BMR_SK_PRIM3}" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/case]
                    [else]
                        {SCATTER_UNITS $sk_howmany "Yeti" 2 (
                            x=6-25
                            y=6-25
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        ) (
                            side=2
                        )}
                    [/else]
                [/switch]
            [/case]
        [/switch]
        #    [/event]

        # buff up the enemy as the player's recall list is stronger
        # 2010-12-10: make the strength depend upon the on-call units only
        # 2023-11-22: this was causing a long delay, even without advancement animations
        # the new total_xp toplevel feature should make this less needed
#ifdef __UNUSED__
        {BMR_RECALL_STRENGTH}
        # 2010-11-29: commenting ^that^ out does not cause the [generator] error to go away.
        # I've removed the generator, so no more [generator] error
        [store_unit]
            [filter]
                side=2
                canrecruit=no
            [/filter]
            kill=yes
            variable=tobuff
        [/store_unit]
        [set_variable]
            name=index_temp
            value=0
        [/set_variable]
        [while]
            [variable]
                name=index_temp
                less_than=$tobuff.length
            [/variable]
            [do]
                # 2015-5-30 - reducing experience multiplier from 10 to 8, then will give enemies some random gear
                # this is pure nonsense needed to get around the destruction of recallstrength
                # at least it works now...
                # 2010-11-29 v1.1.9 (BfW 1.9.2) - It may have worked at once point, but now it doesn't.  Enemies get random negative experience...
                # I wonder if this has something to do with the error about [generator] not being supported at the top level ...
                # I think I've fixed this...
                #                [set_variable]
                #                    name=rs_temp
                #                    value=$recallstrength
                #                [/set_variable]

                [if]
                    [variable]
                        name=recallstrength
                        less_than=1
                    [/variable]
                    ## just unstore the enemy unit
                    [then]
                        [unstore_unit]
                            variable=tobuff[$index_temp]
                            find_vacant=no
                        [/unstore_unit]
                    [/then]
                    [else]
                        [set_variable]
                            name=recallstrength_exp
                            value=$recallstrength
                        [/set_variable]
                        [set_variable]
                            name=recallstrength_exp
                            multiply=8
                        [/set_variable]
                        [set_variable]
                            name=tobuff[$index_temp].experience
                            value=$recallstrength_exp
                        [/set_variable]
                        [unstore_unit]
                            variable=tobuff[$index_temp]
                            find_vacant=no
                            advance=true # doesn't work for AMLA?
                            animate=no # hidden animations were causing a bad delay
                        [/unstore_unit]
                    [/else]
                [/if]
                # restoring recallstrength...
                #                [set_variable]
                #                    name=recallstrength
                #                    value=$rs_temp
                #                [/set_variable]
                [set_variable]
                    name=recallstrength
                    add=-2
                [/set_variable]
                [set_variable]
                    name=index_temp
                    add=1
                [/set_variable]
            [/do]
        [/while]
#endif

        #			    {CLEAR_VARIABLE recallstrength_exp}

        #        {CLEAR_VARIABLE foes1}
        #        {CLEAR_VARIABLE foes2}
        #        {CLEAR_VARIABLE foes3}
        #        {CLEAR_VARIABLE foetype1}
        #        {CLEAR_VARIABLE foetype2}
        #        {CLEAR_VARIABLE foetype3}
        {CLEAR_VARIABLE skindex}
        {CLEAR_VARIABLE sk_howmany}
        {CLEAR_VARIABLE leaderkind}
        #	{CLEAR_VARIABLE recallstrength}
        {CLEAR_VARIABLE index_temp}
        #        {CLEAR_VARIABLE rs_temp}
        {CLEAR_VARIABLE tobuff}
    [/event]

#enddef
# ^ this is the closing of BMR_SKIRMISH_FOES

#define BMR_SK_GRADING

    # a temporary solution <- what?  What's going on here?
    # 20140607 - adding a bmr_map_stage variable, defined in worldmap scenario prestarts, so later levels are more difficult
    [event]
        name=prestart
        [set_variable]
            name=sknumber
            rand=0..$timesfought|
        [/set_variable]
        [set_variable]
            name=sknumber
            add=$bmr_map_stage|
        [/set_variable]
        [set_variable]
            name=sknumber
            add=3
        [/set_variable]
        [if]
            [variable]
                name=sknumber
                greater_than=18
            [/variable]
            [then]
                [set_variable]
                    name=sknumber
                    value=18
                [/set_variable]
            [/then]
        [/if]
        [set_variable]
            name=skindex0
            rand=-1..1
        [/set_variable]
        [set_variable]
            name=skindex0
            add=$timesfought
        [/set_variable]
        [if]
            [variable]
                name=skindex0
                less_than=0
            [/variable]
            [then]
                [set_variable]
                    name=skindex0
                    value=0
                [/set_variable]
            [/then]
        [/if]
        [if]
            [variable]
                name=skindex0
                greater_than=11
            [/variable]
            [then]
                [set_variable]
                    name=skindex0
                    value=11
                [/set_variable]
            [/then]
        [/if]
    [/event]

    {BMR_SKIRMISH_FOES $sknumber $skindex0}

#enddef

# 11-19-2012: prize system needs overhaul, so mostly disabling it for now.
# I'll just make the enemies drop gold, occasionally, in a die event
#define BMR_SK_VICTORY
    # So that the skirmishes can serve a purpose, aside from experience
    # And restoring the purse

    [event]
        name=die
        first_time_only=no
        [filter]
            side=2
            [not]
                [filter_wml]
                    [variables]
                        [gear]
                        [/gear]
                    [/variables]
                [/filter_wml]
            [/not]
        [/filter]
        [if]
            [have_unit]
                side=2
                [not] # not sure this is needed
                    id=$unit.id
                [/not]
            [/have_unit]
            [then]
                [set_variable]
                    name=sk_gold_drop
                    #		rand=1..4
                    rand=1..2 # for testing
                [/set_variable]
                [if]
                    [variable]
                        name=sk_gold_drop
                        equals=2
                    [/variable]
                    [then]
                        [item]
                            image=items/gold-coins-small.png
                            x,y=$x1,$y1
                        [/item]
                        [event]
                            name=moveto
                            delayed_variable_substitution=no
                            [filter]
                                x,y=$x1,$y1
                                side=1
                            [/filter]
                            [remove_item]
                                image=items/gold-coins-small.png
                                x,y=$x1,$y1
                            [/remove_item]
                            [gold]
                                amount=$unit.cost|
                                side=1
                            [/gold]
                            [floating_text]
                                x,y=$x1,$y1
                                text="<span color='#CCCC33'>"+"$unit.cost| g"+"</span>"
                            [/floating_text]
                            #                            [message]
                            #                                speaker=narrator
                            #                                message=_"Found $unit.cost| g."
                            #                                image=icons/coins_copper.png
                            #                            [/message]
                        [/event]
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            side=2
        [/filter]
        [if]
            [have_unit]
                side=2
            [/have_unit]
            [else]
                [endlevel]
                    #		result=victory
                    {CONTINUE}
                    replay_save=no
                [/endlevel]
            [/else]
        [/if]
    [/event]

    # in case the die event above did not fire
    [event]
        name=new turn
        first_time_only=no
        [if]
            [have_unit]
                side=2
            [/have_unit]
            [else]
                [endlevel]
                    #		result=victory
                    {CONTINUE}
                    replay_save=no
                [/endlevel]
            [/else]
        [/if]
    [/event]

#enddef

#define BMR_ENEMY_FLEE FACTOR
    # if FAI is working, this will tell the enemy it is time to flee (UPDATE 20140518 - now using MicroAI instead of FAI)
    # it will be used in the skirmish creating scenarios, so that it doesn't get
    # placed in Astreya's scenarios
    # this needs to be re-thought...  Need a better calculation of side strengths
    # 20240128 - needs thought especially with 'hardened' grading
    [event]
        name=new turn
        first_time_only=no
        [store_unit]
            [filter]
                side=1
                [not]
                    x,y=recall,recall
                [/not]
            [/filter]
            variable=units_side1
            kill=no
        [/store_unit]
        [store_unit]
            [filter]
                side=2
            [/filter]
            variable=units_side2
            kill=no
        [/store_unit]
        [set_variable]
            name=index_side1
            value=0
        [/set_variable]
        [set_variable]
            name=strength_side1
            value=0
        [/set_variable]
        [while]
            [variable]
                name=index_side1
                less_than=$units_side1.length
            [/variable]
            [do]
                [set_variable]
                    name=strength_side1
                    add=$units_side1[$index_side1].level
                [/set_variable]
                [set_variable]
                    name=index_side1
                    add=1
                [/set_variable]
            [/do]
        [/while]
        [set_variable]
            name=index_side2
            value=0
        [/set_variable]
        [set_variable]
            name=strength_side2
            value=0
        [/set_variable]
        [while]
            [variable]
                name=index_side2
                less_than=$units_side2.length
            [/variable]
            [do]
                [set_variable]
                    name=strength_side2
                    add=$units_side2[$index_side2].level
                [/set_variable]
                [set_variable]
                    name=index_side2
                    add=1
                [/set_variable]
            [/do]
        [/while]
        # inserting this to get enemies to flee less for now.  A better solution is to have stronger enemies, but that cannot be done overnight
        # another idea is to have this kick in only for the first turn, so the enemy attacks on the first turn, unless the player is much stronger, but then runs if things look grim.
        # 20240128 - ... or store the Leader, and use that 'hardened' value to scale this
        [set_variable]
            name=strength_side2
            multiply=1.5
        [/set_variable]
        # swapping strength_side1 and strength_side2, the enemy was always running away
        [set_variable]
            #            name=strength_side1
            name=strength_side2
            # this could be adjusted for difficulty...
            multiply={FACTOR}
        [/set_variable]
        [if]
            [variable]
                name=strength_side2
                less_than=$strength_side1
            [/variable]
            [then]
                [set_variable]
                    name=should_run
                    value=1
                [/set_variable]
                [set_variable]
                    name=ai_set
                    value=no
                [/set_variable]
            [/then]
        [/if]
        {CLEAR_VARIABLE units_side1}
        {CLEAR_VARIABLE strength_side1}
        {CLEAR_VARIABLE units_side2}
        {CLEAR_VARIABLE strength_side2}
        {CLEAR_VARIABLE index_side1}
        {CLEAR_VARIABLE index_side2}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=2
            x=1,2-29,2-29,30
            y=1-30,1,30,1-30
            #		x=1-2
        [/filter]
        [kill]
            x,y=$x1,$y1
        [/kill]
        [floating_text]
            x,y=$x1,$y1
            text="<span color='#FFFFFF'>"+_"Ran Away!"+"</span>"
        [/floating_text]
        # Where is this defined?  This might be a bug...  What was supposed to happen?
        [fire_event]
            name=bmr_sk_victory
        [/fire_event]
    [/event]

    # FAI related stuff
    # 20140518 - now using MicroAI, not FAI, since FAI is no longer maintained

    [event]
        name=ai turn
        first_time_only=no
        [if]
            [variable]
                name=side_number
                numerical_equals=2
            [/variable]
            [and]
                [variable]
                    name=ai_set
                    equals=no
                [/variable]
            [/and]
            [then]
                [set_variable]
                    name=ai_set
                    value=yes
                [/set_variable]
                [if]
                    [variable]
                        name=should_run
                        numerical_equals=1
                    [/variable]
                    [then]
                        #                        [fire_event]
                        #                            name=ai_retreat_start
                        #                        [/fire_event]
                        [micro_ai]
                            side=2
                            action=add
                            ai_type=goto
                            [filter_location]
                                x=1,2-29,2-29,30
                                y=1-30,1,30,1-30
                            [/filter_location]
                            avoid_enemies=1
                            ca_id=retreat_start
                            # default is probably fine		    ca_score=
                        [/micro_ai]
                    [/then]
                    [else]
                        #                        [fire_event]
                        #                            name=ai_retreat_stop
                        #                        [/fire_event]
                        [micro_ai]
                            side=2
                            action=delete
                            ca_id=retreat_start
                            ai_type=goto
                        [/micro_ai]
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    # so wounded units try to run away
    [event]
        name=attack_end
        first_time_only=no
        [filter]
            side=2
        [/filter]
        [filter_condition]
            [variable]
                name=unit.hitpoints
                less_than=13
            [/variable]
        [/filter_condition]
        [micro_ai]
            side=2
            action=add
            ai_type=goto
            [filter_location]
                x=1,2-29,2-29,30
                y=1-30,1,30,1-30
            [/filter_location]
            avoid_enemies=1
            ca_id=unit_retreat_start
            [filter]
                id=$unit.id
            [/filter]
        [/micro_ai]
    [/event]
    [event]
        name=attack_end
        first_time_only=no
        [filter_second]
            side=2
        [/filter_second]
        [filter_condition]
            [variable]
                name=second_unit.hitpoints
                less_than=13
            [/variable]
        [/filter_condition]
        [micro_ai]
            side=2
            action=add
            ai_type=goto
            [filter_location]
                x=1,2-29,2-29,30
                y=1-30,1,30,1-30
            [/filter_location]
            avoid_enemies=1
            ca_id=unit_retreat_start
            [filter]
                id=$second_unit.id
            [/filter]
        [/micro_ai]
    [/event]
    # for if the unit is poisoned, or something like that.
    # need to think about how to filter this...
    [event]
        name=foooby
        #        name=side 2 turn
        first_time_only=no
        [store_unit]
            [filter]
                side=2
            [/filter]
            variable=wounded_unit
            kill=no
        [/store_unit]
        {FOREACH wounded_unit wu_i}
            [if]
                [variable]
                    name=wounded_unit[$wu_i].hitpoints
                    less_than=13
                [/variable]
                [then]
                    [micro_ai]
                        side=2
                        action=add
                        ai_type=goto
                        [filter_location]
                            x=1,2-29,2-29,30
                            y=1-30,1,30,1-30
                        [/filter_location]
                        avoid_enemies=1
                        ca_id=unit_retreat_start
                        [filter]
                            id=$wounded_unit[$wu_i].id
                        [/filter]
                    [/micro_ai]
                [/then]
            [/if]
        {NEXT wu_i}
        {CLEAR_VARIABLE wounded_unit}
        {CLEAR_VARIABLE wu_i}
    [/event]

    # 20140518 - this can probably be removed, once I'm sure MicroAI is working as intended
    [event]
        # taken from Crab's post on the Coder's Corner forum, with some very small changes
        name=ai_retreat_start
        # 'main_loop' is the id of the stage from data/ai/ais/testing_ai_default.cfg
        {MODIFY_AI_ADD_CANDIDATE_ACTION 2 main_loop (
            [candidate_action]
                #   this is the ID we refer when deleting this candidate action in the ai_retreat_stop event
                id=retreat_to_map_edge
                #    this is fai-specific stuff - a name of the action. just set it to same thing as id
                name=retreat_to_map_edge
                #   we use fai to parse this config block
                engine=fai
                #  this is fai-specific stuff - a type of the action. in this case,  this is a movement candidate action. all units which still can move, are considered
                type=movement
                #   Just a bit less-priority thing than combat. Use {AI_CA_GOTO_SCORE}+10  to make the retreat happen even before gotos are considered.
                #   this is "WHEN". the action is considered for execution if we return priority >0, highest-priority action is taken
                #   the intent of the formula is "if we can make a move closer to location, return good score, else return 0"
                evaluation="if(next_hop(me.loc,loc(1,me.loc.y))=null,0,if(unit_at(next_hop(me.loc,loc(1,me.loc.y)))=null, {AI_CA_COMBAT_SCORE}+10,0))"
                #   the above line is working around a bug, which'll be fixed in 1.7.12, after that the line below will work, too
                #   evaluation="if(unit_at(next_hop(me.loc,loc(1,1)))=null, {AI_CA_COMBAT_SCORE}-10 ,0)"
                #   this is "WHAT TO DO"
                action="move(me.loc,next_hop(me.loc,loc(1,me.loc.y)))"
            [/candidate_action]
        )}
    [/event]

    [event]
        name=ai_retreat_stop
        #    we reference the id of the above candidate action, which is part of 'main_loop' stage of the ai.
        {MODIFY_AI_DELETE_CANDIDATE_ACTION 2 main_loop retreat_to_map_edge}
    [/event]

#enddef

# 20140706 this gets called in the scenarios2/SkirmishCalls_II.cfg etc. as part of the MAP_WML argument in BMR_SKIRMISH_START (defined below)
# it is a separate macro, because I don't want it to define the ghost/road skirmishes schedules.
#define BMR_SK_TOD
    # make the time of day be the same as the world map
    # insert_tag not supported at scenario top level.  And I'm not sure, at the moment, how to make an array within an array for replace_schedule.time.blah, so we'll just do this piece by piece
    # nope, that dos not work.  Need to use replace_schedule
    [event]
        name=prestart
        [insert_tag]
            name=replace_schedule
            variable=bmr_sk_tod
        [/insert_tag]
    [/event]
#enddef

#define BMR_SKIRMISH_START SKID PLAYERID FOETYPE NEXT_ MAP_WML ACTION_WML
    # this establishes the start of a skirmish scenario, the player and foe sides, and the next scenario
    # MAP_WML would the generator and schedules macros
    # ACTION_WML would be the talking and enemy generation
    # 2010-12-04: I have removed the random map generator.  It was largely undocumented and it seemed the way I was using it was no longer supported, so screw it.
    ###################check this########################
    #[scenario]
    #    name= _ "Skirmish"
    #    id={SKID}
    # was this a typo?
    #    map_generation=default
    # HttT uses this V
    #    scenario_generation=default
    #    next_scenario={NEXT_}
    #    victory_when_enemies_defeated=no
    #[generator]
    # I had tried to make it like HttT scenario, but that does not work
    [scenario]
        name= _ "Skirmish"
        id={SKID}
        #        map_data="{~add-ons/Bad_Moon_Rising/maps/skirmishes/snow1.map}"
        {BMR_SKIRMISH_RANDOM_MAP}
        next_scenario={NEXT_}
        victory_when_enemies_defeated=no
        {TURNS 22 20 18}
        [music]
            name=northerners-classic.ogg
        [/music]
        [music]
            name=battle.ogg
            append=yes
        [/music]

        {MAP_WML}

        {BMR_INIT_LUA}
        [event]
            name=prestart
            [objectives]
                side=1
                [objective]
                    condition=win
                    description=_ "Defeat all enemy units"
                [/objective]
                [objective]
                    condition=lose
                    description=_ "Death of Heroes"
                [/objective]

                {TURNS_RUN_OUT}
            [/objectives]
            [set_variable]
                name=bmr_sk_ambushed
                rand=1..4
            [/set_variable]
        [/event]

        [side]
            #            type=Lieutenant
            type=Ukian Officer
            id={PLAYERID}
            name=  "Belleros"
            side=1
            canrecruit=yes
            controller=human
            fog=no
            recruit=
            {GOLD 60 60 60}
            save_id=Lorenzon
        [/side]

        [side]
            no_leader=yes
            side=2
            # 2010-12-29: making the leader just a unit, no recruiting, because of a possible bug
            #	canrecruit=yes
            fog=no
            {ai/aliases/stable_singleplayer.cfg}
            # I've completely commented out the [ai] block, was that causing trouble?
            # I may allow them to recruit, need to think about this...
            #	recruit=
            #	{GOLD 200 250 300}
            #	{INCOME 4 6 8}
            #	ai_algorithm=formula_ai

            #	[ai]

            #            version=10703
            #            [stage]
            #                engine=fai
            #                name=unit_formulas
            #            [/stage]

            #	aggression=0.3
            #	grouping=offesnive
            #	protect_leader=3.0
            #	protect_leader_radius=5
            #	[/ai]
            [unit]
                #                type=Orcish Warrior
                type={FOETYPE}
                id=Leader
                name=_ "Enemy Leader"
                x,y=10,10
                random_traits=yes
            [/unit]
        [/side]

        # 20160625 FLAG: this is temporary, to give Ukian Witches in ongoing games the new advancements
        # does not work for recall list...
        ####################
        #        [event]
        #	    name=select
        #	    first_time_only=no
        #	    [filter]
        #		type=Ukian Witch
        #	    [/filter]
        #        [filter_condition]
        #            [not]
        #                [variable]
        #                    name=$unit.variation
        #                    equals=green
        #                [/variable]
        #                [or]
        #                    [variable]
        #                        name=$unit.variation
        #                        equals=black
        #                    [/variable]
        #                [/or]
        #            [/not]
        #        [/filter_condition]
        #	    [transform_unit]
        #		id=$unit.id
        #		transform_to=Ukian Witch
        #	    [/transform_unit]
        #	[/event]
        ######################

        [event]
            name=side 1 turn 1
            [if]
                [variable]
                    name=bmr_sk_ambushed
                    equals=1
                [/variable]
                [then]
                    [print]
                        text=_"Ambushed!"
                        size=36
                        duration=50
                        red,green,blue=250,10,10
                    [/print]
                    [end_turn]
                    [/end_turn]
                [/then]
                [else]
                    [if]
                        [variable]
                            name=skip_skirmishes
                            equals=yes
                        [/variable]
                        [then]
                            [message]
                                speaker={PLAYERID}
                                message= _ "We don't have time for this, everyone scatter!"
                            [/message]
                            [store_unit]
                                [filter]
                                    side=1
                                    [not]
                                        x,y=recall,recall
                                    [/not]
                                [/filter]
                                variable=units_side1_TEMP
                                kill=no
                            [/store_unit]
                            [set_variable]
                                name=index_side1
                                value=0
                            [/set_variable]
                            [while]
                                [variable]
                                    name=index_side1
                                    less_than=$units_side1_TEMP.length
                                [/variable]
                                [do]
                                    [if]
                                        [variable]
                                            name=units_side1_TEMP[$index_side1].experience
                                            greater_than=0
                                        [/variable]
                                        [then]
                                            [set_variable]
                                                name=units_side1_TEMP[$index_side1].experience
                                                add=-1
                                            [/set_variable]
                                        [/then]
                                    [/if]
                                    [unstore_unit]
                                        variable=units_side1_TEMP[$index_side1]
                                        find_vacant=no
                                    [/unstore_unit]
                                    [wml_message]
                                        message="Experience is now $units_side1_TEMP[$index_side1].experience|"
                                        logger=warning
                                    [/wml_message]
                                    [set_variable]
                                        name=index_side1
                                        add=1
                                    [/set_variable]
                                [/do]
                            [/while]
                            {CLEAR_VARIABLE units_side1_TEMP}
                            [endlevel]
                                {CONTINUE}
                                # I doubt anyone will want a replay of these things...
                                replay_save=no
                            [/endlevel]
                        [/then]
                    [/if]
                [/else]
            [/if]
        [/event]

        # limiting the possible recall
        # I had it set to 60 gold (3 units), but that gets too difficult when facing level 2 enemies.
        # Now trying 80
        # (v 1.1.2) - removing keeps -> no recruit, recall
        [event]
            name=prestart
            #            name=start
            [store_starting_location]
                side=1
                variable=temp_starting_location
            [/store_starting_location]

            # a hack to kill off the guy that shows up because of the the side 1 definition
            # whoops, this causes auto-defeat
            # not sure why this is even happening...  Because there is a C_Belleros lurking somewhere, that's who this extra fucker is!
            #	    [kill]
            #		type=Lieutenant
            #	    [/kill]
            {CAPTURE_VILLAGES 1 $temp_starting_location.x $temp_starting_location.y 2}
            # this is to make sure the starting position of the new map is used, not of the old map specified above
            {TELEPORT_UNIT (
                side=1
                canrecruit=yes
            ) $temp_starting_location.x $temp_starting_location.y}
            {CLEAR_VARIABLE temp_starting_location}

            [store_map_dimensions]
                variable=mapsize
            [/store_map_dimensions]
            [set_variable]
                name=should_run
                value=0
            [/set_variable]
            ###############################################
            # 11-19-2012: Changing this to something more like TotSS - prevent statuses from being restored between skirmishes
            # 12-31-2021: The status preservation had stopped working, now we need to save HP and status.poisoned in unit.variables.sk_**

            [set_variable]
                name=ss_recalls_used_temp
                value=0
            [/set_variable]
            [store_unit]
                [filter]
                    id={PLAYERID}
                [/filter]
                variable=ex_temp
                kill=no
            [/store_unit]
            [store_unit]
                [filter]
                    [not]
                        id={PLAYERID}
                    [/not]
                    [filter_wml]
                        [variables]
                            on_call=yes
                        [/variables]
                    [/filter_wml]
                [/filter]
                kill=no
                variable=ss_recall_temp
            [/store_unit]
            [while]
                #                [have_unit]
                #                    search_recall_list=yes
                #                    [and]
                #                        [filter_wml]
                #                            [variables]
                #                                on_call=yes
                #                            [/variables]
                #                        [/filter_wml]
                #                    [/and]
                #                    [and]
                #                        x,y=recall,recall
                #                    [/and]
                #                [/have_unit]
                #                [and]
                [variable]
                    name=ss_recalls_used_temp
                    less_than=$ss_recall_temp.length
                [/variable]
                #                [/and]
                [do]
                    [set_variable]
                        name=ss_recall_temp[$ss_recalls_used_temp].x
                        value=$ex_temp.x
                    [/set_variable]
                    [set_variable]
                        name=ss_recall_temp[$ss_recalls_used_temp].y
                        value=$ex_temp.y
                    [/set_variable]
                    [set_variable]
                        name=ss_recall_temp[$ss_recalls_used_temp].moves
                        value=$ss_recall_temp[$ss_recalls_used_temp].max_moves
                    [/set_variable]
                    [set_variable]
                        name=ss_recall_temp[$ss_recalls_used_temp].attacks_left
                        value=$ss_recall_temp[$ss_recalls_used_temp].max_attacks
                    [/set_variable]
                    # fixing the BfW 1.16 auto-healing
                    [set_variable]
                        name=ss_recall_temp[$ss_recalls_used_temp].hitpoints
                        value=$ss_recall_temp[$ss_recalls_used_temp].variables.sk_hitpoints
                    [/set_variable]
                    [set_variable]
                        name=ss_recall_temp[$ss_recalls_used_temp].status.poisoned
                        value=$ss_recall_temp[$ss_recalls_used_temp].variables.sk_poison
                    [/set_variable]
                    [kill]
                        id=$ss_recall_temp[$ss_recalls_used_temp].id
                    [/kill]
                    [unstore_unit]
                        variable=ss_recall_temp[$ss_recalls_used_temp]
                        find_vacant=yes
                    [/unstore_unit]
                    [set_variable]
                        name=ss_recalls_used_temp
                        add=1
                    [/set_variable]
                [/do]
            [/while]
            # #ifdef __UNUSED__
            {CLEAR_VARIABLE ss_recall_temp}
            {CLEAR_VARIABLE ex_temp}
            {CLEAR_VARIABLE ss_recalls_used_temp}
            # #endif
            # this is to put the units back on the recall list without healing etc.
            # I think this used to work, but in BfW 1.16.1, it is not working.
            # confirmed that the event is firing, the units are getting fully healed on the recall list
            # adding the HP and status to the unit variables "sk_***", to be retrieved in the next skirmish
            [event]
                name=victory
                [store_unit]
                    [filter]
                        side=1
                        [not]
                            x,y=recall,recall
                        [/not]
                        [not]
                            id={PLAYERID}
                        [/not]
                    [/filter]
                    variable=MODIFY_UNIT_store
                    kill=yes
                [/store_unit]
                # [message]
                #     speaker=narrator
                #     message=_"Victory event fired"
                # [/message]
                {FOREACH MODIFY_UNIT_store MODIFY_UNIT_i}
                    #                [set_variable]
                    #                    name=MODIFY_UNIT_store[$MODIFY_UNIT_i].experience
                    #                    add=$sk_exp
                    #                [/set_variable]
                    [set_variable]
                        name=MODIFY_UNIT_store[$MODIFY_UNIT_i].attacks_left
                        value=1
                    [/set_variable]
                    [set_variable]
                        name=MODIFY_UNIT_store[$MODIFY_UNIT_i].x
                        value="recall"
                    [/set_variable]
                    [set_variable]
                        name=MODIFY_UNIT_store[$MODIFY_UNIT_i].y
                        value="recall"
                    [/set_variable]
                    [set_variable]
                        name=MODIFY_UNIT_store[$MODIFY_UNIT_i].variables.sk_poison
                        value=$MODIFY_UNIT_store[$MODIFY_UNIT_i].status.poisoned
                    [/set_variable]
                    [set_variable]
                        name=MODIFY_UNIT_store[$MODIFY_UNIT_i].variables.sk_hitpoints
                        value=$MODIFY_UNIT_store[$MODIFY_UNIT_i].hitpoints
                    [/set_variable]
                    [unstore_unit]
                        variable=MODIFY_UNIT_store[$MODIFY_UNIT_i]
                        find_vacant=no
                    [/unstore_unit]
                {NEXT MODIFY_UNIT_i}

                {CLEAR_VARIABLE MODIFY_UNIT_store}
                {CLEAR_VARIABLE sk_exp}
                {CLEAR_VARIABLE sk_prize}
            [/event]
        [/event]

        #    [event]
        #        name=prestart
        #
        #    [/event]

        # I believe this is unnecessary
#ifdef __UNUSED__
        [event]
            name=die
            first_time_only=no
            [filter]
                side=2
                [not]
                    id=Leader
                [/not]
            [/filter]
            [if]
                [have_unit]
                    side=2
                    [not]
                        id=Leader
                    [/not]
                [/have_unit]
                [else]
                    [store_unit]
                        [filter]
                            id={PLAYERID}
                        [/filter]
                        kill=no
                        variable=playpos
                    [/store_unit]
                    [store_unit]
                        [filter]
                            id=Leader
                        [/filter]
                        kill=no
                        variable=leaderpos
                    [/store_unit]
                    [if]
                        [variable]
                            name=leaderpos.y
                            less_than=$playpos.y
                        [/variable]
                        [then]
                            [modify_side]
                                side=2
                                [ai]
                                    [leader_goal]
                                        x,y=12,1
                                    [/leader_goal]
                                [/ai]
                            [/modify_side]
                        [/then]
                        [else]
                            [modify_side]
                                side=2
                                [ai]
                                    [leader_goal]
                                        x,y=12,$mapsize.height
                                    [/leader_goal]
                                [/ai]
                            [/modify_side]
                        [/else]
                    [/if]
                    {CLEAR_VARIABLE playpos}
                    {CLEAR_VARIABLE leaderpos}
                [/else]
            [/if]
        [/event]
#endif

        [event]
            name=moveto
            [filter]
                id=Leader
                x=1,2-29,2-29,30
                y=1-30,1,30,1-30
            [/filter]
            #                [message]
            #                    speaker=Leader
            #                    message= _ "I'm out of here!"
            #                [/message]
            [kill]
                id=Leader
            [/kill]
            [message]
                speaker={PLAYERID}
                message= _ "That one will bring others, we don't have time to scavenge resources from the dead... At least we got some combat experience."
            [/message]
            [endlevel]
                {CONTINUE}
                # I doubt anyone will want a replay of these things...
                replay_save=no
            [/endlevel]
        [/event]

        {ACTION_WML}

        {BMR_SK_VICTORY}

        {BMR_HERO_DEATHS}
    [/scenario]

#enddef

#define BMR_SKIRMISH_STATUS_CLEAR
    # put this in the worldmap scenarios with the [endlevel]s
    [store_unit]
        [filter]
            side=1
            x,y=recall,recall
            # [not]
            #     canrecruit=yes
            # [/not]
        [/filter]
        variable=MODIFY_UNIT_store
        kill=yes
    [/store_unit]
    {FOREACH MODIFY_UNIT_store MODIFY_UNIT_i}
        [set_variable]
            name=MODIFY_UNIT_store[$MODIFY_UNIT_i].variables.sk_poison
            value=no
        [/set_variable]
        [set_variable]
            name=MODIFY_UNIT_store[$MODIFY_UNIT_i].variables.sk_hitpoints
            value=$MODIFY_UNIT_store[$MODIFY_UNIT_i].max_hitpoints
        [/set_variable]
        [unstore_unit]
            variable=MODIFY_UNIT_store[$MODIFY_UNIT_i]
            find_vacant=no
        [/unstore_unit]
    {NEXT MODIFY_UNIT_i}

    {CLEAR_VARIABLE MODIFY_UNIT_store}
#enddef
