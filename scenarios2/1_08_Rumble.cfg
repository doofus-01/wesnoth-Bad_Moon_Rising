#textdomain wesnoth-Bad_Moon_Rising
[scenario]
    id="1_08_Rumble"
    name= _ "Royal Rumble"
    map_data="{~add-ons/Bad_Moon_Rising/maps/1_08_RumbleD.map}"
    next_scenario="1_09_World"
    victory_when_enemies_defeated=no
    {TURNS 50 55 60}
    {SCENARIO_MUSIC "knalgan_theme.ogg"}
    #        #Introduction
    #        {~add-ons/Bad_Moon_Rising/utils/rumble.cfg}

    {BMR_SUMMER}
    {BMR_INIT_LUA}

#define BMR_RUMBLE_GATE_OPEN X X1 X2
    [terrain]
        x,y={X},5
        terrain=Rrc
    [/terrain]
    [terrain]
        x,y={X},4
        terrain=Rrc^Ycsg
    [/terrain]
    [redraw][/redraw]
    [delay]
        time=100
    [/delay]
    [terrain]
        x,y={X},4
        terrain=Rrc
    [/terrain]
    [terrain]
        x,y={X},3
        terrain=Rrc^Ycsg
    [/terrain]
    [redraw][/redraw]
    [delay]
        time=100
    [/delay]
    [terrain]
        x,y={X},3
        terrain=Rrc
    [/terrain]
    [terrain]
        x,y={X},2
        terrain=Rrc^Ycsg
    [/terrain]
    [redraw][/redraw]
    [terrain]
        x,y={X1}-{X2},6
        terrain="Rr"
        layer=overlay
    [/terrain]
#enddef
#define BMR_RUMBLE_GATE_CLOSE X X1 X2
    [terrain]
        x,y={X},2
        terrain=Rrc
    [/terrain]
    [terrain]
        x,y={X},3
        terrain=Rrc^Ycsg
    [/terrain]
    [redraw][/redraw]
    [delay]
        time=100
    [/delay]
    [terrain]
        x,y={X},3
        terrain=Rrc
    [/terrain]
    [terrain]
        x,y={X},4
        terrain=Rrc^Ycsg
    [/terrain]
    [redraw][/redraw]
    [delay]
        time=100
    [/delay]
    [terrain]
        x,y={X},4
        terrain=Rrc
    [/terrain]
    [terrain]
        x,y={X},5
        terrain=Rrc^Ycsg
    [/terrain]
    [redraw][/redraw]
    [terrain]
        x,y={X1}-{X2},6
        terrain="Rr^Xo"
        layer=overlay
    [/terrain]
#enddef

#define BMR_RUMBLE_GATE_OPEN_WEST
    {BMR_RUMBLE_GATE_OPEN 21 19 23}
#enddef

#define BMR_RUMBLE_GATE_OPEN_EAST
    {BMR_RUMBLE_GATE_OPEN 29 27 31}
#enddef

#define BMR_RUMBLE_GATE_CLOSE_WEST
    {BMR_RUMBLE_GATE_CLOSE 21 19 23}
#enddef

#define BMR_RUMBLE_GATE_CLOSE_EAST
    {BMR_RUMBLE_GATE_CLOSE 29 27 31}
#enddef

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Lorenzon"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Belleros"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Raenna"
            [/objective]

            {TURNS_RUN_OUT}
        [/objectives]
        # this is to create a delay between when Astreya is killed and when she comes back
        # can this be deleted?
        [set_variable]
            name=ghostcount
            value=-1
        [/set_variable]
    [/event]

    [side]
        type=Lieutenant
        id=Lorenzon
        name="Lorenzon"
        side=1
        canrecruit=yes
        controller=human
        shroud=no
        recruit=Ukian Runner, Ukian Regular, Ukian Archer, Ukian Dog
        {GOLD 450 400 350}
        {INCOME 8 6 4}
        team_name=good
    [/side]

    [side]
        type=Huric
        id=Huric
        name= _ "King"+" Huric"
        profile="portraits/huric.webp"
        facing=nw
        side=2
        canrecruit=yes
        controller=ai
        # getting rid of FAI stuff, the default AI and MicroAI now make this unneeded, I think.  <- no, not yet.  Maybe in BfW 1.13...
        {ai/aliases/stable_singleplayer.cfg}
        shroud=no
#ifdef EASY
        recruit=Northern Fighter, Bowman, Heavy Infantryman, Swordsman, Horseman
#endif
#ifdef NORMAL
        recruit=Northern Fighter, Bowman, Heavy Infantryman, Swordsman, Horseman, Shock Trooper
#endif
#ifdef HARD
        recruit=Northern Fighter, Bowman, Heavy Infantryman, Swordsman, Horseman, Shock Trooper, Longbowman
#endif
        {GOLD 200 300 400}
        {INCOME 28 32 36}
        team_name=royal
        [ai]
            # some bodyguards - 20140607- Leaving this as FAI for now, but I think it may be an issue later.  <-Actually, ':inspect' doesn't show this as doing anything...
            {MODIFY_AI_ADD_CANDIDATE_ACTION 2 main_loop (
                [candidate_action]
                    id=push_to_destination
                    engine=fai
                    name=push_to_destination
                    type=movement
                    evaluation="if(me.id='Mauler_1',{AI_CA_COMBAT_SCORE}+10,me.id='Mauler_2',{AI_CA_COMBAT_SCORE}+10,0)"
                    action="move(me.loc,choose(unit_moves(me.loc),'mloc',-sum(map(simplest_path(mloc,my_leader.loc,me.loc),'path_location', movement_cost( me, path_location ) ))) )"
                [/candidate_action]
            )}
            # end bodyguards
            #            {BMR_PROTECT_LEADER 6.0 4}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.6}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.9}
        [/ai]
        [unit]
            type=Javelineer
            generate_name=yes
            ai_special=guardian
            x,y=26,15
        [/unit]
        [unit]
            type=Pikeman
            generate_name=yes
            ai_special=guardian
            x,y=25,25
            id=Guard_Pike
        [/unit]
    [/side]

    [side]
        type=General
        id=Horton
        name= _ "General"+" Horton"
        side=3
        canrecruit=yes
        controller=ai
        shroud=no
        recruit=Northern Fighter, Spearman, Bowman, Horseman, Cavalryman, Pikeman
        {GOLD 175 250 325}
        {INCOME 10 14 18}
        team_name=royal
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
            {BMR_AI_UPROTECT (id=Huric) 20.0 10}
            {BMR_AI_TARGET (side=1) 50}
            #	aggression=0.8
            #	grouping=offensive
            #	recruitment_pattern=fighter,archer,scout
            #	[protect_unit]
            #		id=Huric
            #		radius=10
            #		value=20.0
            #	[/protect_unit]
            #	leader_value=6
            #	[target]
            #		side=1
            #		value=50
            #	[/target]
        [/ai]
#ifdef EASY
        [unit]
            type=Northern Fighter
            id=NF3_1
            generate_name=yes
            x,y=34,20
        [/unit]
        [unit]
            type=Northern Fighter
            id=NF3_2
            generate_name=yes
            x,y=39,13
        [/unit]
#else
        [unit]
            type=Northern Soldier
            id=NF3_1
            generate_name=yes
            x,y=34,20
        [/unit]
        [unit]
            type=Northern Soldier
            id=NF3_2
            generate_name=yes
            x,y=39,13
        [/unit]
#endif
    [/side]

    [side]
        type=General
        id=Norton
        name= _ "General"+" Norton"
        side=4
        canrecruit=yes
        controller=ai
        shroud=no
        recruit=Northern Fighter, Spearman, Bowman, Cavalryman, Longbowman
        {GOLD 450 575 650}
        {INCOME 10 12 14}
        team_name=royal
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
            {BMR_AI_UPROTECT (id=Huric) 20.0 10}
            #	{BMR_AI_TARGET (side=1) 50}
            #	aggression=0.8
            #	grouping=offensive
            #	recruitment_pattern=fighter,archer,scout
            #	[protect_unit]
            #		id=Huric
            #		radius=10
            #		value=20.0
            #	[/protect_unit]
        [/ai]
#ifdef EASY
        [unit]
            type=Spearman
            id=NF4_1
            generate_name=yes
            x,y=17,15
        [/unit]
        [unit]
            type=Northern Fighter
            id=NF4_2
            generate_name=yes
            x,y=16,20
        [/unit]
#else
        [unit]
            type=Javelineer
            id=NF4_1
            generate_name=yes
            x,y=17,15
        [/unit]
        [unit]
            type=Northern Soldier
            id=NF4_2
            generate_name=yes
            x,y=16,20
        [/unit]
#endif
    [/side]

    [side]
        type=Primevalist Leader
        id=Vazzan
        name= _ "General"+" Vazzan"
        profile="portraits/vazzan.webp"
        side=5
        canrecruit=yes
        shroud=no
        # Vazzan refuses to recruit level 1 units if he is allowed to recruit level 2,
        # even if through side-limit_utils.cfg macros
        recruit=Primevalist Fighter, Primevalist Follower
        # , Primevalist Fanatic, Primevalist Monk
        {GOLD 300 250 175}
        {INCOME 14 10 6}
        team_name=bad
        [ai]
            #	aggression=0.7
            #	    grouping=offensive
            #            recruitment_pattern=mixed fighter,mixed fighter,archer
            {BMR_AI_TARGET (side=2) 80}
            {BMR_AI_TARGET (side=1) 20}
            #	    [target]
            #		side=2
            #		value=100
            #	    [/target]
            #	    [target]
            #		side=1
            #		value=50
            #	    [/target]
            passive_leader=yes
        [/ai]
        [unit]
            type=Primevalist Fanatic
            id=PF1
            generate_name=yes
            x,y=12,18
        [/unit]
        [unit]
            type=Primevalist Fanatic
            generate_name=yes
            x,y=9,16
        [/unit]
        [unit]
            type=Primevalist Monk
            generate_name=yes
            x,y=13,22
        [/unit]
    [/side]

    [side]
        side=6
        no_leader=yes
        team_name=royal
        color=white
        [ai]
            [goal]
                name=target_location
                [criteria]
                    x,y=6,33
                [/criteria]
                value=6
            [/goal]
            [goal]
                name=protect_unit
                [criteria]
                    id=Rider_1
                [/criteria]
                value=10
                protect_radius=10
            [/goal]
        [/ai]
    [/side]

    {FLAMES 5 18}
    {FLAMES 9 20}
    {FLAMES 8 22}
    {FLAMES 10 22}
    {FLAMES 9 18}
    {STARTING_VILLAGES_AREA 1 34 31 3}
    {STARTING_VILLAGES_AREA 2 17 12 4}
    {STARTING_VILLAGES_AREA 3 25 21 7}
    {STARTING_VILLAGES_AREA 4 20 17 4}
    {STARTING_VILLAGES_AREA 5 3 22 4}

    [event]
        name=prestart
        [recall]
            id=Raenna
            x,y=35,31
        [/recall]
        [recall]
            id=Belleros
            x,y=33,32
        [/recall]
        {MODIFY_UNIT (side=1) facing nw}
        {MODIFY_UNIT (side=2) facing sw}
        {MODIFY_UNIT (side=5) facing ne}
    [/event]

    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Swordsman 4}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Pikeman 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Longbowman 4}
    # Maybe include this later?
    #    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Primevalist Fanatic" 2}
    #    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Primevalist Monk" 2}

    #   [event]
    #        name=rider_run_start
    #        first_time_only=no
    #        {MODIFY_AI_ADD_CANDIDATE_ACTION 2 main_loop (
    #            [candidate_action]
    #                id=rider_move_away
    #                engine=fai
    #                name=rider_move_away
    #                type=movement
    #                evaluation="if(nem_loc=null,0,if(choose(unit_moves(me.loc),distance_between(loc(nem_loc.loc.x,nem_loc.loc.y),self)) != null, {AI_CA_GOTO_SCORE}+10,0))
    #                                        where nem_loc = find(close_enemies(me.loc,6), id='Nemesis')"
    #                action = "move(me.loc,choose(unit_moves(me.loc),distance_between(loc(nem_loc.loc.x,nem_loc.loc.y),self)))
    #                                        where nem_loc = find(close_enemies(me.loc,6), id='Nemesis')"
    #            [/candidate_action]
    #        )}

    [event]
        name=start
        [set_variable]
            name=beenhere
            value=no
        [/set_variable]
        [apply_gear]
            gear_id=steel_blade
            id=PF1
        [/apply_gear]
        [apply_gear]
            gear_id=scale_armor
            id=NF3_1
        [/apply_gear]
        [apply_gear]
            gear_id=fang_charm
            id=NF3_2
        [/apply_gear]
        [apply_gear]
            gear_id=steel_spear
            id=NF4_1
        [/apply_gear]
        [apply_gear]
            gear_id=bronze_gloves
            id=NF4_2
        [/apply_gear]
        [message]
            speaker=Lorenzon
            message = _ "Duval! Maskov! We're here!"
        [/message]
        [message]
            speaker=Huric
            message = _ "Really! Why tell them that, do you have the help of ghosts? Duval died months ago, and I'm told you killed Maskov... You truly are a madman."
        [/message]
        [message]
            speaker=Lorenzon
            message = _ "(Duval died months ago?)"
        [/message]
        [message]
            speaker=Raenna
            message = _ "(Something's wrong, that's not General Maskov leading the assault ...)"
        [/message]
        #	[scroll_to]
        #		x,y=22,41
        #	[/scroll_to]
        #	[delay]
        #	    time=1200
        #	[/delay]
        [message]
            speaker=Lorenzon
            message = _ "You there! Who are you? Where is General Maskov?"
        [/message]
        [message]
            speaker=Vazzan
            message = _ "I am General Vazzan! Maskov was a fool and was not willing to accept the Restoration of Order!"
        [/message]
        [message]
            speaker=Lorenzon
            message = _ "<i>What!?</i>  What is 'Order'?  What the hell is going on?"
        [/message]
        [message]
            speaker=Raenna
            message = _ "(And if Duval has been dead for months, just who was that we left in the mine with Maskov?)"
        [/message]
        [message]
            speaker=Belleros
            message = _ "(Assuming Huric is telling the truth...)"
        [/message]
        [message]
            speaker=Huric
            message = _ "'What is going on', he asks ... Indeed, Lorenzon, what is going on?  You once fought for me, but now you've gone mad and are trying to destroy our kingdom..."
        [/message]
        [message]
            speaker=Huric
            message = _ "But know this!  I will destroy you - I will destroy the rebellion - I will destroy all your damned magicians!  The sun will shine again upon Ukiah, to warm our fields and <i>bleach your skulls!</i>"
        [/message]
        [message]
            speaker=Vazzan
            message = _ "No.  Tyrant and rebel alike, you shall all perish... Unless you accept Order!"
        [/message]
        [apply_gear]
            id=Guard_Pike
            gear_id=chain_armor
        [/apply_gear]
    [/event]

    [event]
        name=die
        [filter]
            id=Lorenzon
        [/filter]
        [message]
            speaker=unit
            message= _ "Ugh. What a mess..."
        [/message]
        [message]
            speaker=Huric
            message = _ "Ha!  Battlefield death is more of an honor than you deserve, Lorenzon, but it will do!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=die
        [filter]
            id=Belleros
        [/filter]
        [message]
            speaker=unit
            message= _ "Ugh. What a mess..."
        [/message]
        [message]
            speaker=Lorenzon
            message= _ "I can't let the rebellion's heroes die like this..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=die
        [filter]
            id=Raenna
        [/filter]
        [message]
            speaker=unit
            message= _ "Ugh. What a mess..."
        [/message]
        [message]
            speaker=Lorenzon
            message= _ "I can't let the rebellion's heroes die like this..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Vazzan
        [/filter]
        [message]
            speaker=unit
            message= _ "I must be going now, maybe we shall meet again."
        [/message]
        [kill]
            id=Vazzan
        [/kill]
        [move_unit_fake]
            side=5
            type=Primevalist Leader
            x=$x1,24
            y=$y1,45
        [/move_unit_fake]
    [/event]
    [event]
        name=attack
        [filter_second]
            id=Vazzan
        [/filter_second]
        [message]
            speaker=second_unit
            message= _ "I must be going now, maybe we shall meet again."
        [/message]
        [kill]
            id=Vazzan
        [/kill]
        [move_unit_fake]
            side=5
            type=Primevalist Leader
            x=$x2,6
            y=$y2,33
        [/move_unit_fake]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            y=1-23
        [/filter]
        [unit]
            side=2
            type=Northern Ranger
            id=Carusoe
            profile=portraits/carusoe.webp
            name=Carusoe
            x,y=15,33
            random_traits=yes
            facing=sw
        [/unit]
        [unit]
            side=2
            type=Royal Herdsman
            x,y=14,33
            facing=ne
        [/unit]
        [unit]
            side=2
            type=Hunting_Hound
            id=Koundar
            name="Koundar"
            x,y=16,33
            facing=ne
        [/unit]
        [message]
            speaker=Carusoe
            message= _ "Ha!"
        [/message]
        {MOVE_UNIT id=Carusoe 12 27}
        {MODIFY_UNIT id=Carusoe facing ne}
        [message]
            speaker=Carusoe
            message= _ "We meet again, Raenna...  I will show you what a Northern Ranger can do!  Your pathetic rebellion will fail, you will call my name for mercy!"
        [/message]
        [message]
            speaker=Huric
            message= _ "Carusoe, old friend, I'm afraid the time in the tundra has touched your head. They will beg for my forgiveness, not yours..."
        [/message]
        [message]
            speaker=Carusoe
            message= _ "Of course, my lord. I meant no disrespect, you will defeat the rebellion. But please, leave Raenna to me."
        [/message]
        [message]
            speaker=Raenna
            message= _ "(Why does he single me out? Sounds like I need to make an example of him...)"
        [/message]
        [apply_gear]
            id=Koundar
            gear_id=diamond_collar
        [/apply_gear]
        [apply_gear]
            id=Koundar
            gear_id=brigandine_vest
        [/apply_gear]
    [/event]

    [event]
        name=attack
        [filter]
            id=Koundar
        [/filter]
        [message]
            speaker=Carusoe
            message= _ "That's right, Koundar!  Kill them!"
        [/message]
    [/event]
    [event]
        name=die
        [filter]
            id=Koundar
        [/filter]
        [if]
            [have_unit]
                id=Carusoe
            [/have_unit]
            [then]
                [message]
                    speaker=Carusoe
                    message= _ "You killed Koundar!  You bastards!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Huric
                    message= _ "That dog was more valuable than all of you cultists, brigands, and whores combined!  You shall pay dearly for that!"
                [/message]
            [/else]
        [/if]
    [/event]

    {FORCE_CHANCE_TO_HIT (
        [not]
            id=Raenna
        [/not]
    ) id=Carusoe 1 ()}

    [event]
        name=attack end
        [filter]
            side=1
            [not]
                id=Raenna
            [/not]
        [/filter]
        [filter_second]
            id=Carusoe
        [/filter_second]
        [message]
            speaker=Carusoe
            message= _ "I am the better warrior, you cannot touch me!"
        [/message]
        [message]
            speaker=Raenna
            message= _ "(Loathsome as ever... I must strike him down)."
        [/message]
    [/event]

    [event]
        name=attacker hits
        [filter]
            id=Raenna
        [/filter]
        [filter_second]
            id=Carusoe
        [/filter_second]
        [message]
            speaker=Raenna
            message= _ "You talked such bluster, dared to ask for my sacrifice. But now it is you who will fall. Any last words?"
        [/message]
        [message]
            speaker=Carusoe
            message= _ "Yes! I've been with you on the tundra for years, I know you better tha-"
        [/message]
        [message]
            speaker=Raenna
            message= _ "Just stop!"
        [/message]
        [animate_unit]
            flag=attack
            [filter]
                id=Raenna
            [/filter]
            [primary_attack]
                name=firebow
            [/primary_attack]
            hits=yes
        [/animate_unit]
        [message]
            speaker=Carusoe
            message= _ "Ack! Fine! Let me go, I will give you the funds I have and will bother you no more..."
        [/message]
        [message]
            speaker=Raenna
            message= _ "(They say mercy is a virtue ...)  Very well, begone and do not cross our path again!"
        [/message]
        #		    [option]
        #			message= _ "and we are the righteous ones.)  Very well, begone and do not cross our path again!"
        #			[command]
        [message]
            speaker=Carusoe
            message= _ "Thank you..."
        [/message]
        [message]
            speaker=narrator
            message= _ "The Ranger's purse added 195 gold to the war chest."
            image=wesnoth-icon.png
        [/message]
        {MOVE_UNIT id=Carusoe 18 33}
        [gold]
            amount=195
            side=1
        [/gold]
        [message]
            speaker=Carusoe
            message= _ "-(Sigh)- Some day..."
        [/message]
        [kill]
            id=Carusoe
        [/kill]
        [message]
            speaker=Huric
            message= _ "Carusoe, get back here! ... Bah, friends like that..."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Huric
        [/filter]
        [message]
            speaker=unit
            message= _ "Uhhg, Ukiah falls... Many will die... Damn you, Lorenzon... May you get what you deserve..."
        [/message]
        [kill]
            id=Huric
            animate=yes
        [/kill]
        [item]
            image=misc/huric-dead.png
            x,y=$x1,$y1
        [/item]
        [music]
            name=the_city_falls.ogg
            append=no
            immediate=yes
        [/music]
        [message]
            speaker=Raenna
            message= _ "If Duval died months ago, who has been tagging along with us all this time?"
        [/message]
        [message]
            speaker=Lorenzon
            message= _ "Something is very wrong... We'll have to deal with the consequences of Huric's death later, right now we need to get back to the mine."
        [/message]
        [message]
            speaker=Belleros
            message= _ "But now that Huric is dead, you are the Commander of the North!"
        [/message]
        [message]
            speaker=Lorenzon
            message= _ "No, I'm a simple man and I've been made a fool by whoever is in the copper mine! This is no time to play with crowns."
        [/message]
        [message]
            speaker=Raenna
            message= _ "Lorenzon, sir, I agree that we must get to the mine with all haste, but you must acknowledge the situation we leave behind. Let the people here know your revolution has succeeded, they will need some hope to hold up against the oncoming Orcish raids."
        [/message]
        [message]
            speaker=Lorenzon
            message= _ "Right, but then we head out to the mines, no more delay."
        [/message]
        {TRANSFORM_UNIT id=Lorenzon "Ukian Commander"}
        [message]
            speaker=Lorenzon
            message= _ "With the defeat of Huric, I am now Commander of the ruling human forces. However, I cannot stay to fend off the orcs, so I ask all civilians to be ready to follow us."
        [/message]
        [store_unit]
            [filter]
                side=1
                [not]
                    id=Lorenzon
                [/not]
            [/filter]

            variable=PUT_TO_RECALL_LIST_temp
            kill=yes
        [/store_unit]

        {FOREACH PUT_TO_RECALL_LIST_temp PUT_TO_RECALL_LIST_i}
            {VARIABLE PUT_TO_RECALL_LIST_temp[$PUT_TO_RECALL_LIST_i].x "recall"}
            {VARIABLE PUT_TO_RECALL_LIST_temp[$PUT_TO_RECALL_LIST_i].y "recall"}

            [unstore_unit]
                variable=PUT_TO_RECALL_LIST_temp[$PUT_TO_RECALL_LIST_i]
                find_vacant=no
            [/unstore_unit]
        {NEXT PUT_TO_RECALL_LIST_i}

        {CLEAR_VARIABLE PUT_TO_RECALL_LIST_temp,PUT_TO_RECALL_LIST_i}
        [hide_unit]
            id=Lorenzon
        [/hide_unit]
        [set_variable]
            name=y_off
            value=$y1
        [/set_variable]
        [set_variable]
            name=y_off
            add=-1
        [/set_variable]
        # this variable enables Astreya to attack in random skirmishes
        {VARIABLE huricdead 1}
        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
        {FADE_TO_BLACK}
        [unit]
            type=Phantom Queen
            id=Astreya
            name= _ "Astreya"
            x,y=25,23
            side=2
        [/unit]
        [unit]
            type=Phantom Slayer
            x,y=24,23
            side=2
        [/unit]
        [unit]
            type=Phantom Officer
            x,y=26,23
            side=2
        [/unit]
        {FADE_IN}
        [message]
            speaker=Astreya
            message= _ "My King..."
        [/message]
        {MOVE_UNIT (id=Astreya) $x1 $y_off}
        [message]
            speaker=narrator
            image=portraits/huric.webp
            message= _ "Damn you apparition...  Even as I die, you torment me with her image...  "
        [/message]
        [music]
            name=sad.ogg
            append=no
            immediate=yes
        [/music]
        [message]
            speaker=Astreya
            message= _ "Oh, Huric!  I never meant to harm you, I only wanted to let you know that I was still with you.  But I could never make you understand...  -(sniff!)- Now you're one of us ..."
        [/message]
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Astreya
            message= _ "They will pay for this! We will drain the blood of the assassins, we will obliterate their souls..."
        [/message]
        [music]
            name=vengeful.ogg
            append=no
            immediate=yes
        [/music]
        [message]
            speaker=Astreya
            message= _ "We will <i>destroy</i> them!"
        [/message]
        [remove_item]
            image=misc/huric-dead.png
            x,y=$x1,$y1
        [/remove_item]
        [delay]
            time=120
        [/delay]
        [item]
            image=misc/huric-dead.png
            x,y=$x1,$y1
        [/item]
        [delay]
            time=120
        [/delay]
        [remove_item]
            image=misc/huric-dead.png
            x,y=$x1,$y1
        [/remove_item]
        [delay]
            time=120
        [/delay]
        [item]
            image=misc/huric-dead.png
            x,y=$x1,$y1
        [/item]
        [delay]
            time=120
        [/delay]
        [remove_item]
            image=misc/huric-dead.png
            x,y=$x1,$y1
        [/remove_item]
        [delay]
            time=120
        [/delay]
        [item]
            image=misc/huric-dead.png
            x,y=$x1,$y1
        [/item]
        [delay]
            time=120
        [/delay]
        [remove_item]
            image=misc/huric-dead.png
            x,y=$x1,$y1
        [/remove_item]
        [kill]
            type=Phantom Slayer
        [/kill]
        [kill]
            type=Phantom Officer
        [/kill]
        {MOVE_UNIT (id=Astreya) 21 30}
        [kill]
            id=Astreya
        [/kill]
        [endlevel]
            result=victory
            music=vengeful.ogg
        [/endlevel]
    [/event]

    [event]
        name=turn 3
        [message]
            speaker=Belleros
            message= _ "Ol' King Huric seems pretty comfortable up there, how are we ever going to defeat him?"
        [/message]
        [message]
            speaker=Lorenzon
            message= _ "We will have to grind his forces down as best we can.  Neither side can afford a siege."
        [/message]
        [message]
            speaker=Raenna
            message= _ "That doesn't sound like much of a plan..."
        [/message]
        [message]
            speaker=Lorenzon
            message= _ "And what would you have me say?  Walking away isn't really an option now."
        [/message]
    [/event]

#define BMR_RUMBLE_GUARDS

#ifdef EASY
    type=Shock Trooper
#endif
#ifdef NORMAL
    type=Iron Mauler
#endif
#ifdef HARD
    type=Iron Mauler
#endif

#enddef

#define BMR_RUMBLE_GUARDS_2

#ifdef EASY
    type=Swordsman
#endif
#ifdef NORMAL
    type=Northern Soldier
#endif
#ifdef HARD
    type=Northern Elite
#endif

#enddef

#define BMR_RUMBLE_GENERALS GENA GENB
    [event]
        name=die
        # was this last breath for a reason?
        #        name=last breath
        [filter]
            id={GENA}
        [/filter]
        [if]
            [have_unit]
                id={GENB}
            [/have_unit]
            [then]
                [message]
                    speaker=Lorenzon
                    message= _ "Well! The mighty King Huric hides in his castle, letting his generals take all the pain and defeat that he himself is too frightened to face."
                [/message]
                [message]
                    speaker=Raenna
                    message= _ "I didn't take you for a gloater, Lorenzon."
                [/message]
                [message]
                    speaker=Lorenzon
                    message= _ "(If we can provoke him to over-extend himself, we stand a chance.)"
                [/message]
                [message]
                    speaker=Huric
                    message= _ "I'm not afraid of treacherous whelps like you, Lorenzon.  I have many other things begging for my attention, let's get this over with!"
                [/message]
                [if]
                    [variable]
                        name=harlot_mission
                        equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=narrator
                            image=portraits/harlot.webp~CS(-100,-100,-100)
                            message= _ "I've got something  begging for your attnetion, my lord..."
                        [/message]
                        [message]
                            speaker=Huric
                            message= _ "What is <i>she</i> doing here?  Guards!  Take your toy back to the barracks!"
                        [/message]
                    [/then]
                [/if]
                [unit]
                    x,y=19,5
                    type=Pikeman
                    side=2
                [/unit]
                [unit]
                    x,y=20,5
                    type=Swordsman
                    id=Swordsman_1
                    side=2
                [/unit]
                [unit]
                    x,y=23,5
                    type=Halberdier
                    side=2
                [/unit]
                [unit]
                    x,y=22,4
                    type=Royal Guard
                    id=RG1
                    side=2
                [/unit]
                [unit]
                    x,y=28,5
                    type=Royal Guard
                    side=2
                [/unit]
                [unit]
                    x,y=30,5
                    type=Royal Guard
                    side=2
                [/unit]
                [if]
                    [variable]
                        name=harlot_mission
                        equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=RG1
                            message= _ "Ugh, why do I suddenly feel so tired..."
                        [/message]
                        [harm_unit]
                            [filter]
                                side=2
                                type=Royal Guard
                            [/filter]
                            amount=8
                            poisoned=yes
                        [/harm_unit]
                    [/then]
                [/if]
                {BMR_RUMBLE_GATE_OPEN_WEST}
                {MOVE_UNIT (x,y=19,5) 20 8}
                {MOVE_UNIT (x,y=20,5) 21 9}
                {MOVE_UNIT (x,y=23,5) 22 8}
                {MOVE_UNIT (x,y=22,4) 20 9}
                {BMR_RUMBLE_GATE_CLOSE_WEST}

                {BMR_RUMBLE_GATE_OPEN_EAST}
                {MOVE_UNIT (x,y=28,5) 28 8}
                {MOVE_UNIT (x,y=30,5) 30 8}
                {BMR_RUMBLE_GATE_CLOSE_EAST}
                [apply_gear]
                    gear_id=frog_helmet
                    id=RG1
                [/apply_gear]
                [message]
                    speaker=Huric
                    message= _ "You know what to do..."
                [/message]
                [message]
                    speaker=Swordsman_1
                    message= _ "Yes, my King!"
                [/message]
                [message]
                    speaker=Raenna
                    message= _ "(I'm not too impressed with this plan...)"
                [/message]
                [gold]
                    amount=120
                    side=3,4
                [/gold]
                [if]
                    [variable]
                        name=second_unit.race
                        equals=ukiandog
                    [/variable]
                    [else]
                        [message]
                            speaker=second_unit
                            message= _ "Well, this guy had some gold on him..."
                        [/message]
                    [/else]
                [/if]
                [set_variable]
                    name=def_gen_gold_x
                    value=$unit.x
                [/set_variable]
                [set_variable]
                    name=def_gen_gold_y
                    value=$unit.y
                [/set_variable]
                [item]
                    x,y=$def_gen_gold_x|,$def_gen_gold_y|
                    image=items/gold-coins-small.png
                [/item]
                [event]
                    name=moveto
                    [filter]
                        x,y=$def_gen_gold_x|,$def_gen_gold_y|
                        side=1
                    [/filter]
                    [remove_item]
                        x,y=$def_gen_gold_x|,$def_gen_gold_y|
                        image=items/gold-coins-small.png
                    [/remove_item]
                    [message]
                        speaker=narrator
                        message="$unit.name|"+ _ " picks up 150 gold coins from the defeated general."
                    [/message]
                    [gold]
                        amount=150
                        side=1
                    [/gold]
                [/event]
            [/then]
            [else]
                [message]
                    speaker=Lorenzon
                    message= _ "How you must be trembling, King Huric The Cowardly!  Hide behind your stone wall, but it is like a child hiding under a sheet...  Your generals are dead, and now I'm coming for you!"
                [/message]
                [message]
                    speaker=Huric
                    message= _ "Grrr! That's enough, whelp!"
                [/message]
                [music]
                    name=In_the_Land_of_Madness.ogg
                    append=no
                    immediate=yes
                [/music]
                [store_unit]
                    [filter]
                        id=Huric
                    [/filter]
                    kill=yes
                    variable=huric_tower
                [/store_unit]
                [unit]
                    x,y=28,5
                    {BMR_RUMBLE_GUARDS}
                    side=2
                [/unit]
                [unit]
                    x,y=28,4
                    {BMR_RUMBLE_GUARDS}
                    side=2
                [/unit]
                [unit]
                    x,y=30,5
                    {BMR_RUMBLE_GUARDS}
                    id=Mauler_1
                    side=2
                [/unit]
                [apply_gear]
                    id=Mauler_1
                    gear_id=great_helmet
                [/apply_gear]
                #                [unstore_unit]
                #                    variable=huric_tower
                #                    find_vacant=yes
                #                    x,y=22,5
                #                [/unstore_unit]
                [unit]
                    type=Grand Knight
                    x,y=22,5
                    id=Huric_Horse
                    side=2
                    name=_"King"+" Huric"
                    hitpoints=120
                    max_hitpoints=120
                    max_moves=8
                    profile=portraits/huric_horse.webp
                    canrecruit=yes
                    [modifications]
                        [object]
                            silent=yes
                            id=huric_horse_obj
                            [filter]
                                id=Huric_Horse
                            [/filter]
                            [effect]
                                apply_to=attack
                                name=sword
                                [set_specials]
                                    mode=append
                                    {WEAPON_SPECIAL_MARKSMAN}
                                [/set_specials]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add=~CS(-30,-35,-25)
                            [/effect]
                        [/object]
                    [/modifications]
                [/unit]
                [unit]
                    x,y=20,5
                    type=Iron Mauler
                    side=2
                [/unit]
                [unit]
                    x,y=22,4
                    id=Mauler_2
                    {BMR_RUMBLE_GUARDS_2}
                    side=2
                [/unit]
                [apply_gear]
                    id=Mauler_2
                    gear_id=iron_armor
                [/apply_gear]
                [delay]
                    time=250
                [/delay]
                {BMR_RUMBLE_GATE_OPEN_EAST}
                {MOVE_UNIT (x,y=28,5) 28 9}
                {MOVE_UNIT (x,y=28,4) 28 8}
                {MOVE_UNIT (x,y=30,5) 30 8}
                {BMR_RUMBLE_GATE_CLOSE_EAST}

                {BMR_RUMBLE_GATE_OPEN_WEST}
                {MOVE_UNIT (x,y=22,5) 22 8}
                {MOVE_UNIT (x,y=20,5) 20 8}
                {MOVE_UNIT (x,y=22,4) 21 8}
                {BMR_RUMBLE_GATE_CLOSE_WEST}
                [message]
                    speaker=Huric_Horse
                    message= _ "There will be no prisoners. This is it, traitors!"
                [/message]
                [message]
                    speaker=Mauler_1
                    message= _ "We will destroy them, my lord. Ukiah will prevail against those who would do the work of Orcs..."
                [/message]
                [message]
                    speaker=Raenna
                    message= _ "(I see what you're doing now!)"
                [/message]
                [message]
                    speaker=Belleros
                    message= _ "(Used Huric's pride to pull him out of his stronghold!)"
                [/message]
                [message]
                    speaker=Lorenzon
                    message= _ "(That's right, now is our chance!  Don't let the Tyrant reach the Keep!)"
                [/message]
                [if]
                    [variable]
                        name=harlot_mission
                        equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=Mauler_2
                            message= _ "I don't feel so good, I should'a turned in early last night."
                        [/message]
                        [harm_unit]
                            [filter]
                                side=2
                                type=Iron Mauler
                            [/filter]
                            amount=8
                            poisoned=yes
                        [/harm_unit]
                    [/then]
                [/if]
            [/else]
        [/if]
    [/event]
#enddef

    {BMR_RUMBLE_GENERALS Horton Norton}
    {BMR_RUMBLE_GENERALS Norton Horton}

#define BMR_RUMBLE_HORSE_1

#ifdef EASY
    type=Horseman
#endif
#ifdef NORMAL
    type=Knight
#endif
#ifdef HARD
    type=Lancer
#endif

#enddef

#define BMR_RUMBLE_HORSE_2

#ifdef EASY
    type=Cavalryman
#endif
#ifdef NORMAL
    type=Dragoon
#endif
#ifdef HARD
    type=Cavalier
#endif

#enddef

    # why is this side 2?  Should I make the riders a new side, so the pikemen etc don't go running to the south as well?
    # done, now side 6
    # 20140607-replacing this FAI stuff with MicroAI - not sure it is really needed
#ifdef __UNUSED__
    [event]
        name=riders_on
        first_time_only=no
        {MODIFY_AI_ADD_CANDIDATE_ACTION 6 main_loop (
            [candidate_action]
                id=push_to_destination
                engine=fai
                name=push_to_destination
                type=movement
                evaluation="{AI_CA_COMBAT_SCORE}+10"
                action="move(me.loc, choose(unit_moves(me.loc),'mloc',-sum(map(simplest_path(mloc,loc(6,33),me.loc), 'path_location', movement_cost( me, path_location ) ))) )"
            [/candidate_action]
        )}
    [/event]

    [event]
        name=riders_off
        first_time_only="no"
        {MODIFY_AI_DELETE_CANDIDATE_ACTION 6 main_loop push_to_destination}
    [/event]
#endif
    # microAI
    [event]
        name=riders_on
        first_time_only=no
        [micro_ai]
            ca_id=riders1
            ai_type=messenger_escort
            action=add
            side=6
            id=Rider_1
            waypoint_x,waypoint_y=6,33
        [/micro_ai]
    [/event]
    [event]
        name=riders_off
        first_time_only=no
        [micro_ai]
            action=delete
            side=6
            ca_id=riders1
            ai_type=messenger_escort
        [/micro_ai]
        [modify_ai]
            side=6
            action=delete
            path=goal[*]
        [/modify_ai]
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [if]
            [variable]
                name=side_number
                equals=6
            [/variable]
            [variable]
                name=turn_number
                equals=9
            [/variable]
            [then]
                [unit]
                    {BMR_RUMBLE_HORSE_1}
                    side=6
                    generate_name=yes
                    id=Rider_1
                    x,y=20,5
                [/unit]
                [unit]
                    {BMR_RUMBLE_HORSE_2}
                    side=6
                    generate_name=yes
                    x,y=22,5
                [/unit]
                [unit]
                    {BMR_RUMBLE_HORSE_1}
                    side=6
                    generate_name=yes
                    x,y=28,5
                [/unit]
                [unit]
                    {BMR_RUMBLE_HORSE_2}
                    side=6
                    generate_name=yes
                    x,y=30,5
                [/unit]
                [message]
                    speaker=Huric
                    message= _ "This is not going well... Send word to Sir Sadellon that his presence is required. He and his family have grown fat under my protection, it's time they paid their due."
                [/message]
                {BMR_RUMBLE_GATE_OPEN_WEST}
                [message]
                    speaker=Rider_1
                    message= _ "Yes, Lord. We will fetch him!"
                [/message]
                {BMR_RUMBLE_GATE_OPEN_EAST}
                [fire_event]
                    name=riders_on
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name= turn 9 end
        {BMR_RUMBLE_GATE_CLOSE_WEST}
        {BMR_RUMBLE_GATE_CLOSE_EAST}
    [/event]

    [event]
        name=moveto
        [filter]
            side=6
            y=30-33
        [/filter]
        [message]
            speaker=unit
            message= _ "I'm off to fetch Sir Sadellon!"
        [/message]
        [kill]
            x,y=$x1,$y1
        [/kill]
        [set_variable]
            name=sadellon
            value=$turn_number
        [/set_variable]
        [set_variable]
            name=sadellon
            add=2
        [/set_variable]
        [fire_event]
            name=riders_off
        [/fire_event]
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [if]
            [variable]
                name=side_number
                equals=2
            [/variable]
            [variable]
                name=turn_number
                equals=$sadellon
            [/variable]
            [then]
                [unit]
                    type=Horseman
                    side=2
                    generate_name=yes
                    x,y=32,33
                [/unit]
                {MOVE_UNIT (x,y=32,33) 33 29}
                {MODIFY_UNIT (x,y=33,29) facing nw}
                [unit]
                    type=Horseman
                    side=2
                    generate_name=yes
                    x,y=32,33
                [/unit]
                {MOVE_UNIT (x,y=32,33) 33 30}
                {MODIFY_UNIT (x,y=33,30) facing nw}
                [unit]
                    type=Knight
                    side=2
                    generate_name=yes
                    x,y=32,33
                [/unit]
                {MOVE_UNIT (x,y=32,33) 33 31}
                {MODIFY_UNIT (x,y=33,31) facing nw}
                [unit]
                    type=Grand Knight
                    side=2
                    id=Sadellon
                    name= _ "Sir Sadellon"
                    x,y=32,33
                [/unit]
                {MOVE_UNIT (x,y=32,33) 33 32}
                {MODIFY_UNIT (x,y=33,32) facing nw}
                [unit]
                    type=Horseman
                    side=2
                    generate_name=yes
                    x,y=32,33
                [/unit]
                {MOVE_UNIT (x,y=32,33) 33 33}
                {MODIFY_UNIT (x,y=33,33) facing nw}
                [unit]
                    type=Horseman
                    side=2
                    generate_name=yes
                    x,y=32,33
                [/unit]
                [message]
                    speaker=Sadellon
                    message= _ "Lord Huric! We came as fast as we could!"
                [/message]
                # one of these should fire
                [message]
                    speaker=Huric
                    message= _ "Your help is greatly appreciated, Sir Sadellon, and comes none too soon. The rebels have gotten strong and are quite dangerous, we need to destroy them!"
                [/message]
                [message]
                    speaker=Huric_Horse
                    message= _ "Your help is greatly appreciated, Sir Sadellon, and comes none too soon. The rebels have gotten strong and are quite dangerous, we need to destroy them!"
                [/message]
                #
                [message]
                    speaker=Sadellon
                    message= _ "Yes, my lord!"
                [/message]
                [gold]
                    side=2
                    amount=100
                [/gold]
                [apply_gear]
                    id=Sadellon
                    gear_id=iron_armor
                [/apply_gear]
            [/then]
        [/if]
    [/event]

    [event]
        name=last_breath
        [filter]
            id=Huric_Horse
        [/filter]
        [message]
            speaker=unit
            message=_"Bah!  They've cut down my horse!  No matter..."
        [/message]
        [unstore_unit]
            variable=huric_tower
            find_vacant=no
            x,y=$x1,$y1
        [/unstore_unit]
        [message]
            speaker=Huric
            message=_"I'll just have to do this on my own!  Get right with whatever satanic gods you and your magicians worship, Lorenzon... I'm coming for you!"
        [/message]
    [/event]

    [event]
        name=time over
        [message]
            speaker=Huric
            message= _ "Ah, fresh troops have arrived..."
        [/message]
        [message]
            speaker=Lorenzon
            message= _ "This has spun out of control... Oh, why did I ever listen to that evil old man?"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]
