#textdomain wesnoth-Bad_Moon_Rising

# an idea to be implemented is that Carghanna is put aside with Hrala and Grat, while Belleros etc. explore the castle.
# will also need to double-check the mechanics of scenario, if player doesn't take book.

[scenario]
    id="2_04_Pond"
    name= _ "Mirror Pond"
    map_data="{~add-ons/Bad_Moon_Rising/maps/2_04_Pond3.map}"
    next_scenario=2_04_World
    victory_when_enemies_defeated=no
    {TURNS 44 40 36}

    [music]
        #	name="the_deep_path.ogg"
        name="nunc_dimittis.ogg"
    [/music]

    {BMR_FROST}
    #    {BMR_WINTER}
    {BMR_FIRST_WATCH}
#define BMR_BRAZIER X Y
    [terrain]
        x,y={X},{Y}
        terrain=Rrc^Bryb
    [/terrain]
#enddef
    {BMR_INIT_LUA}

#define BMR_VULTURE_RING
    x,y=23,17
#enddef
#define BMR_FROZEN_QUEEN
    x,y=4-16,1-9
#enddef
    {BMR_DESPAIR_BONES 42 17 2}
    {BMR_DESPAIR_BONES 4 16 2}
    {BMR_DESPAIR_BONES 10 18 2}
    {BMR_DESPAIR_BONES 42 3 2}

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Explore the Castle"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Belleros"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Hrala Gareth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Grat Gareth"
            [/objective]

            {TURNS_RUN_OUT}
            note= _ "This scenario should work, but is probably not balanced."
        [/objectives]
        [remove_shroud]
            x=1-44,1-11
            y=23-33,21-22
            side=1
        [/remove_shroud]
        {OBJ_POTION_DECAY 6 14 dec1}
        {OBJ_POTION_STRONG 7 15 str1}
        {OBJ_POTION_DECAY 8 15 dec2}
        {OBJ_POTION_STRONG 6 15 str2}
        {OBJ_POTION_POISON 5 15 psn1}
        [item]
            x=37
            y=16
            image="items/barrel.png"
        [/item]
        [item]
            x=12
            y=15
            image="items/barrel.png"
        [/item]
        [item]
            x=7
            y=18
            image="items/chest-plain-open.png"
        [/item]
        [item]
            x=32
            y=2
            image="units/huric-neutral.png~GS()"
        [/item]
        [item]
            x=25
            y=2
            image="units/despair/stone-alt.png~GS()"
        [/item]
        [item]
            x=28
            y=5
            image="units/despair/statue-alt.png~GS()"
        [/item]
        [item]
            x=28
            y=8
            image="units/despair/statue-alt.png~GS()"
        [/item]
        [item]
            x=35
            y=5
            image="units/despair/statue-alt.png~GS()"
        [/item]
        [item]
            x=35
            y=8
            image="units/despair/statue-alt.png~GS()"
        [/item]
        [item]
            x=36
            y=2
            image="units/despair/stone-alt.png~GS()"
        [/item]
        [item]
            x=29
            y=1
            image="units/despair/stone-alt.png~GS()"
        [/item]
        [item]
            x=20
            y=22
            image="scenery/snowbits.png"
        [/item]
        [item]
            x=18
            y=20
            image="scenery/snowbits.png"
        [/item]
        [item]
            x=15
            y=27
            image="scenery/snowbits.png"
        [/item]
        [item]
            x=6
            y=27
            image="scenery/snowbits.png"
        [/item]
        [item]
            x=8
            y=3
            image="misc/battleprincess-frozen.png"
        [/item]
        [item]
            x=6
            y=4
            image="misc/javelineer-frozen.png"
        [/item]
        [item]
            x=10
            y=5
            image="misc/spearman-frozen.png"
        [/item]
        [item]
            {BMR_VULTURE_RING}
            image="items/ring-silver.png"
        [/item]
        [item]
            x=16
            y=8
            image="misc/bookshelf-fullSW.png"
        [/item]
        [item]
            x=17
            y=11
            image="misc/chairSW.png"
        [/item]
        [item]
            x=16
            y=11
            image="items/book5.png"
        [/item]
#ifdef __UNUSED__
        [item]
            x=31
            y=2
            image="items/brazier.png"
        [/item]
        [item]
            x=33
            y=2
            image="items/brazier.png"
        [/item]
#endif
        [item]
            x=14
            y=8
            image="scenery/trash.png"
        [/item]
        #        [store_unit]
        #            [filter]
        #                id=Astreya
        #            [/filter]
        #            variable=astreya
        #            kill=yes
        #        [/store_unit]
        [store_unit]
            [filter]
                id=Huric
            [/filter]
            variable=huric
            kill=yes
        [/store_unit]
        [recall]
            id=Grat Gareth
        [/recall]
        [recall]
            id=Hrala Gareth
        [/recall]
        # recalling the skirmish group
        [store_unit]
            [filter]
                side=1
                x,y=recall,recall
            [/filter]
            variable=maybe_recall
            kill=no
        [/store_unit]
        {FOREACH maybe_recall ri}
            [if]
                [variable]
                    name=maybe_recall[$ri].variables.on_call
                    equals=yes
                [/variable]
                [then]
                    [recall]
                        id=$maybe_recall[$ri].id
                    [/recall]
                [/then]
            [/if]
        {NEXT ri}
        {CLEAR_VARIABLE maybe_recall}
        {MODIFY_UNIT side=3 status.petrified yes}
    [/event]

    [side]
        type=Ukian Subcommander
        id=Belleros
        name= _ "Belleros"
        profile="portraits/c_belleros.png"
        ellipse="misc/ellipse-hero"
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        fog=yes
        shroud=yes
        recruit=Ukian Runner, Ukian Regular, Ukian Archer, Ukian Dog
        {GOLD 250 200 150}
        {INCOME 6 5 4}
        team_name=good
        save_id=Lorenzon
    [/side]

    [side]
        type=Phantom King
        id=Huric
        name= _ "Huric"
        side=2
        canrecruit=yes
        controller=ai
        fog=no
#ifdef EASY
        recruit=Phantom Cloak, Phantom Spearman, Phantom Unease
#endif
#ifdef NORMAL
        recruit=Phantom Cloak, Phantom Spearman, Phantom Rider, Phantom Unease
#endif
#ifdef HARD
        recruit=Phantom Cloak, Phantom Spearman, Phantom Rider, Phantom Statue, Phantom Unease
#endif
        {GOLD 420 500 580}
        {INCOME 10 14 18}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
            {BMR_AI_TARGET (id=Belleros) 60}
            {BMR_AI_TARGET (side=1) 20}
            {BMR_VILLAGE_VALUE 0}
            {BMR_AI_LOCPROTECT (x,y=22-34,17-29) 50 1}
            #	aggression=0.8
            #	grouping=offensive
            #	    [target]
            #		id=C_Belleros
            #		value=500
            #	    [/target]
            #	    [protect_location]
            #		x=22-34
            #		y=17-29
            #		value=500
            #	    [/protect_location]
            #	caution=0.9
        [/ai]
        team_name=Phantom
    [/side]

    [side]
        no_leader=yes
        side=3
        controller=ai
        fog=no
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
            {BMR_AI_TARGET (side=2) 60}
            {BMR_AI_TARGET (side=1) 20}
            #	aggression=0.8
            #	grouping=offensive
            #	    [target]
            #		side=2
            #		value=500
            #	    [/target]
            #	    [target]
            #		side=1
            #		value=200
            #	    [/target]
            #	caution=0.8
        [/ai]
        team_name=Rogues
        [unit]
            type=Rogue
            generate_name=yes
            random_traits=yes
            halo=misc/rogue-frozen.png
            x,y=16,19
            facing=se
        [/unit]
        [unit]
            type=Bandit
            generate_name=yes
            random_traits=yes
            halo=misc/bandit-frozen.png
            x,y=22,15
            facing=se
        [/unit]
        [unit]
            type=Outlaw
            generate_name=yes
            random_traits=yes
            halo=misc/outlaw-frozen.png
            x,y=14,10
            facing=se
        [/unit]
        [unit]
            type=Rogue
            generate_name=yes
            random_traits=yes
            halo=misc/rogue-frozen.png
            x,y=29,20
            facing=se
        [/unit]
    [/side]

    [event]
        name=start
        [message]
            speaker=Belleros
            message = _ "What is this castle? These are not settled lands, and this is not orcish construction."
        [/message]
        [message]
            speaker=Grat Gareth
            message = _ "What is that supposed to mean? These lands don't need your type to be settled!"
        [/message]
        [message]
            speaker=Hrala Gareth
            message = _ "Calm down, Grat. There is something very wrong with this place, we shouldn't distract ourselves."
        [/message]
        [message]
            speaker=Belleros
            message = _ "This place may be cursed, or it may be a place of power. We need any edge we can get. We should investigate."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=15-17,21-23,28-30
            y=19-20,16,19-20
            [not]
                race=ukiandog
            [/not]
            [not]
                id=Belleros
            [/not]
        [/filter]
        [message]
            speaker=unit
            message = _ "These people are frozen... But there are relatively recent footprints trailing their feet."
        [/message]
        [message]
            speaker=Belleros
            message = _ "Frozen where they stand! I've heard of it in fairytales, but never seen it before. These may be the assistants of that merchant... Do they wear silver rings?"
        [/message]
        [message]
            speaker=unit
            message = _ "Aye, they do."
        [/message]
        [message]
            speaker=Belleros
            message = _ "Then they are criminals. Vultures, we used to call them. They pick the valuables off the dead, even if they have to exhume a corpse from its burial."
        [/message]
    [/event]

    #    [event]
    #	name=exit_hex
    #	[filter]
    #	id=Astreya
    #	y=16
    #	[/filter]
    #        [message]
    #            speaker=Belleros
    #            message = _ "Well, well.  Look who's here..."
    #        [/message]
    #    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            {BMR_VULTURE_RING}
            race=ukiandog
        [/filter]
        [message]
            speaker=unit
            message = _ "<i>(sniff, sniff... snort!)</i>"
        [/message]
    [/event]
    [event]
        name=moveto
        [filter]
            side=1
            x=16-25
            y=16-23
            race=ukiandog
        [/filter]
        [message]
            speaker=unit
            message = _ "<i>(sniff, sniff, sniff...)</i>"
        [/message]
    [/event]
    [event]
        name=moveto
        [filter]
            side=1
            {BMR_FROZEN_QUEEN}
            race=ukiandog
        [/filter]
        [message]
            speaker=unit
            message = _ "<i>(sniff, sniff... Grrr...)</i>"
        [/message]
    [/event]
    [event]
        name=moveto
        [filter]
            side=1
            x,y=32,2
            race=ukiandog
        [/filter]
        [message]
            speaker=unit
            message = _ "<i>(sniff, sniff... Grrr...)</i>"
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            {BMR_VULTURE_RING}
            [not]
                race=ukiandog
            [/not]
            [not]
                id=Belleros
            [/not]
        [/filter]
        [message]
            speaker=unit
            message = _ "A silver ring... (<i>$unit.name| raises the ring to the starlight for a better view.</i>)"
        [/message]
        [message]
            speaker=Belleros
            message = _ "I've seen rings like that before. Band of the Vultures. Do not wear it, it is a brand of shame, but do hold onto it - it will be proof to the mountebank that we found his men."
        [/message]
        [set_variable]
            name=stone_ring
            value=1
        [/set_variable]
        [remove_item]
            {BMR_VULTURE_RING}
            image="items/ring-silver.png"
        [/remove_item]
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=1
            [not]
                race=ukiandog
            [/not]
            x,y=28-34,13
        [/filter]
        [message]
            speaker=unit
            message = _ "This is some sort of great hall or throne-room..."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [not]
                race=ukiandog
            [/not]
            x,y=32,2
        [/filter]
        [message]
            speaker=unit
            message = _ "Here is a face I didn't think I would see again!  Is this place some sort of palace that Huric had hidden in the west?  To what end?"
        [/message]
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=1
            #            [not]
            #                id=Belleros
            #            [/not]
            [not]
                race=ukiandog
            [/not]
            x,y=16,6
            #            {BMR_FROZEN_QUEEN}
        [/filter]
        [if]
            [variable]
                name=unit.id
                not_equals=Belleros
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message = _ "There is a coldness in this room that is worse than that of the harsh winds of the tundra; it chills my soul...  There are figures in the frosty haze!"
                [/message]
                [message]
                    speaker=Belleros
                    message = _ "Be very careful!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Belleros
                    message = _ "There is a coldness in this room that is worse than that of the harsh winds of the tundra; it chills my soul...  There are figures in the frosty haze!"
                [/message]
            [/else]
        [/if]
        {MOVE_UNIT id=Belleros 14 5}
        [remove_shroud]
            side=1
            x,y=5-12,1-7
        [/remove_shroud]
        [redraw][/redraw]
        [scroll_to]
            x,y=6,4
        [/scroll_to]
        [delay]
            time=250
        [/delay]
        {MODIFY_UNIT (id=Belleros) facing nw}
        [message]
            speaker=Belleros
            message = _ "It looks like the Queen!  Queen Astreya!  This place must have something to do with the ghosts that have been hounding us!"
        [/message]
        [music]
            name=In_the_Land_of_Madness.ogg
            immediate=yes
            append=no
        [/music]
        [music]
            name=the_city_falls.ogg
            immediate=no
            append=yes
        [/music]
        [remove_item]
            x,y=31,2
        [/remove_item]
        {BMR_BRAZIER 31 2}
        [remove_item]
            x,y=33,2
        [/remove_item]
        {BMR_BRAZIER 33 2}
        [remove_shroud]
            side=1
            x,y=28-36,1-7
        [/remove_shroud]
        {CLEAR_FOG 1 32 3 4}
        [redraw][/redraw]
        [scroll_to]
            x,y=32,3
        [/scroll_to]
        [unstore_unit]
            variable=huric
        [/unstore_unit]
        [message]
            speaker=Huric
            message = _ "You once fought for me, Lorenzon. But now you have joined the madmen and would destroy this kingdom..."
        [/message]
        {MODIFY_UNIT (id=Belleros) facing ne}
        [message]
            speaker=Belleros
            message = _ "What?  Huric?"
        [/message]
        [message]
            speaker=Huric
            message = _ "... The sun will rise upon Ukiah again, and upon your bleached skulls!"
        [/message]
        [message]
            speaker=Belleros
            message = _ "Those words sound familiar..."
        [/message]
        [music]
            name=siege_of_laurelmor.ogg
            immediate=no
            append=yes
        [/music]
        [music]
            name=weight_of_revenge.ogg
            immediate=no
            append=yes
        [/music]
        [remove_item]
            x,y=25,2
        [/remove_item]
        [unit]
            type=Phantom Queen
            side=2
            id=Astreya
            name="Queen Astreya"
            random_traits=yes
            x,y=8,3
        [/unit]
        #        [message]
        #            speaker=Astreya
        #            message = _ "No one can take my beloved from me!  Not you, not that evil old man...  No one!"
        #        [/message]
        #        [message]
        #            speaker=Belleros
        #            message = _ "What evil old man?  What are you saying, Beloved Queen?  Do you refer to Minister Duval?  He-"
        #        [/message]
        #        [message]
        #            speaker=Astreya
        #            message = _ "No!  I refer to the lord of this castle himself, damn him...  It does not matter, for  I remember you, rebel, and how you killed my beloved...  Die!"
        #        [/message]
        [unit]
            side=2
            type=Phantom Stone
            x,y=25,2
        [/unit]
        [remove_item]
            x,y=28,5
        [/remove_item]
        [unit]
            side=2
            type=Phantom Statue
            x,y=28,5
        [/unit]
        [remove_item]
            x,y=28,8
        [/remove_item]
        [unit]
            side=2
            type=Phantom Statue
            x,y=28,8
        [/unit]
        [remove_item]
            x,y=35,5
        [/remove_item]
        [unit]
            side=2
            type=Phantom Statue
            x,y=35,5
        [/unit]
        [remove_item]
            x,y=35,8
        [/remove_item]
        [unit]
            side=2
            type=Phantom Statue
            x,y=35,8
        [/unit]
        [remove_item]
            x,y=36,2
        [/remove_item]
        [unit]
            side=2
            type=Phantom Stone
            x,y=36,2
        [/unit]
        [remove_item]
            x,y=29,1
        [/remove_item]
        [unit]
            side=2
            type=Phantom Stone
            x,y=29,1
        [/unit]
        [unit]
            side=2
            type=Phantom Soldier
            x,y=35,3
        [/unit]
        [unit]
            side=2
            type=Phantom Soldier
            x,y=29,3
        [/unit]
        [message]
            speaker=Belleros
            message = _ "This place is haunted, and I don't understand the ghosts. It was wrong to come here, we should leave."
        [/message]
        [terrain]
            terrain=Wog
            x=18,20,17-21,17-19,23
            y=21,21,22,23,23
        [/terrain]
        {UNCLEAR_FOG}
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Escape the Castle"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Belleros"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Hrala Gareth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Grat Gareth"
            [/objective]

            {TURNS_RUN_OUT}
        [/objectives]
        [set_variable]
            name=frost_gate
            value=2
        [/set_variable]
        # so no one can hid outside
        [if]
            [have_unit]
                y=23-33
                side=1
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        y=23-33
                        side=1
                    [/filter]
                    variable=MPO_store
                    kill=yes
                [/store_unit]
            [/then]
        [/if]
    [/event]

    # changing the 'frost_gate' counting:  It made no sense that the book could not be picked up before the player saw the entrance had changed.
    [event]
        name=moveto
        #        first_time_only=no
        [filter]
            side=1
            [not]
                race=ukiandog
            [/not]
            x,y=13-27,17-22
        [/filter]
        [filter_condition]
            [variable]
                name=frost_gate
                greater_than=1
            [/variable]
        [/filter_condition]
        [message]
            speaker=unit
            message= _ "The entrance is gone! The ice is melted!"
        [/message]
        #                [set_variable]
        #                    name=frost_gate
        #                    add=1
        #                [/set_variable]
        [message]
            speaker=Belleros
            message= _ "Looks like we have to face our ghosts..."
        [/message]
        #                [message]
        #                    speaker=Hrala Gareth
        #                    message= _ "Is there anything we can use in the cold room?"
        #                [/message]
        #                [message]
        #                    speaker=Belleros
        #                    message= _ "I really don't know, but let us re-examine it."
        #                [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [not]
                race=ukiandog
            [/not]
            x,y=16,11
        [/filter]
        [filter_condition]
            [variable]
                name=frost_gate
                equals=2
            [/variable]
        [/filter_condition]
        [message]
            speaker=unit
            message=_"The cover of this book is embossed with metal skulls, it looks quite sinister...  "
            [option]
                message=_"I'm not sure I have any business taking it, I'll just leave it be."
            [/option]
            [option]
                message=_"... But the ghosts are already trying to kill us, how could stealing this make things any worse?  It might be useful."
                [command]
                    [remove_item]
                        x,y=16,11
                    [/remove_item]
                    [unit_overlay]
                        x,y=$x1,$y1
                        image="items/book5.png"
                    [/unit_overlay]
                    [store_unit]
                        [filter]
                            x,y=$x1,$y1
                        [/filter]
                        variable=booker
                        kill=no
                    [/store_unit]
                    [message]
                        speaker=unit
                        message= _ "This book... Much of it is written in a language I don't understand... But not all of it. It is a notebook of someone named Malevan, he was doing some sort of research. This must be some of his doing."
                    [/message]
                    [message]
                        speaker=Belleros
                        message= _ "Hrm, what can we do about it? Let's take the book, it may have some answers about the ghosts."
                    [/message]
                    [message]
                        speaker=Grat Gareth
                        message= _ "Better if it had answers about how to get out of here."
                    [/message]
                    [set_variable]
                        name=frost_gate
                        add=1
                    [/set_variable]
                [/command]
            [/option]
        [/message]
    [/event]

    [event]
        name=new turn
        first_time_only=no
        [filter_condition]
            [variable]
                name=frost_gate
                greater_than=2
            [/variable]
        [/filter_condition]
        [switch]
            variable=frost_gate
            [case]
                value=3
                [set_variable]
                    name=frost_gate
                    add=1
                [/set_variable]
                [replace_map]
                    map="{~add-ons/Bad_Moon_Rising/maps/frost/frost1.map}"
                [/replace_map]
                [redraw][/redraw]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    message= _ "The air grew colder, and the frosty air began to spread..."
                [/message]
                [item]
                    halo=halo/holy/light-beam-[1~7].png~O(0.5):200
                    image=units/undead-necromancers/necromancer.png~O(0.7)
                    x,y=11,5
                [/item]
                [scroll_to]
                    x,y=11,5
                [/scroll_to]
                [message]
                    speaker=narrator
                    image=portraits/humans/necromancer.png~CS(-20,-15,25)~O(0.5)
                    message= _ "The fate of thieves..."
                [/message]
                [message]
                    speaker=Belleros
                    message= _ "This gets better and better."
                [/message]
                [remove_item]
                    halo=halo/holy/light-beam-[1~7].png~O(0.5):200
                    image=units/undead-necromancers/necromancer.png~O(0.7)
                    x,y=11,5
                [/remove_item]
            [/case]
            [case]
                value=4
                [set_variable]
                    name=frost_gate
                    add=1
                [/set_variable]
                [replace_map]
                    map="{~add-ons/Bad_Moon_Rising/maps/frost/frost2.map}"
                [/replace_map]
                [redraw][/redraw]
                [message]
                    speaker=Belleros
                    message= _ "The cursed frost is spreading."
                [/message]
                [message]
                    speaker=Grat Garreth
                    message= _ "All the more reason to find a way out of here"
                [/message]
            [/case]
            [case]
                value=5
                [set_variable]
                    name=frost_gate
                    add=1
                [/set_variable]
                [replace_map]
                    map="{~add-ons/Bad_Moon_Rising/maps/frost/frost3.map}"
                [/replace_map]
                [redraw][/redraw]
# what is this? Shoukd it be removed
#                [unstore_unit]
#                    variable=astreya
#                [/unstore_unit]
            [/case]
            [case]
                value=6
                [set_variable]
                    name=frost_gate
                    add=1
                [/set_variable]
                [replace_map]
                    map="{~add-ons/Bad_Moon_Rising/maps/frost/frost4.map}"
                [/replace_map]
                [redraw][/redraw]
            [/case]
            [case]
                value=7
                [set_variable]
                    name=frost_gate
                    add=1
                [/set_variable]
                [replace_map]
                    map="{~add-ons/Bad_Moon_Rising/maps/frost/frost5.map}"
                [/replace_map]
                [redraw][/redraw]
            [/case]
            [case]
                value=8
                [set_variable]
                    name=frost_gate
                    add=1
                [/set_variable]
                [replace_map]
                    map="{~add-ons/Bad_Moon_Rising/maps/frost/frost6.map}"
                [/replace_map]
                [redraw][/redraw]
            [/case]
            [case]
                value=9
                [set_variable]
                    name=frost_gate
                    add=1
                [/set_variable]
                [replace_map]
                    map="{~add-ons/Bad_Moon_Rising/maps/frost/frost7.map}"
                [/replace_map]
                [redraw][/redraw]
                [message]
                    speaker=Belleros
                    message= _ "We are caught in a trap, because we are presumed to be thieves.  What if we could prove we were not?"
                [/message]
                [message]
                    speaker=Grat Gareth
                    message= _ "How would we do that?"
                [/message]
            [/case]
            [case]
                value=10
                [set_variable]
                    name=frost_gate
                    add=1
                [/set_variable]
                [replace_map]
                    map="{~add-ons/Bad_Moon_Rising/maps/frost/frost8.map}"
                [/replace_map]
                [redraw][/redraw]
                [message]
                    speaker=Belleros
                    message= _ "There is an open chest near where the entrance was. I'm going to hope it is a kind of switch we can use to open the entrance again. Would returning the book there let us out?"
                [/message]
            [/case]
        [/switch]
    [/event]

    # 20140706 - this must have caused problems, if 'frost_gate' had to equal 11 for it to work.   Changing it to just anything over 7
    [event]
        name=moveto
        #        first_time_only=no
        [filter]
            id=$booker.id
            x,y=7,18
        [/filter]
        [filter_condition]
            [variable]
                name=frost_gate
                #                equals=11
                greater_than=7
            [/variable]
        [/filter_condition]
        [set_variable]
            name=frost_gate
            #                    add=1
            value=-5
        [/set_variable]
        [message]
            speaker=narrator
            message= _ "$booker.name placed the evil looking book into the open chest."
            image=wesnoth-icon.png
        [/message]
        [scroll_to]
            x,y=6,18
        [/scroll_to]
        [item]
            halo=halo/holy/light-beam-[1~7].png~O(0.5):200
            image=units/undead-necromancers/necromancer.png~O(0.7)
            x,y=6,18
        [/item]
	[delay]
	    time=200
	[/delay]
        [message]
            speaker=narrator
            image=portraits/humans/necromancer.png~CS(-20,-15,25)~O(0.5)
            message= _ "So, you are not thieves..."
        [/message]
        [message]
            speaker=Belleros
            message= _ "No, we are not!  Let us out!"
        [/message]
	[delay]
	    time=400
	[/delay]
        [remove_item]
            halo=halo/holy/light-beam-[1~7].png~O(0.5):200
            image=units/undead-necromancers/necromancer.png~O(0.7)
            x,y=6,18
        [/remove_item]
        [remove_unit_overlay]
            x,y=$x1,$y1
            image="items/book5.png"
        [/remove_unit_overlay]
    [/event]

    # 20140706- split this off into its own event, it could cause trouble if the player had moved all others before the book-carrier
    [event]
        name=new turn
        [filter_condition]
            [variable]
                name=frost_gate
                equals=-5
            [/variable]
        [/filter_condition]
        [replace_map]
            map="{~add-ons/Bad_Moon_Rising/maps/frost/frost9.map}"
        [/replace_map]
        [redraw][/redraw]
        [message]
            speaker=Grat Gareth
            message= _ "The frost has almost closed in on us."
        [/message]
        [message]
            speaker=Belleros
            message= _ "But the water is freezing over, we can escape."
        [/message]
        [scroll_to]
            x,y=19,23
        [/scroll_to]
        [delay]
            time=150
        [/delay]
        [message]
            speaker=Hrala Gareth
            message= _ "This will be cutting it close, some of us are not so quick on the ice."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Belleros
            y=26-33
        [/filter]
        [filter_condition]
            [variable]
                name=frost_gate
                equals=-5
            [/variable]
        [/filter_condition]
	[if]
	    [have_unit]
		side=1
		y=1-24
	    [/have_unit]
	    [then]
        [message]
            speaker=Belleros
            message= _ "Hurry out of that cursed palace, and let us be on our way!"
        [/message]
	    [/then]
	    [else]
        [message]
            speaker=Belleros
            message= _ "Glad to be rid of this place."
        [/message]
        [replace_map]
            map="{~add-ons/Bad_Moon_Rising/maps/frost/frost10.map}"
        [/replace_map]
        [redraw][/redraw]
        #                [scroll_to]
        #                    x,y=32,3
        #                [/scroll_to]
        [delay]
            time=150
        [/delay]
        [kill]
            side=2
            animate=no
        [/kill]
        [kill]
            side=3
            animate=no
        [/kill]
        [delay]
            time=150
        [/delay]
        [message]
            speaker=Grat Gareth
            message= _ "Can the ghosts be frozen?"
        [/message]
        [message]
            speaker=Belleros
            message= _ "I don't know...  Does anyone else hear something?"
        [/message]
        [message]
            speaker=narrator
            message= _ "There was a screech, then a series of loud cracks."
        [/message]
        {QUAKE "rumble.ogg"}
        [replace_map]
            map="{~add-ons/Bad_Moon_Rising/maps/frost/frost11.map}"
        [/replace_map]
        [remove_item]
            y=1-23
        [/remove_item]
        [redraw][/redraw]
        [message]
            speaker=Belleros
            message= _ "The castle has sunk...  Let's get away from here."
        [/message]
        [set_variable]
            name=huricdead
            value=0
        [/set_variable]
        [set_variable]
            name=despair_gift
            value=1
        [/set_variable]
        {CLEAR_VARIABLE frost_gate}
        [endlevel]
            {CONTINUE}
        [/endlevel]
	    [/else]
	[/if]
    [/event]

    [event]
        name=last_breath
        [filter]
            id=Astreya
        [/filter]
        [message]
            speaker=Belleros
            message=_ "What do we have to do to get you ghosts to leave us alone?!"
        [/message]
        [message]
            speaker=Astreya
            message=_ "There is nothing you can do, murderers.  We will haunt you for as long as you walk this earth..."
        [/message]
    [/event]
    [event]
        name=last_breath
        first_time_only=no
        [filter]
            id=Astreya
        [/filter]
        [teleport]
            [filter]
                id=Astreya
            [/filter]
            x,y=8,3
            animate=yes
        [/teleport]
        [heal_unit]
            [filter]
                id=Astreya
            [/filter]
            amount=full
        [/heal_unit]
    [/event]

    [event]
        name=last breath
        first_time_only=no
        [filter]
            id=Huric
        [/filter]
        [message]
            speaker=Huric
            message=_ "Uhhg, Ukiah falls... Many will die... Damn you, Lorenzon..."
        [/message]
        [store_unit]
            [filter]
                id=Huric
            [/filter]
            variable=king_huric
            kill=yes
            animate=yes
        [/store_unit]
        [set_variable]
            name=king_huric.hitpoints
            value=$king_huric.max_hitpoints
        [/set_variable]
        [unstore_unit]
            variable=king_huric
            x,y=32,2
        [/unstore_unit]
        [message]
            speaker=Huric
            message= _ "There will be no prisoners. This is it, traitors..."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Belleros
        [/filter]
        [message]
            speaker=unit
            message= _ "Uhghh..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=die
        [filter]
            id=Grat Gareth
        [/filter]
        [message]
            speaker=unit
            message= _ "Grah..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=die
        [filter]
            id=Hrala Gareth
        [/filter]
        [message]
            speaker=unit
            message= _ "Grah..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=time over
        [music]
            name=transience.ogg
            immediate=yes
        [/music]
        [message]
            speaker=Belleros
            message= _ "I'm afraid the cold is getting to me, I feel so tired..."
        [/message]
        [endlevel]
            result=defeat
            music=transience.ogg
        [/endlevel]
    [/event]
[/scenario]
