#textdomain wesnoth-Bad_Moon_Rising

# a gamble, where Belleros can try to escape becoming a Khthon, and determines enemy in next scenario:
# 1.  Any units recalled and killed will become Khthon in the next scenario.
# 2.  Any units not recalled will be Thralls.
# 3.  Any unit recalled, and that safely reaches the goal, can die in peace.
# if Belleros dies, he is Khthon Commander in next scenario.  If he reaches the SE corner, units on map get to die, and Raenna finds him catatonic in next scenario

[scenario]
    id="2_07_Control"
    name= _ "Death with Dignity"
    map_data="{~add-ons/Bad_Moon_Rising/maps/2_07_Control.map}"
    next_scenario=2_07_Volcano
    victory_when_enemies_defeated=no
    remove_from_carryover_on_defeat=no
    turns=-1
    [music]
        name="the_city_falls.ogg"
    [/music]

    [story]
        [part]
            story= _ "Belleros followed his lover Carghanna into the mountain cavern.  No, she was <i>not</i> his lover, she was <i>not</i> Carghanna...  It was not even human...  Belleros's mind felt fuzzy, it was difficult to think..."
            background="story/BMR_cave2.jpg"
        [/part]
        [part]
            story= _ "Belleros heard shouts behind him...
He turned to see his soldiers as they caught up with him and the monster.  The concern and apprehension on their faces caused something in Belleros's mind to click into place, and caused him to plant his feet firmly, and stop following the monster."
            background="story/dungeon.jpg"
        [/part]
        [part]
            story= _ "As he turned to square off against the beast that wore the face of Carghanna, he felt a pain in his side, and was blinded by a bright green light.  When his vision cleared, he was no longer in the cave..."
            background="story/dungeon.jpg~CS(-10,70,-10)"
        [/part]
    [/story]

    #    {BMR_DAYSHORT}

#define BMR_SHADOWDEATH_XY
    x=42-56,33-35,36-41,26-32,1-25,21-25,40-45,20-25,6-19,53-56
    y=26-49,33-49,31-49,35-49,42-49,36-37,26-32,38-42,38-41,23-25
#enddef

    [terrain_graphics]
        map="
*, *, *
, *, *,
*, 1, *
, *, *,
*, *, *"
        [tile]
            pos=1
            set_no_flag=shade
            type=Ss,G*,Hh,Mm
        [/tile]
        [image]
            position=horizontal
            layer=1000
            name=shadow/spark[1~9].png~O(0.5):[100*9],dawn.png~O(0.0):5000
        [/image]
        probability=15
    [/terrain_graphics]

    [time]
        id=bmr_spiritland
        name= _ "Spirit Land"
        image=misc/BMRschedule-spirit.png
        lawful_bonus=-5
        red=-90
        green=30
        blue=40
    [/time]
    # sometimes this works, sometimes it doesn't
    [time_area]
        {BMR_SHADOWDEATH_XY}
        [time]
            id=bmr_shadowofdeath1
            name= _ "Shadow of Death"
            image=misc/time-schedules/default/schedule-firstwatch.png
            lawful_bonus=-15
            red=-35
            green=-20
            blue=-10
        [/time]
    [/time_area]
    [time_area]
        x=40-56,26-39,1-25
        y=40-49,44-49,47-49
        [time]
            id=bmr_shadowofdeath2
            name= _ "Shadow of Death"
            image=misc/time-schedules/default/schedule-firstwatch.png
            lawful_bonus=-25
            red=-55
            green=-30
            blue=-20
        [/time]
    [/time_area]
    {BMR_INIT_LUA}

    [event]
        name=prestart
        [objectives]
            side=0
            [objective]
                condition=win
                description=_ "Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Belleros"
            [/objective]
        [/objectives]
        [item]
            x=19
            y=41
            image="scenery/rock2.png"
        [/item]
        # this needs more work, is there a way to not synchornize it?
        #	[item]
        #	    halo=halo/shadow_death[1~3].png:[200,200,200]
        #	    {BMR_SHADOWDEATH_XY}
        #	[/item]
        [store_unit]
            [filter]
                side=1
                canrecruit=yes
            [/filter]
            variable=oldleader
            kill=yes
        [/store_unit]
        #        [kill] # hope this helps clear up strange units showing up on the recall list
        #            side=1
        #        [/kill]
        [set_variable]
            name=c_belleros[0].x
            value=$oldleader.x
        [/set_variable]
        [set_variable]
            name=c_belleros[0].y
            value=$oldleader.y
        [/set_variable]
        [set_variable]
            name=c_belleros[0].hitpoints
            value=$c_belleros[0].max_hitpoints
        [/set_variable]
        [set_variable]
            name=c_belleros[0].moves
            value=$c_belleros[0].max_moves
        [/set_variable]
        [unstore_unit]
            variable=c_belleros[0]
        [/unstore_unit]
        {FOREACH side_one index}
            [set_variable]
                name=side_one[$index].hitpoints
                value=$side_one[$index].max_hitpoints
            [/set_variable]
            [set_variable]
                name=side_one[$index].x
                value=recall
            [/set_variable]
            [set_variable]
                name=side_one[$index].y
                value=recall
            [/set_variable]
            [unstore_unit]
                variable=side_one[$index]
                find_vacant=no
            [/unstore_unit]
        {NEXT index}
        {CLEAR_VARIABLE side_one}
    [/event]

    #    {STARTING_VILLAGES 1 5}
    #    {STARTING_VILLAGES 2 6}

    [side]
        type=Ukian Subcommander
        id=Belleros
        name=  "Belleros"
        profile="portraits/c_belleros.png"
        #        ellipse="misc/ellipse-hero"
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        fog=no
        recall_cost=10
        recruit=
        # generous with the gold because "economy" here is more frustration than strategy
        {GOLD 300 250 200}
        {INCOME 21 15 9}
        team_name=good
        save_id=Lorenzon
    [/side]

    [side]
        type=Khalkotaurus
        id=Ker_Ron
        name=  "Ker-Ron"
        [modifications]
            #            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        unrenamable=yes
        side=2
        canrecruit=yes
        controller=ai
        fog=no
        recruit=Ophis, Prokyon, Pyradalon, Flying Toad, Taraxippon
        {GOLD 150 200 250}
        {INCOME 4 6 8}
        team_name=bad
        [ai]
            [avoid]
                terrain=Wwby,Wrby,Dby
            [/avoid]
        [/ai]
    [/side]

    [side]
        type=Royal_Beast
        id=Arrun
        name=  "Arrun"
        [modifications]
            #            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        unrenamable=yes
        side=3
        canrecruit=yes
        controller=ai
        fog=no
        recruit=Rockback,Katoblepon,Timber Wolf,Toad,Horse
        {GOLD 150 200 250}
        {INCOME 4 6 8}
        team_name=bad
        [ai]
            [avoid]
                terrain=Wwby,Wrby,Dby
            [/avoid]
        [/ai]
    [/side]

    [side]
        type=Highwayman
        id=Tommyn
        name=  "Big Tommyn"
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        [ai]
            passive_leader=yes
            [aspect]
                id=recruitment
                [facet]
                    [value]
                        name=ai_default::recruitment
                        [limit]
                            type=Trapper
                            max=2
                        [/limit]
                        [limit]
                            type=Outlaw
                            max=1
                        [/limit]
                        [limit]
                            type=Bandit
                            max=1
                        [/limit]
                        [limit]
                            type=Rogue
                            max=2
                        [/limit]
                        [limit]
                            type=Fugitive
                            max=1
                        [/limit]
                    [/value]
                [/facet]
            [/aspect]
        [/ai]
        facing=sw
        unrenamable=yes
        side=4
        canrecruit=yes
        controller=ai
        fog=no
        recruit=Trapper,Outlaw,Rogue,Bandit,Trapper,Thug,Thief,Footpad,Fugitive
        {GOLD 170 220 270}
        {INCOME 4 6 8}
        team_name=good
    [/side]

    [side]
        type=General
        id=Herythern
        name= _ "General"+" Herythern"
        [modifications]
            {TRAIT_QUICK}
            {TRAIT_RESILIENT}
        [/modifications]
        facing=sw
        unrenamable=yes
        side=5
        canrecruit=yes
        controller=ai
        fog=no
        recruit=Pikeman,Knight,Longbowman,Shock Trooper,Spearman,Cavalryman,Halberdier,Northern Fighter
        [ai]
            passive_leader=yes
            [aspect]
                id=recruitment
                [facet]
                    [value]
                        name=ai_default::recruitment
                        [limit]
                            type=Pikeman
                            max=2
                        [/limit]
                        [limit]
                            type=Knight
                            max=1
                        [/limit]
                        [limit]
                            type=Shock Trooper
                            max=1
                        [/limit]
                        [limit]
                            type=Longbowman
                            max=2
                        [/limit]
                        [limit]
                            type=Halberdier
                            max=1
                        [/limit]
                    [/value]
                [/facet]
            [/aspect]
        [/ai]
        {GOLD 160 210 260}
        {INCOME 6 8 10}
        team_name=good
    [/side]

    [side]
        type=Orcish Warlord
        id=Garkhan
        name= "Garkhan Skoro"
        [modifications]
            {TRAIT_QUICK}
            {TRAIT_RESILIENT}
        [/modifications]
        facing=sw
        unrenamable=yes
        side=6
        canrecruit=yes
        controller=ai
        fog=no
        recruit=Orcish Warrior,Orcish Crossbowman,Orcish Raider,Orcish Cavalry,Orcish Vagrant,Orcish Assassin,Wolf Rider,Orcish Overseer,Orcish Serf
        [ai]
            [aspect]
                id=recruitment
                [facet]
                    [value]
                        name=ai_default::recruitment
                        [limit]
                            type=Orcish Warrior
                            max=2
                        [/limit]
                        [limit]
                            type=Orcish Raider
                            max=1
                        [/limit]
                        [limit]
                            type=Orcish Cavalry
                            max=1
                        [/limit]
                        [limit]
                            type=Orcish Crossbowman
                            max=2
                        [/limit]
                        [limit]
                            type=Orcish Overseer
                            max=1
                        [/limit]
                    [/value]
                [/facet]
            [/aspect]
        [/ai]
        {GOLD 150 200 250}
        {INCOME 8 10 12}
        team_name=good
    [/side]

    [side]
        no_leader=yes
        side=7
        controller=ai
        team_name=bad
        [ai]
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=9
            [/goal]
            [avoid]
                terrain=Wwby,Wrby,Dby
            [/avoid]
        [/ai]
    [/side]

#define BMR_EM_KHTHON FILTER
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=BEM_temp
        kill=no
    [/store_unit]
    [set_variable]
        name=BEM_temp.name
        rand=Achralon,Aericon,Barbaroomon,Charbom,Chrysolom,Echarroom,Lillinaron,Memnamases,Nesseron,Ochidamon,Orononos,Sephradom,Terrazom
    [/set_variable]
    [set_variable]
        name=BEM_temp.race
        value=khthon
    [/set_variable]
    [set_variable]
        name=BEM_temp.alignment
        value=chaotic
    [/set_variable]
    [set_variable]
        name=BEM_temp.hitpoints
        value=$BEM_temp.max_hitpoints
    [/set_variable]
    [set_variable]
        name=BEM_temp.moves
        value=0
    [/set_variable]
    [unstore_unit]
        variable=BEM_temp
        red,green,blue=0,200,150
        text= _ "possessed"
        find_vacant=no
    [/unstore_unit]
    [object]
        silent=yes
        duration=forever
        [filter]
            {FILTER}
        [/filter]
        [effect]
            apply_to=attack
            range=melee
            increase_damage=20%
        [/effect]
        [effect]
            apply_to=resistance
            replace=false
            [resistance]
                cold=-30
                arcane=30
            [/resistance]
        [/effect]
        [effect]
            apply_to=max_experience
            increase=10
        [/effect]
        [effect]
            apply_to=halo
            halo=halo/deathglow.png
        [/effect]
        [effect]
            apply_to=image_mod
            replace="CS(-150,35,15)"
        [/effect]
    [/object]
    [modify_unit]
        [filter]
            {FILTER}
        [/filter]
        #        [modifications] # is this needed? nope
        {ARCHAIC_TRAIT_ENTHRALL}
        #        [/modifications]
    [/modify_unit]
    [modify_side]
        side=$BEM_temp.side
        team_name=bad
    [/modify_side]
    {ARCHAIC_KHTHONIZED (
        side=$BEM_temp.side
        [not]
            id=$BEM_temp.id
        [/not]
    )}
    [gold]
        side=$BEM_temp.side
        amount=220
    [/gold]
#    {ARCHAIC_KHTHON_RECRUITS (side=$|BEM_temp.side)} # check this -> it is wrong, probably did not need the pipe.
#    It's already specified outside of macro anyways
    {CLEAR_VARIABLE BEM_temp}
    [set_variable]
        name=r_k
        rand=KatobleponMagnum,OphisMagnum,Orthrus,Ipoten,Rockback
    [/set_variable]
    [unit]
        side=7
        x,y=1,1
        type=$r_k
    [/unit]
    {CLEAR_VARIABLE r_k}
    [set_variable]
        name=r_k
        rand=KatobleponMagnum,OphisMagnum,Orthrus,Ipoten,Ophis
    [/set_variable]
    [unit]
        side=7
        x,y=7,1
        type=$r_k
    [/unit]
    {CLEAR_VARIABLE r_k}
    [set_variable]
        name=r_k
        rand=KatobleponMagnum,OphisMagnum,Orthrus,Ipoten,Pyradalon
    [/set_variable]
    [unit]
        side=7
        x,y=14,1
        type=$r_k
    [/unit]
    {CLEAR_VARIABLE r_k}
    [set_variable]
        name=r_k
        rand=KatobleponMagnum,OphisMagnum,Orthrus,Nightmare,Noble_Beast
    [/set_variable]
    [unit]
        side=7
        x,y=1,19
        type=$r_k
    [/unit]
    {CLEAR_VARIABLE r_k}

#enddef

    [event]
        name=start
        [music]
            name=wanderer.ogg
            append=no
            immediate=yes
        [/music]
        [set_recruit]
            side=1
            recruit=""
        [/set_recruit]
        {MOVE_UNIT (id=Belleros) 13 7}
        {MODIFY_UNIT (id=Belleros) facing sw}
        [delay]
            time=150
        [/delay]
        {MODIFY_UNIT (id=Belleros) facing se}
        [delay]
            time=150
        [/delay]
        {MODIFY_UNIT (id=Belleros) facing sw}
        [delay]
            time=150
        [/delay]
        {MODIFY_UNIT (id=Belleros) facing se}
        [message]
            speaker=Belleros
            message=_"Where am I ..."
        [/message]
        {MOVE_UNIT (id=Belleros) 16 9}
        [unit]
            type=Ukian Witch
            side=7
            name="Carghanna"
            id=Echidna
            profile=portraits/carghanna.png
            x,y=1,1
            facing=se
        [/unit]
        [message]
            speaker=Belleros
            message=_"This statue is just like the things on Mt. Tien, where-"
        [/message]
        [message]
            speaker=Echidna
            message=_"Where you offered me as a sacrifice to the Khthonic gods..."
        [/message]
        {MODIFY_UNIT (id=Belleros) facing nw}
        [message]
            speaker=Belleros
            message=_"Carghanna!  I'd never offer you as a sacrifice!  I don't even know what a Khthonic god is!  You were dying from a poison and-"
        [/message]
        [message]
            speaker=Echidna
            message=_"Hush, Belleros, I'm not angry.  I know you meant well.  And after all ..."
        [/message]
        {MOVE_UNIT (id=Echidna) 2 1}
        [message]
            speaker=Echidna
            message=_"... if you hadn't done what you did..."
        [/message]
        [music]
            #            name=gathering_storm.ogg
            name=vengeful.ogg
            append=no
            immediate=yes
        [/music]
        {MOVE_UNIT (id=Echidna) 3 2}
        {TRANSFORM_UNIT (id=Echidna) Echidna_Monster}
        {MODIFY_UNIT (id=Echidna) name Echidna}
        {MODIFY_UNIT (id=Echidna) profile "portraits/echidna.png"}
        {FULL_HEAL (id=Echidna)}
        [message]
            speaker=Echidna
            message=_"I'd still be trapped in that cursed mountain!  I don't know whether it was latent gratitude or some lingering thoughts from your girlfriend, but I failed to deliver you properly to one of my children.
        So here we are, in a land of the mind and spirit."
        [/message]
        [message]
            speaker=Belleros
            message=_"Seems real enough to me!"
        [/message]
        [message]
            speaker=Echidna
            message=_"It looks the way it does because it is the only way your mind can make sense of it.  But make no mistake, you have left the land of the living behind.  And since time does not pass here, I can afford to be charitable."
        [/message]
        [message]
            speaker=Belleros
            message=_"What would a monster like you know of charity?"
        [/message]
        [message]
            speaker=Echidna
            message=_"You are at a fork in the road, Belleros, and as you go, others shall follow..."
        [/message]
        [store_unit]
            [filter]
                id=Echidna
            [/filter]
            variable=echidna
            kill=yes
        [/store_unit]
        [recall]
            side=1
            race=ukian
            level=1
            x,y=1,7
        [/recall]
        [recall]
            side=1
            race=ukian
            x,y=1,12
        [/recall]
        [recall]
            side=1
            race=ukian
            x,y=16,1
        [/recall]
        [recall]
            side=1
            race=ukian
            x,y=17,1
        [/recall]
        [message]
            x,y=16,1
            message=_"Commander Belleros!"
        [/message]
        [message]
            speaker=Belleros
            message=_"Come Ukians!  We need to gain a rally point!  This fork-tongued daemon toys with us, but we shall not go down without a fight!"
        [/message]
        [message]
            speaker=Herythern
            message=_"That's the spirit!  Stranger, though you wear the colored cloth bands of the rebels who destroyed our kingdom, I see you are at least a man like me, and in this land of daemons, we need to stick together."
        [/message]
        [message]
            speaker=Tommyn
            message=_"Similarly, though we, uh, working folk normally despise the likes of either of you soldier types, I agree that we need to unite to fight these monsters."
        [/message]
        [message]
            speaker=Garkhan
            message=_"<i>Grrr...</i>  I recognize you people...
        Not that long ago, I would have gladly ripped the flesh off of every last one of you.  But since then, I have seen my people fall to blue-skinned daemons and green-eyed monsters.  We unite with you humans, to fight these nightmares!"
        [/message]
        {MODIFY_UNIT (id=Belleros) facing se}
        [message]
            speaker=Belleros
            message=_"We've had our differences, but that was then and this is now.  I offer my thanks and support, we are brothers-in-arms!  Let us form a united front!"
        [/message]
        #        [message]
        #            speaker=Echidna
        #            message=_"<i>(Hahaha...)</i>"
        #        [/message]
        [music]
            name=knolls.ogg
            immediate=no # this does not work 20140727
            append=no
        [/music]
        ###################################################
        # this is temporary, to deal with [disable] AI bug
        # 20170611- I think this can be removed now...
        ###################################################
        #	[message]
        #	    speaker=narrator
        #	    image=icons/profiles/chaotic.png~SCALE_SHARP(400,400)
        #	    message=_"Author's Note:  There is an engine bug that allows the Khthon AI to use Vector attack even when it is disabled, which makes this scenario almost impossible to win, so I will now make Vector attacks always miss if the AI is the attacker (but not the defender).  This should be fixed in BfW 1.13.6 or later.  If you are reading this in BfW 1.13.6 or later, it means I need to update, feel free to send me a reminder at https://forums.wesnoth.org."
        #	[/message]
        #	{FORCE_CHANCE_TO_HIT (side=2,3,4,5,6,7) (side=1,4,5,6) 0 (
        #	    [variable]
        #		name=weapon.name
        #		equals=khthon_vector
        #	    [/variable]
        #	)}
        ###################################################
    [/event]

    # testing ... seems to work
#ifdef __UNUSED__
    [event]
        name=turn 2
        {ARCHAIC_KHTHONIZED (
            side=4
            [not]
                id=Tommyn
            [/not]
        )}
        {ARCHAIC_KHTHON_RECRUITS (side=4)}
    [/event]
#endif

    [event]
        name=moveto
        [filter]
            side=1
            x,y=47,15
            [not]
                race=ukiandog
            [/not]
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    id=Herythern
                    race=human
                [/have_unit]
            [/not]
        [/filter_condition]
        [message]
            speaker=unit
            message=_"The General seems to have been keeping a stash of his own."
        [/message]
        [message]
            speaker=Belleros
            message=_"Well, it's ours now.  How much?"
        [/message]
        [message]
            speaker=unit
            message=_"Looks like 117g."
        [/message]
        [gold]
            amount=117
            side=1
        [/gold]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Belleros
            x,y=36,26
        [/filter]
        [message]
            speaker=Belleros
            message=_"Aha!  Thieves to the very end, the Vultures were hiding a stash of 180 gold ..."
        [/message]
        [message]
            side=1
            message=_"But what good is gold to us here, in this strange land?"
        [/message]
        [message]
            speaker=Belleros
            message=_"Hrmm...  Indeed, gold would be pretty useless here...  But it's not gold, it's just something that represents whatever we need to bring our comrades to battle, and whatever it is, we have more of it!"
        [/message]
        [gold]
            amount=180
            side=1
        [/gold]
    [/event]

    [event]
        name=die
        [filter]
            id=Arrun
        [/filter]
        [set_variable] # this is inelegant, but it'll do for now
            name=trigger1
            value=yes
        [/set_variable]
        [set_variable]
            name=r_k
            rand=KatobleponMagnum,OphisMagnum,Orthrus,Nightmare,Noble_Beast
        [/set_variable]
        [unit]
            side=7
            x,y=1,19
            type=$r_k
        [/unit]
        {CLEAR_VARIABLE r_k}
    [/event]

    [event]
        name=turn 9
        [set_variable]
            name=r_k
            rand=KatobleponMagnum,OphisMagnum,Orthrus,Nightmare,Nightmare
        [/set_variable]
        [unit]
            side=7
            x,y=5,1
            type=$r_k
        [/unit]
        {CLEAR_VARIABLE r_k}
        [set_variable]
            name=r_k
            rand=KatobleponMagnum,OphisMagnum,Orthrus,Nightmare,Pyradalon
        [/set_variable]
        [unit]
            side=7
            x,y=55,1
            type=$r_k
        [/unit]
        {CLEAR_VARIABLE r_k}
    [/event]

    [event]
        name=turn 15
        [set_variable]
            name=r_k
            rand=KatobleponMagnum,OphisMagnum,Orthrus,Nightmare,Nightmare
        [/set_variable]
        [unit]
            side=7
            x,y=5,1
            type=$r_k
        [/unit]
        {CLEAR_VARIABLE r_k}
        [set_variable]
            name=r_k
            rand=KatobleponMagnum,OphisMagnum,Orthrus,Nightmare,Pyradalon
        [/set_variable]
        [unit]
            side=7
            x,y=55,1
            type=$r_k
        [/unit]
        {CLEAR_VARIABLE r_k}
    [/event]

    [event]
        name=new turn
        [filter_condition]
            [have_unit]
                side=1
                y=26-49
            [/have_unit]
            [not]
                [have_unit]
                    id=Arrun
                [/have_unit]
                [variable]
                    name=trigger1
                    equals=yes
                [/variable]
            [/not]
        [/filter_condition]
        [message]
            speaker=Herythern
            message=_"A thought has occured to me, Rebel Commander!  If the deceitfulness of the Vultures caused them to fall, surely the orcs will soon be against us as well.  We should prepare ourselves..."
        [/message]
        [message]
            speaker=Garkhan
            message=_"<i>No, Shiny General, you are the deceitful one!</i>  Think about it, Rebel Commander, we orcs have been hostile, but have we ever been deceitful?"
        [/message]
        [unstore_unit]
            variable=echidna
        [/unstore_unit]
        {MOVE_UNIT (id=Echidna) 47 14}
        [scroll_to]
            x,y=51,14
        [/scroll_to]
        [message]
            speaker=Herythern
            message=_"<i>Daemon!</i>"
        [/message]
        [animate_unit]
            flag=echidna_conversion
            [filter]
                id=Echidna
            [/filter]
            [facing]
                x,y=47,15
            [/facing]
        [/animate_unit]
        {BMR_EM_KHTHON (id=Herythern)}
        [allow_recruit]
            side=5
            type=Northern Fighter,Bowman
        [/allow_recruit]
        {ARCHAIC_KHTHON_RECRUITS (side=5)}
        {MOVE_UNIT (id=Echidna) 56 20} #########################
        [store_unit]
            [filter]
                id=Echidna
            [/filter]
            variable=echidna
            kill=yes
        [/store_unit]
        [message]
            speaker=Belleros
            message=_"This just gets better and better..."
        [/message]
        [message]
            speaker=Garkhan
            message=_"Don't get distracted, ...  The daemons play games with us, we cannot defeat them, I see that now...
We orcs have long had visions of the black-water river to the southeast, it is the cleansing of death.   Nothing is permanent, you pass on what you can, but ..."
        [/message]
        [message]
            speaker=Belleros
            message=_"There are fates worse than death, I suppose..."
        [/message]
        [message]
            speaker=Garkhan
            message=_"Yes, there are.  Our souls belong over there, human, across the black river.  Over there, we can return to our ancestors..."
        [/message]
        {MODIFY_UNIT (id=Belleros) facing se}
        [message]
            speaker=Belleros
            message=_"Hrmmm ...  (If it is but an illusion, a trap, then we have already lost.  It is our only chance.)  I understand and I agree, Skoro, let us head to that other shore."
        [/message]
        {MODIFY_UNIT (id=Belleros) facing nw}
        [message]
            speaker=Belleros
            message=_"Ukians!  Our victory on this battle-field is judged by a strange metric, but it is the fate we've been dealt.  Fight to cross the grim river!"
        [/message]
        [gold]
            side=6
            amount=90
        [/gold]
        {MODIFY_AI_ADD_GOAL 6 (
            [goal]
                name=target_location
                [criteria]
                    x,y=56,49
                [/criteria]
                value=9
            [/goal]
        )}
        # can you make this dynamic?  Where he follows Belleros around?
        # OK, now see if it works
        [store_unit]
            [filter]
                id=Belleros
            [/filter]
            variable=belleros
            kill=no
        [/store_unit]
        {MODIFY_AI_ADD_ASPECT 6 leader_goal (
            [facet]
                id=always
                [value]
                    x=$belleros.x
                    y=$belleros.y
                [/value]
            [/facet]
        )}
        {CLEAR_VARIABLE belleros}
        [event]
            name=side 6 turn
            first_time_only=no
            [store_unit]
                [filter]
                    id=Belleros
                [/filter]
                variable=belleros
                kill=no
            [/store_unit]
            {MODIFY_AI_ADD_ASPECT 6 leader_goal (
                [facet]
                    id=always
                    [value]
                        x=$belleros.x
                        y=$belleros.y
                    [/value]
                [/facet]
            )}
            {CLEAR_VARIABLE belleros}
        [/event]
        [objectives]
            side=0
            [objective]
                condition=win
                description=_ "Get as many Ukians to the far shore of the black river as possible"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Belleros"
            [/objective]
            note=_"Ukians that reach the far shore, or who are at least on the map when Belleros crosses the river, will escape becoming pawns for Echidna.  Units left on the recall list do not escape."
        [/objectives]
    [/event]

    # need to have this below the previous event because we clear trigger1 - is this really needed?
    # problem is, we don't want these two events to tirgger on the same turn.
    [event]
        name=new turn
        [filter_condition]
            [variable]
                name=trigger1
                equals=yes
            [/variable]
        [/filter_condition]
        {CLEAR_VARIABLE trigger1}
        [unstore_unit]
            variable=echidna
        [/unstore_unit]
        {MOVE_UNIT (id=Echidna) 36 25}
        [scroll_to]
            x,y=36,27
        [/scroll_to]
        [music]
            name=siege_of_laurelmor.ogg
            immediate=no
            append=no
        [/music]
        [animate_unit]
            flag=echidna_conversion
            [filter]
                id=Echidna
            [/filter]
            [facing]
                x,y=36,26
            [/facing]
        [/animate_unit]
        {BMR_EM_KHTHON (id=Tommyn)}
        {ARCHAIC_KHTHON_RECRUITS (side=4)}
        [message]
            speaker=Belleros
            message=_"That doesn't look good..."
        [/message]
        [message]
            speaker=Echidna
            message=_"Why do you say that?  It's quite a good thing."
        [/message]
        {MOVE_UNIT (id=Echidna) 56 20}
        [store_unit]
            [filter]
                id=Echidna
            [/filter]
            variable=echidna
            kill=yes
        [/store_unit]
        [message]
            speaker=Herythern
            message=_"Hrmm...  He was one of the Vultures, I know you know what that means, Rebel Commander."
        [/message]
        [message]
            speaker=Belleros
            message=_"Yes, I do...  He no doubt thought to worm his way out of our alliance, and was struck down for his weakness."
        [/message]
        [message]
            speaker=Garkhan
            message=_"So let us stand strong!"
        [/message]
    [/event]

    # need to make a death event for this guy, or at least a catch-all for if he dies.
    # done, I think.
    [event]
        name=enter_hex
        [filter]
            id=Garkhan
            [filter_location]
                terrain=Dby,Uu,Urb
            [/filter_location]
        [/filter]
        [unstore_unit]
            variable=echidna
            x,y=56,17
        [/unstore_unit]
        [set_variable]
            name=unit_y
            value=$unit.y
        [/set_variable]
        [set_variable]
            name=unit_y
            add=-1
        [/set_variable]
        {MOVE_UNIT (id=Echidna) $unit.x $unit_y}
        [scroll_to]
            x,y=45,29
        [/scroll_to]
        [message]
            speaker=Echidna
            message=_"Where do you think you're going, orc?"
        [/message]
        [animate_unit]
            flag=echidna_conversion
            [filter]
                id=Echidna
            [/filter]
            [facing]
                x,y=$unit.x,$unit.y
            [/facing]
        [/animate_unit]
        {BMR_EM_KHTHON (id=Garkhan)}
        {ARCHAIC_KHTHON_RECRUITS (side=6)}
        {CLEAR_AI_ALWAYS_ASPECT_LEADER_GOAL 6}
        {MODIFY_AI_ADD_ASPECT 6 leader_goal (
            [facet]
                id=always
                [value]
                    x=36
                    y=26
                [/value]
            [/facet]
        )}
        {MOVE_UNIT (id=Echidna) 43 20}
        [fire_event]
            name=last_echidna_show
        [/fire_event]
    [/event]

    # this is a fallback...  Orc leader is killed before he gets to the river
    [event]
        name=last breath
        [filter]
            id=Garkhan
            race=orc
        [/filter]
        [message]
            speaker=Garkhan
            message=_"Argh!  What does it mean, to fall in this land of madness..."
        [/message]
        [message]
            speaker=Belleros
            message=_"<i>(I think I would rather not find out.)</i>"
        [/message]
        [unstore_unit]
            variable=echidna
            x,y=56,17
        [/unstore_unit]
        [fire_event]
            name=last_echidna_show
        [/fire_event]
    [/event]

    [event]
        name=last_echidna_show
        [message]
            speaker=Echidna
            message=_"Joining my bretheren isn't the horror you seem to think it is, Belleros...  You know what will happen if you cross over into that far shore.  Why not consider the alternative?"
        [/message]
        [message]
            speaker=Belleros
            message=_"<i>(I'm not going to dignify that with a response.)</i>"
        [/message]
        [music]
            name=gathering_storm.ogg
            immediate=yes
            append=yes
        [/music]
        [message]
            speaker=Echidna
            message=_"Well, if you're not going to be reasonable, there's not much more to say.  But any who fall now shall now be blessed to become one of us."
        [/message]
        [event]
            name=last_breath
            first_time_only=no
            [filter]
                side=1
                [not]
                    canrecruit=yes
                [/not]
            [/filter]
            #            [filter_second]
            #                race=khthon
            #            [/filter_second]
            {ARCHAIC_KHTHONIZE_MAJOR (x,y=$x1,$y1)}
            [store_unit]
                [filter]
                    id=$unit.id
                [/filter]
                kill=yes
                variable=khthon_ukian
                mode=append
            [/store_unit]
            [floating_text]
                x,y=20,20
                text="<span color='#88cc99'>" + _ "Claimed!" + "</span>"
            [/floating_text]
        [/event]
    [/event]

    #######################
    # end scenario events:  If Belleros dies, the Ukians on the map and on the recall list become Khthon.  If he makes it to the river, only the recall list becomes khthon.
    ######################

    [event]
        name=last breath
        [filter]
            id=Belleros
        [/filter]
        [message]
            speaker=Belleros
            message=_"No...  I must not fall, out here, with the daemons..."
        [/message]
        {FADE_TO_BLACK}
        [center_message]
            image="misc/skull.png~CS(-24,40,-24)"
            message="Before the light could fade from Belleros' eyes, before he could exhale his last breath, his dying mind was wrapped in a green haze, and he felt an invasive presence.  A fleeting thought of despair was the final thing Belleros could claim as his own."
        [/center_message]
        [center_message]
            message="The Khthon have claimed Belleros and his Ukian followers, and shall use them in the battle in the volcano cave."
        [/center_message]
        {ARCHAIC_KHTHONIZE_MAJOR (id=Belleros)}
        [heal_unit]
            [filter]
                id=Belleros
            [/filter]
        [/heal_unit]
        [store_unit] # just in case...
            [filter]
                id=Belleros
            [/filter]
            variable=belleros_backup
            kill=no
        [/store_unit]
        {ARCHAIC_KHTHONIZE_MAJOR (
            side=1
            x,y=1-56,1-49
            [not]
                id=Belleros
            [/not]
        )}
        [redraw][/redraw]
        {ARCHAIC_KHTHONIZED (
            side=1
            x,y=recall,recall
        )}

        # the units were made Khthon, but then were not available in next scenario.  Does this fix it?
        {PUT_TO_RECALL_LIST (
            side=1
            [not]
                id=Belleros
            [/not]
        )}

        # placing the fallen Ukians, now Khthon, back on the recall list
        {FOREACH khthon_ukian i}
            [unstore_unit]
                variable=khthon_ukian[$i]
                x,y=recall,recall
                find_vacant=no
            [/unstore_unit]
        {NEXT i}
        [set_variable]
            name=khthon_ukians
            value=yes
        [/set_variable]
        [endlevel]
            {CONTINUE}
            replay_save=no
        [/endlevel]
    [/event]

#define BMR_SAFE_SHADOW_XY
    x=56,55-56,54,54,52-53,51-56,50-51,48-49,44-47,42-43,40-44,32-55,38-46
    y=34,35-44,37,40-44,42-44,45-49,46-49,47-49,48-49,49,45-49,48-49,46-47
#enddef

    [event]
        name=moveto
        [filter]
            id=Belleros
            {BMR_SAFE_SHADOW_XY}
        [/filter]
        [music]
            name=northern_mountains.ogg
            immediate=yes
            append=no
        [/music]
        [message]
            speaker=Echidna
            message=_"No, Belleros, that is the wrong choice!  You are fleeing to a sure death!"
        [/message]
        [message]
            speaker=Belleros
            message=_"I've made it.  This is not how I wanted it to end, but 'tis far better than the current alternative ..."
        [/message]
        {MODIFY_UNIT (id=Belleros) facing nw}
        [message]
            speaker=Belleros
            message=_"Come, countrymen!  Make your way across the river, escape..."
        [/message]
        {FADE_TO_BLACK}
        [center_message]
            message="Belleros's world faded to black, and he felt a brief sense of relief.  He had hoped for a better end to his journey, but at least he had deprived the vile monster the harvest of his people..."
        [/center_message]
        [center_message]
            message="The Ukians who fled to Death's shore are free of the Khthon, but the ones who could not escape (those still on the recall list) were claimed as thralls in the coming battle at the volcano cave."
        [/center_message]
        [kill] # those on the map get to die
            side=1
            y=1-49
            [not]
                id=Belleros
            [/not]
        [/kill]
        # those on the recall list are still enthralled
        {ARCHAIC_KHTHONIZED (
            side=1
            x,y=recall,recall
        )}
        # placing the fallen Ukians, now Khthon, back on the recall list
        {FOREACH khthon_ukian i}
            [unstore_unit]
                variable=khthon_ukian[$i]
                x,y=recall,recall
                find_vacant=no
            [/unstore_unit]
        {NEXT i}
        [endlevel]
            {CONTINUE}
        [/endlevel]
    [/event]

    # dark terrain specific events: not good for khthon

    [event]
        name=moveto
        [filter]
            race=orc
            {BMR_SAFE_SHADOW_XY}
        [/filter]
        #	[filter_condition]
        #	    [have_unit]
        #		canrecruit=yes
        #		race=orc
        #	    [/have_unit]
        #	[/filter_condition]
        [message]
            speaker=Garkhan
            message=_"What does it look like, $unit.name|?"
        [/message]
        [message]
            speaker=unit
            message=_"It's as we thought...  I'm with my ancestors..."
        [/message]
        [kill]
            id=$unit.id
        [/kill]
        [message]
            speaker=Garkhan
            message=_"See, Rebel Commander?  We must reach that shore!"
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            {BMR_SAFE_SHADOW_XY}
            side=1
            [not]
                id=Belleros
            [/not]
            [not]
                race=ukiandog
            [/not]
        [/filter]
        [message]
            speaker=unit
            message=_"I am free of this nightmare..."
        [/message]
        [if]
            [have_unit]
                id=Bellos, Valos, Tach, Breitlin
                x,y=$x1,$y1
            [/have_unit]
            [then]
                [message]
                    speaker=Belleros
                    message=_"We've been through a lot, $unit.name|.  I'm glad you will escape the clutches of these monsters."
                [/message]
                [message]
                    speaker=unit
                    message=_"It's been an honour, sir.  See you on the other side."
                [/message]
            [/then]
        [/if]
        [kill]
            x,y=$x1,$y1
        [/kill]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            {BMR_SAFE_SHADOW_XY}
            side=1
            race=ukiandog
        [/filter]
        [message]
            speaker=unit
            message=_"Ahhooo..."
        [/message]
        [kill]
            x,y=$x1,$y1
        [/kill]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            [not]
                id=Echidna
            [/not]
            [not]
                canrecruit=yes
            [/not]
            race=khthon
            [filter_location]
                terrain=Woby,Wwby,Wrby
            [/filter_location]
        [/filter]
        [kill]
            id=$unit.id
            animate=yes
        [/kill]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            race=thrall_khthon
            [filter_location]
                terrain=Ydb,Woby,Wwby,Wrby
            [/filter_location]
        [/filter]
        [kill]
            id=$unit.id
            animate=yes
        [/kill]
    [/event]
[/scenario]
