#textdomain wesnoth-Bad_Moon_Rising

# 1.1.2 moved sword to 4,4 so that it is behind Belleros and not as easy to use it on Carghanna
# 2010-12-18: removed the sword crap.  The AI things aren't working, the AI just cuddles in the first keep. <- maybe because the action score was too low?
# Replace COMBAT with MOVE_LEADER_TO_GOALS.  Nope, that's not it...  I removed some old AI code, that seemed to do the trick.
# 20140727 - more updates to the AI, using microAI, because it is currently being supported and FAI is no longer maintained.

[scenario]
    id="2_07_Volcano"
    name= _ "Volcano"
    map_data="{~add-ons/Bad_Moon_Rising/maps/2_07_VolcanoB.map}"
    next_scenario=2_07_Epilogue
    victory_when_enemies_defeated=no
    turns=-1
    [music]
        name="the_city_falls.ogg"
    [/music]
    [music]
        name=casualties_of_war.ogg
        ms_before=12000
        append=yes
    [/music]

    [story]
        [part]
            story= _ "Meanwhile, back at the volcano, Raenna and the human vanguard of the Primeval Legion entered the unsealed cave."
            background="story/BMR_cave2.jpg"
        [/part]
    [/story]

    [time]
        id=thepit
        name= _ "The Pit"
        image=misc/time-schedules/schedule-underground.png
        lawful_bonus=-25
        red=-10
        green=-50
        blue=-50
    [/time]

    # this does not work
    [time_area]
        [time]
            id=bmr_volcano
            name= _ "The Volcano"
            image=misc/time-schedules/schedule-underground.png
            lawful_bonus=-10
            red=10
            green=-20
            blue=-20
        [/time]
        x=1-25
        y=1-17
        remove=no
    [/time_area]
    {BMR_INIT_LUA}

    [event]
        name=prestart
        [if]
            [variable]
                name=despair_gift
                equals=1
            [/variable]
            [then]
                [objectives]
                    side=3
                    [objective]
                        condition=win
                        description=_ "Defeat Carghanna"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Raena"
                    [/objective]
                    note=_"Remember Carusoe's assignment from Queen Astreya.  There is a small bonus if he is the one to kill the Side 1 Ukian leader."
                [/objectives]
            [/then]
            [else]
                [objectives]
                    side=3
                    [objective]
                        condition=win
                        description=_ "Defeat Carghanna"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Raena"
                    [/objective]
                [/objectives]
            [/else]
        [/if]
        {BMR_VOLCANO_ITEMS}
        {BMR_UNIT_MARKER_MENU 3}
        ############### restoring side 3 recall list ######################
        [set_variable]
            name=c_raenna.moves
            value=$c_raenna.max_moves
        [/set_variable]
        [unstore_unit]
            variable=c_raenna
            x,y=16,63
            find_vacant=no
        [/unstore_unit]
        {FOREACH side_three ist}
            [set_variable]
                name=side_three.moves
                value=$side_three.max_moves
            [/set_variable]
            [unstore_unit]
                variable=side_three[$ist]
                x,y=recall,recall
                find_vacant=no
            [/unstore_unit]
        {NEXT ist}
        {CLEAR_VARIABLE ist,side_three}
        ####################### done restoring #####################
        [item]
            x=16
            y=7
            image=misc/machine-2.png
            halo=halo/machine-2-ha.png:200,halo/machine-2-hb.png:200
        [/item]
        [item]
            x=24
            y=58
            image="items/chest-plain-closed.png"
        [/item]
        {GENERIC_UNIT 1 "Ukian Dog" 14 60}
        {GUARDIAN}
        {GENERIC_UNIT 1 "Ukian Attack Dog" 15 61}
        {GUARDIAN}
        {GENERIC_UNIT 1 "Ukian Dog" 16 60}
        {GUARDIAN}
        [unit]
            id=K_Guard1
            type="Ukian Runner"
            x=15
            y=60
            generate_name=yes
            random_traits=yes
            upkeep=full
        [/unit]
        {GUARDIAN}
        [store_unit]
            [filter]
                id=Echidna
            [/filter]
            variable=echidna
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Athanta
            [/filter]
            variable=athanta
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Ares
            [/filter]
            variable=ares
            kill=yes
        [/store_unit]
        [set_variable]
            name=count_down
            value=0
        [/set_variable]
        [set_variable]
            name=gate1
            value=0
        [/set_variable]
        {BMR_SURVIVORS2 3 "Primevalist Fanatic" "Primevalist Fighter" 15 66}
#ifdef __UNUSED__
# rethinking this, better to use gear_items
# #ifdef EASY
        [object]
            silent=yes
            duration=forever
            [filter]
                x,y=15,66
            [/filter]
            [effect]
                apply_to=attack
                range=melee
                set_type=arcane
            [/effect]
        [/object]
#endif
        {BMR_SURVIVORS2 3 "Primevalist Monk" "Primevalist Follower" 17 66}
#ifdef __UNUSED__
# #ifdef EASY
        [object]
            silent=yes
            duration=forever
            [filter]
                x,y=17,66
            [/filter]
            [effect]
                apply_to=attack
                range=ranged
                set_type=arcane
            [/effect]
        [/object]
#endif
        {BMR_SURVIVORS2 3 "Primevalist Follower" "Primevalist Follower" 17 65}
#ifdef __UNUSED__
# #ifdef EASY
        [object]
            silent=yes
            duration=forever
            [filter]
                x,y=17,65
            [/filter]
            [effect]
                apply_to=attack
                range=ranged
                set_type=arcane
            [/effect]
        [/object]
#endif
        {BMR_SURVIVORS2 3 "Primevalist Fighter" "Primevalist Fighter" 16 64}
#ifdef __UNUSED__
# #ifdef EASY
        [object]
            silent=yes
            duration=forever
            [filter]
                x,y=16,64
            [/filter]
            [effect]
                apply_to=attack
                range=melee
                set_type=arcane
            [/effect]
        [/object]
#endif
        [kill]
            id=Carusoe
        [/kill]
        # for debug - meh, we'll just do it this way in general
        [if]
            [variable]
                name=despair_gift
                equals=1
            [/variable]
            [then]
                [unit]
                    side=3
                    type=Carusoe2
                    name=Carusoe
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_RESILIENT}
                    [/modifications]
                    id=Carusoe
                    x,y=16,70
                    {IS_LOYAL}
                [/unit]
            [/then]
            [else]
                [unit]
                    side=3
                    type=Carusoe
                    name=Carusoe
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_RESILIENT}
                    [/modifications]
                    id=Carusoe
                    x,y=16,70
                    {IS_LOYAL}
                [/unit]
            [/else]
        [/if]
        [recall]
            id=Grat Gareth
        [/recall]
        [recall]
            id=Hrala Gareth
        [/recall]
        {GENERIC_UNIT 4 "Ipoten" 12 15}
        {GUARDIAN}
        [item]
            x,y=19,19
            image="items/bones.png"
        [/item]
        [clear_menu_item]
            id=bmr_unit_help_1,bmr_unit_help
        [/clear_menu_item]
        [if]
            [variable]
                name=khthon_ukians
                equals=yes
            [/variable]
            [then]
                {GENERIC_UNIT 1 "Ukian Commando" 23 52}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Ukian Seeress" 14 53}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Ukian Hawkeye" 10 53}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Ukian Commando" 23 64}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Ukian Commando" 10 41}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Ukian Commando" 23 65}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Ukian Commando" 4 61}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Ukian Commando" 15 50}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Ukian Commando" 17 23}
                {GUARDIAN}
                {GENERIC_UNIT 6 "Ukian Courrier" 13 57}
                {GUARDIAN}
                {GENERIC_UNIT 6 "Ukian Commando" 6 24}
                {GUARDIAN}
                {GENERIC_UNIT 6 "Ukian Commando" 8 31}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Ukian Veteran" 6 54}
                {GUARDIAN}
                {GENERIC_UNIT 6 "Ukian Commando" 24 11}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Ukian Commando" 2 12}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Ukian Veteran" 12 18}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Ukian Hawkeye" 13 31}
                {GUARDIAN}
                [store_unit]
                    [filter]
                        id=Beruchom
                    [/filter]
                    variable=BEM_temp
                    kill=no
                [/store_unit]
                [set_variable]
                    name=BEM_temp.race
                    value=khthon
                [/set_variable]
                [set_variable]
                    name=BEM_temp.alignment
                    value=chaotic
                [/set_variable]
                [set_variable]
                    name=BEM_temp.hitpoints
                    value=$BEM_temp.max_hitpoints
                [/set_variable]
                [set_variable]
                    name=BEM_temp.moves
                    value=0
                [/set_variable]
                [unstore_unit]
                    variable=BEM_temp
                    find_vacant=no
                [/unstore_unit]
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=Beruchom
                    [/filter]
                    [effect]
                        apply_to=attack
                        range=melee
                        increase_damage=30%
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=false
                        [resistance]
                            cold=-30
                            arcane=30
                        [/resistance]
                    [/effect]
                    [effect]
                        apply_to=max_hitpoints
                        increase=50
                    [/effect]
                    [effect]
                        apply_to=max_experience
                        increase=10
                    [/effect]
                    [effect]
                        apply_to=halo
                        halo=halo/deathglow.png
                    [/effect]
                    [effect]
                        apply_to=image_mod
                        replace="CS(-150,35,15)"
                    [/effect]
                [/object]
                [modify_unit]
                    [filter]
                        id=Beruchom
                    [/filter]
                    {ARCHAIC_TRAIT_ENTHRALL}
                [/modify_unit]
            [/then]
            [else] # Belleros got away, it is just the enthralled recall list that is left
                [kill]
                    id=Belleros
                [/kill]
                [recall] # this sometimes fails, why?
                    side=1
                    race=khthon
                    level=3
                    x,y=13,27
                [/recall]
                [if] # failsafe
                    [have_unit]
                        x,y=13,27
                        side=1
                    [/have_unit]
                    [else]
                        [unit]
                            side=1
                            type=Ukian Flareman
                            x,y=13,27
                        [/unit]
                        {ARCHAIC_KHTHONIZED (x,y=13,27)}
                    [/else]
                [/if]
                [store_unit]
                    [filter]
                        x,y=13,27
                    [/filter]
                    variable=new_leader
                    kill=yes
                [/store_unit]
                [set_variable]
                    name=new_leader.canrecruit
                    value=yes
                [/set_variable]
                {GENERIC_UNIT 1 "Nightmare" 23 52}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Noble_Beast" 14 53}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Ukian Hawkeye" 10 53}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Nightmare" 10 41}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Nightmare" 23 65}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Nightmare" 23 64}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Nightmare" 4 61}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Nightmare" 15 50}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Nightmare" 17 23}
                {GUARDIAN}
                {GENERIC_UNIT 6 "Ukian Courrier" 13 57}
                {GUARDIAN}
                {GENERIC_UNIT 6 "Nightmare" 6 24}
                {GUARDIAN}
                {GENERIC_UNIT 6 "Nightmare" 8 31}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Ophis" 6 54}
                {GUARDIAN}
                {GENERIC_UNIT 6 "Nightmare" 24 11}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Nightmare" 2 12}
                {GUARDIAN}
                {GENERIC_UNIT 4 "Ukian Veteran" 12 18}
                {GUARDIAN}
                {GENERIC_UNIT 1 "Pyradalon" 13 31}
                {GUARDIAN}
            [/else]
        [/if]
        [micro_ai]
            action=add
            ai_type=patrol
            side=4
            ca_id=chimera1
            ca_score=170000
            id=Chimera
            waypoint_x=10,20,20
            waypoint_y=40,34,42
        [/micro_ai]
        # to make all Ukians on map Khthon
        # race as a filter does not work
        {ARCHAIC_KHTHONIZED (side=1
        [not]
            race=khthon
        [/not]
    )}
    {ARCHAIC_KHTHONIZED (side=4
    [not]
        race=khthon
    [/not]
)}
{ARCHAIC_KHTHONIZED (side=6
[not]
    race=khthon
[/not]
)}
[/event]

# to make all Ukian recruits Khthon
{ARCHAIC_KHTHON_RECRUITS (side=1)}
{ARCHAIC_KHTHON_RECRUITS (side=4)}
{ARCHAIC_KHTHON_RECRUITS (side=6)}
# why are some of the recalls not Thralls?


# {FLAMES 12 55}
# {FLAMES 12 40}
# {FLAMES 12 44}
{FLAMES 23 33}

[side]
    type=Ukian Commander
    id=Belleros
    name= "Belleros-bug"
    ellipse="misc/ellipse"
    [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
    [/modifications]
    unrenamable=yes
    side=1
    canrecruit=yes
    controller=ai
    persistent=yes
    fog=yes
    shroud=yes
    [ai]
        {AI_SIMPLE_ALWAYS_ASPECT passive_leader yes}
        {AI_SIMPLE_ALWAYS_ASPECT caution 0.6}
        {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
        {BMR_VILLAGE_VALUE 0}
        #	aggression=0.8
        #	grouping=offensive
        #	passive_leader=yes
        #	caution=0.9
        #	village_value=0
    [/ai]
    recruit=Ukian Runner, Ukian Regular, Ukian Archer, Ukian Dog
    {GOLD 200 250 300}
    {INCOME 8 10 12}
    team_name=khthon
    save_id=Lorenzon
[/side]

[side]
    type=Primeval Storm
    id=Athanta
    name=  "Athanta"
    [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
    [/modifications]
    unrenamable=yes
    side=2
    canrecruit=yes
    controller=ai
    fog=no
    shroud=no
    recruit=Primeval Swiftfoot, Primeval Striker, Primeval Ironwheel
    {GOLD 280 220 160}
    {INCOME 16 12 8}
    #        {ai/aliases/stable_singleplayer.cfg}
    [ai]
        #		aggression=0.8
        #		grouping=offensive
        {AI_SIMPLE_ALWAYS_ASPECT caution 0.8}
        {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
        {BMR_VILLAGE_VALUE 0}
        # FLAG
        #		    [leader_goal]
        #			x,y=5,52
        #		    [/leader_goal]
        #		village_value=0
        #		caution=0.8
        [leader_goal]
            auto_remove=yes
            max_risk=1
            x,y=5,52
            id=0
        [/leader_goal]
    [/ai]
    team_name=primeval
[/side]

[side]
    type=Bad Raenna
    id=Raenna
    name=  "Raenna"
    [modifications]
        # RQ=117 QR=?
        {TRAIT_QUICK}
        {TRAIT_RESILIENT}
    [/modifications]
    unrenamable=yes
    side=3
    canrecruit=yes
    fog=no
    shroud=yes
    controller=human
    recruit=Primevalist Fighter, Primevalist Follower
    {GOLD 250 150 100}
    {INCOME 8 5 2}
    team_name=primeval
[/side]

# this side does not recruit, why?
[side]
    side=4
    type=Echidna
    id=Echidna
    name= "Carghanna"
    [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
    [/modifications]
    unrenamable=yes
    canrecruit=yes
    controller=ai
    fog=no
    team_name=khthon
    recruit=Ukian Runner, Ukian Regular, Ukian Archer, Ukian Veteran, Ukian Seeress, Ukian Hawkeye, Ukian Dog, Ukian Deadeye, Ukian Courrier
    {GOLD 190 260 330}
    {INCOME 12 14 16}
    [ai]
        #            version=10703

        #            [stage]
        #                engine=fai
        #                name=unit_formulas
        #            [/stage]

        #	aggression=0.8
        #	grouping=offensive
        #            {BMR_AI_TARGET (side=3) 50}
        #            {BMR_AI_TARGET (side=5) 50}
        #            {AI_SIMPLE_ALWAYS_ASPECT avoid (
        #                x=0-8
        #                y=39-53
        #            )}
        {AI_SIMPLE_ALWAYS_ASPECT passive_leader yes}
        {AI_SIMPLE_ALWAYS_ASPECT caution 0.8}
        {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
        #	passive_leader=yes
        #	caution=0.8
    [/ai]
    [unit]
        type=Chimera
        id=Chimera
        name="Chimera"
        x,y=15,45
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
    [/unit]
    [unit]
        type=Ipoten
        random_traits=yes
        x,y=6,24
        ai_special=guardian
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
    [/unit]
    [unit]
        type=Khalkotaurus
        random_traits=yes
        x,y=15,15
        ai_special=guardian
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
    [/unit]
    [unit]
        type=Khalkotaurus
        random_traits=yes
        x,y=8,15
        ai_special=guardian
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
    [/unit]
    [unit]
        type=Bellikakotaurus
        random_traits=yes
        x,y=8,11
        ai_special=guardian
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
    [/unit]
    [unit]
        type=Bellikakotaurus
        random_traits=yes
        x,y=15,11
        ai_special=guardian
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
    [/unit]
[/side]

[side]
    type=Primeval Ares
    id=Ares
    name=  "Ares"
    profile=portraits/ares.png
    [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
    [/modifications]
    unrenamable=yes
    side=5
    canrecruit=yes
    controller=ai
    shroud=no
    fog=no
    recruit=Primeval Slow, Primeval Driver, Primeval Dogface, Primeval Swiftfoot, Primeval Striker, Primeval Ironwheel
    {GOLD 100 100 100}
    {INCOME 4 6 8}
    #        {ai/aliases/stable_singleplayer.cfg}
    [ai]
        leader_aggression=1
        [leader_goal]
            auto_remove=yes
            max_risk=1
            x,y=5,52
            id=0
        [/leader_goal]
    [/ai]
    team_name=primeval
[/side]

[side]
    type=Ukian Subcommander
    id=Beruchom
    name=  "Beruchom"
    ellipse="misc/ellipse"
    [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
    [/modifications]
    unrenamable=yes
    side=6
    canrecruit=yes
    controller=ai
    fog=no
    shroud=yes
    [ai]
        {AI_SIMPLE_ALWAYS_ASPECT passive_leader yes}
        {AI_SIMPLE_ALWAYS_ASPECT caution 0.8}
        {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
        #	aggression=0.9
        #	grouping=offensive
        #	caution=0.6
        #	village_value=0
        {BMR_VILLAGE_VALUE 0}
    [/ai]
    recruit=Ukian Runner, Ukian Regular
    {GOLD 160 210 260}
    {INCOME 8 10 12}
    team_name=khthon
[/side]

# core macros
{LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Primeval Striker" 2}
{LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Primeval Ironwheel" 2}
{LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Ukian Hawkeye" 3}
{LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Ukian Seeress" 3}
{LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Ukian Veteran" 4}
{LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Ukian Courrier" 2}
{LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Ukian Deadeye" 1}
{LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Primeval Striker" 3}
{LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Primeval Ironwheel" 3}
{LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Primeval Driver" 3}

# Ares AI just takes too long if he has too many units
# These should be removed when/if the AI is faster
{LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Primeval Slow" 10}
{LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Primeval Swiftfoot" 10}

# So that Chimera doesn't kill Athanta

{FORCE_CHANCE_TO_HIT race=khthon id=Athanta 0 (
    [variable]
        name=gate1
        less_than=100
    [/variable]
)}

{OBJ_POTION_STRONG 6 63 St1}
# using [gear_item]s
# {BMR_POTION_HOLY 7 64 Hy1 3}
# {BMR_POTION_HOLY 4 60 Hy2 3}
# until I get this fixed   {OBJ_RING_ANCIENT2 3 23 39 Anc1}
[event]
    name=moveto
    [filter]
        side=3
        x,y=24,58
    [/filter]
    [message]
        speaker=unit
        message= _ "250 Gold coins! Oddly minted, but still: Gold coins!"
    [/message]
    [gold]
        amount=250
        side=3
    [/gold]
    [remove_item]
        x,y=24,58
    [/remove_item]
    [item]
        x,y=24,58
        image="items/chest-plain-open.png"
    [/item]
[/event]

[event]
    name=start

#ifndef EASY
    [disallow_recruit]
        type=Primevalist Monk, Primevalist Fanatic
        side=3
    [/disallow_recruit]
#endif
    [message]
        speaker=Raenna
        message = _ "Belleros and Carghanna have a head start, but they can't be that well entrenched yet!"
    [/message]
# new items placement (20160904)
# entrance
#ifdef EASY
    [item]
	image=items/box.png
	x,y=14,63
    [/item]
    [gear_item]
	gear_id=holy_charm
	x,y=14,63
    [/gear_item]
#endif
# center right room
    [item]
	image=items/chest-plain-closed.png
	x,y=24,51
    [/item]    
    [event]
	name=moveto
	[filter]
	    side=3
	    x,y=24,51
	[/filter]
	[remove_item]
	    image=items/chest-plain-closed.png
	    x,y=24,51
	[/remove_item]    
	[item]
	    image=items/chest-plain-open.png
	    x,y=24,51
	[/item]    
	[message]
	    speaker=unit
	    message=_"There is a large silver key in this box.  There must be a locked door somewhere."
	[/message]
	[event]
	    name=moveto
	    [filter]
		side=3
		x,y=3,42
	    [/filter]
	    [message]
		speaker=unit
		message=_"That large silver key looks like it would fit the lock on this gate."
	    [/message]
	    [terrain]
		x,y=2,41
		terrain=Rrc
	    [/terrain]
	    [redraw]
		side=3
	    [/redraw] 
	[/event]
    [/event]
# center left room
    [item]
	image=items/box.png
	x,y=2,38
    [/item]
    [item]
	image=items/book2.png
	x,y=4,38
    [/item]
    [event]
	name=moveto
	[filter]
	    side=3
	    x,y=4,38
	[/filter]
	[message]
	    speaker=unit
	    message=_"This book is written in some odd language, I can't read it...  But it does have some drawings that depict the amulets sitting in this storage room, and a picture of vacant green eyes."
	[/message]
	[message]
	    speaker=Athanta
	    message=_"That manual is telling you that those charms protect against the green plague.  It was an early effort at a counter-measure, before I developed the superior methods now used to protect the faithful."
	[/message]
	[message]
	    speaker=Hrala Gareth
	    message=_"The 'faithful' may not need those charms, but some of us could still use them."
	[/message]
    [/event]
    [gear_item]
	gear_id=primeval_charm
	x,y=3,38
    [/gear_item]
    [gear_item]
	gear_id=primeval_charm
	x,y=4,37
    [/gear_item]
    [gear_item]
	gear_id=primeval_charm
	x,y=5,38
    [/gear_item]
# bottom left room
    [item]
	image=items/box.png
	x,y=4,61
    [/item]
    [item]
	image=items/barrel1.png
	x,y=4,62
    [/item]    
    [gear_item]
	gear_id=fiber_armor
	x,y=4,60
    [/gear_item]
    [gear_item]
	gear_id=holy_charm
	x,y=7,64
    [/gear_item]
# bottom right room
    [item]
	image=items/barrel3.png
	x,y=20,62
    [/item]    
    [gear_item]
	gear_id=dragon_armor
	x,y=21,64
    [/gear_item]
# end new items placement
    [apply_gear]
	gear_id=orc_cloak
	id=Carusoe
    [/apply_gear]
    [apply_gear]
	gear_id=scale_armor
	id=Carusoe
    [/apply_gear]
    {MOVE_UNIT (id=Carusoe) 16 67}
    [message]
        speaker=Carusoe
        message = _ "Raenna! Why are you dressed like that?"
    [/message]
    [message]
        speaker=Raenna
        message = _ "I don't have time to deal with you..."
    [/message]
    [message]
        speaker=Carusoe
        message = _ "No, you don't have to, I'm not your enemy.  Let me offer my services.  After all, is it so hard to believe that I'd seek to kill the very same commander you now fight?"
    [/message]
    [message]
        speaker=Raenna
        message = _ "Persistent, aren't you?  Fine!  But don't try anything, or I <i>will</i> kill you."
    [/message]
    {MODIFY_UNIT (x,y=15,61) moves 0}
    [event]
	name=attack
	[filter]
	    type=Ukian Dog
	    side=1
	[/filter]
	[message]
	    speaker=unit
	    message="<i>"+ _"Snarl!"+ "</i>"
	    image=portraits/dog.png~CS(-150,-40,-95)~BLIT(portraits/dog_k.png)
	[/message]
    [/event]
[/event]

[event]
    # Having the AI get in the way makes it more difficult, so although Ares is an ally, his arrival is not helpful.
    {QUANTITY name "turn 7" "turn 5" "turn 3"}
    #	name=turn 2
    [unstore_unit]
        variable=ares
    [/unstore_unit]
    [set_variable]
        name=prime1
        rand="Primeval Striker","Primeval Driver","Primeval Slow","Primeval Swiftfoot","Primeval Slow","Primeval Swiftfoot"
    [/set_variable]
    [unit]
        side=5
        type=$prime1
        generate_name=yes
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_QUICK}
        [/modifications]
        x,y=15,68
    [/unit]
    {CLEAR_VARIABLE prime1}
    [set_variable]
        name=prime1
        rand="Primeval Striker","Primeval Driver","Primeval Dogface","Primeval Ironwheel","Primeval Slasher"
    [/set_variable]
    [unit]
        side=2
        type=$prime1
        generate_name=yes
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_QUICK}
        [/modifications]
        x,y=13,68
    [/unit]
    {CLEAR_VARIABLE prime1}
    [set_variable]
        name=prime1
        rand="Primeval Striker","Primeval Driver","Primeval Dogface","Primeval Gyrepacter","Primeval Warrior","Primeval Aerowheel"
    [/set_variable]
    [unit]
        side=5
        type=$prime1
        generate_name=yes
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_RESILIENT}
        [/modifications]
        x,y=14,67
    [/unit]
    {CLEAR_VARIABLE prime1}
    # to avoid AI idiocy
    #	{MOVE_UNIT id=Ares 38 44}
    [message]
        speaker=Ares
        message= _ "This structure houses great troubles, don't let the dark spirits get a foothold - Exterminate the beasts!"
    [/message]
[/event]

[event]
    {QUANTITY name "turn 8" "turn 6" "turn 5"}
    #	name=turn 3
    [unstore_unit]
        variable=athanta
    [/unstore_unit]
    [set_variable]
        name=prime1
        rand="Primeval Striker","Primeval Driver","Primeval Slow","Primeval Swiftfoot","Primeval Slow","Primeval Swiftfoot"
    [/set_variable]
    [unit]
        side=2
        type=$prime1
        generate_name=yes
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_QUICK}
        [/modifications]
        x,y=18,67
    [/unit]
    {CLEAR_VARIABLE prime1}
    [set_variable]
        name=prime1
        rand="Primeval Striker","Primeval Driver","Primeval Dogface","Primeval Ironwheel","Primeval Slasher"
    [/set_variable]
    [unit]
        side=5
        type=$prime1
        generate_name=yes
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_QUICK}
        [/modifications]
        x,y=19,69
    [/unit]
    {CLEAR_VARIABLE prime1}
    [set_variable]
        name=prime1
        rand="Primeval Striker","Primeval Driver","Primeval Dogface","Primeval Gyrepacter","Primeval Warrior","Primeval Aerowheel"
    [/set_variable]
    [unit]
        side=2
        type=$prime1
        generate_name=yes
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_RESILIENT}
        [/modifications]
        x,y=17,67
    [/unit]
    {CLEAR_VARIABLE prime1}
    # to avoid AI idiocy
    #	{MOVE_UNIT id=Athanta 39 44}
    [message]
        speaker=Athanta
        message= _ "The Khthon are converging upon us, but I've secured a path and our Legion has clear movement. May we finally rid the world of the green scourge!"
    [/message]
[/event]

# Raenna is the hero now.
[event]
    name=die
    [filter]
        id=Raenna
    [/filter]
    [message]
        message= _ "Any hope for the world died along with Raenna. The victor of this battle, demon or spirit, would usher forth a new distopia."
        image="misc/skull.png"
    [/message]
    [endlevel]
        result=defeat
    [/endlevel]
[/event]
# only makes sense if the orcs are present
# should this be defeat?  Probably not...
[event]
    name=die
    [filter]
        id=Hrala Gareth, Grat Gareth
    [/filter]
    [message]
        speaker=Raenna
        message= _ "That's not good..."
    [/message]
#    [endlevel]
#        result=defeat
#    [/endlevel]
[/event]

# kill Ares -> Win
[event]
    name=die
    [filter]
        id=Ares
    [/filter]
    [message]
        speaker=Raenna
        message= _ "Sweet success. It won't be long now..."
    [/message]
    [center_message]
        message ="As the damaged, ancient device glowed brighter, Raenna spent her final moments in contemplation. She looked back with some nostalgia upon the innocent days of defending Korkath from Huric's gang of cretins - life was so much simpler back then..."
    [/center_message]
    {FADE_TO_BLACK}
    [delay]
        time=1000
    [/delay]
    {QUAKE rumble.ogg}
    #		[kill]
    #		side=3
    #		[/kill]
    [endlevel]
        {CONTINUE}
    [/endlevel]
[/event]

[event]
    name=enter_hex
    [allow_undo][/allow_undo]
    [filter]
        side=3
        y=27
    [/filter]
    [gold]
        side=4
        amount=450
    [/gold]
[/event]

# Raenna catches up to Echidna.  Nemesis swoops in, sets of the power source to explode.
# Echidna flees, Nemesis close behind.  Raenna & Primevalists learn of Primeval plan.
# this needs to be altered
[event]
    name=attack
    [filter]
        side=3
    [/filter]
    [filter_second]
        id=Echidna
    [/filter_second]
    [message]
        speaker=Echidna
        message= _ "Ooh, nice try.  I'm still getting set up here though, so go away."
    [/message]
    [message]
        speaker=Raenna
        message= _ "Carghanna!  What are you <i>doing?</i>  Please, say you have a plan."
    [/message]
    [message]
        speaker=Echidna
        message= _ "'Carghanna?'  Yes, I suppose it appears that way... Carghanna is one of us now, and you will join her soon enough.  Rest assured that I do have a plan, though I will not tell you right now."
    [/message]
    [redraw]
        side=3
    [/redraw]
    [remove_shroud]
        side=3
        x,y=1-25,1-16
    [/remove_shroud]
    [music]
        name=vengeful.ogg
        append=no
        immediate=yes
    [/music]
    [unit]
        type=Primeval Nemesis
        id=Nemesis
        name="Nemesis"
        random_traits=yes
        side=5
        x,y=20,1
    [/unit]
    {MOVE_UNIT id=Nemesis 14 6}
    [message]
        speaker=Nemesis
        message= _ "Your plans are not worth listening to, for they are but dreams."
    [/message]
    [message]
        speaker=Echidna
        message= _ "How? - you-"
    [/message]
    [message]
        speaker=Nemesis
        message= _ "With your power source, we will blow the top off of this volcano! We need not fight your slaves, for we will win through attrition: The ash from the cinder-head will blot out the sun, and all shall perish but us. We shall inherit this land."
    [/message]
    [message]
        speaker=Raenna
        message= _ "Whoa... What!?"
    [/message]
    {MOVE_UNIT id=Nemesis 16 8}
    {MODIFY_UNIT id=Nemesis facing ne}
    [message]
        speaker=Nemesis
        message= _ "Do not worry, Raenna, you will not die with them. Retreat from this summit and join Ares. You can spend your days as one of us."
    [/message]
    [animate_unit]
        flag=attack
        [filter]
            id=Nemesis
        [/filter]
        [primary_attack]
            range=melee
        [/primary_attack]
        hits=yes
        [facing]
            x,y=16,7
        [/facing]
    [/animate_unit]
    [remove_item]
        x,y=16,7
    [/remove_item]
    [item]
        x=16
        y=7
        image=misc/machine-2.png~CS(30,10,-60)
        halo=halo/machine-2-ha.png:200,halo/machine-2-hb.png:200,halo/machine-2-ha.png:200,halo/machine-2-hb.png:200,halo/machine-2-ha.png:200,halo/machine-2-hb.png:200,halo/machine-2-ba.png:100,halo/machine-2-bb.png:90,halo/machine-2-bc.png:90,halo/machine-2-ba.png:100,halo/machine-2-ha.png:150,halo/machine-2-ba.png:100,halo/machine-2-ha.png:200,halo/machine-2-hb.png:200,halo/machine-2-bd.png:90,halo/machine-2-be.png:90,halo/machine-2-ba.png:90,halo/machine-2-ha.png:150,halo/machine-2-hb.png:150
    [/item]
    [role]
        role=Follower3
        type="Primevalist Fighter","Primevalist Follower","Primevalist Fanatic","Primevalist Monk"
    [/role]
    [message]
        role=Follower3
        message= _ "<i>And what about us?</i>  Raenna, what will happen to the rest of mankind?"
    [/message]
    [message]
        speaker=Grat Gareth
        message= _ "Or the orcs?"
    [/message]
    [message]
        speaker=Raenna
        message= _ "..."
    [/message]
    [message]
        speaker=Echidna
        message= _ "Foul Nemesis! This is a set-back, but we Khthon are very patient. Life is tenacious, and will survive your volcanic winter to regain its foot-hold..."
    [/message]
    [message]
        speaker=Echidna
        message= _ "And when it does, I will be there to collect and direct it. So, until then..."
    [/message]
    [kill]
        id=Echidna
    [/kill]
    [move_unit_fake]
        type=Echidna_Monster
        x=9,16
        y=7,1
        side=4
    [/move_unit_fake]
    [message]
        speaker=Nemesis
        message= _ "No, Echidna. Not this time..."
    [/message]
    {MOVE_UNIT id=Nemesis 16 1}
    [kill]
        id=Nemesis
    [/kill]
    [message]
        speaker=Athanta
        message= _ "<i>This is your damned plan!?</i>  Destroy this powerful facility?  Then what, continue going in circles with the Khthon?  My strategy-"
    [/message]
    [message]
        speaker=Ares
        message= _ "<b>Your strategy was falling apart!</b>  Unless it involved giving Echidna a new army..."
    [/message]
    [message]
        speaker=Athanta
        message= _ "You're as short-sighted as ever, Ares!  I'm putting a stop to this idiocy, I'll see if I can shut down the bomb."
    [/message]
    [if]
        [have_unit]
            x,y=15,8
        [/have_unit]
        [then]
            {MOVE_UNIT (x,y=15,8) 16 10}
        [/then]
    [/if]
    [if]
        [have_unit]
            x,y=14,8
        [/have_unit]
        [then]
            {MOVE_UNIT (x,y=14,8) 13 7}
        [/then]
    [/if]
    {MOVE_UNIT (id=Athanta) 15 8}
    {MODIFY_UNIT (id=Athanta) facing ne}
    {MOVE_UNIT (id=Ares) 14 8}
    {MODIFY_UNIT (id=Ares) facing ne}
    [music]
        name=knalgan_theme.ogg
        append=no
        immediate=yes
    [/music]
    [message]
        speaker=Ares
        message= _ "You will do no such thing!"
    [/message]
    [animate_unit]
        flag=attack
        [filter]
            id=Ares
        [/filter]
        # I'm not sure this does anything
        [filter_second]
            id=Athanta
        [/filter_second]
        #
        [primary_attack]
            name=sword
        [/primary_attack]
        hits=yes
    [/animate_unit]
    {MODIFY_UNIT (id=Athanta) facing sw}
    [animate_unit]
        flag=attack
        [filter]
            id=Athanta
        [/filter]
        # I'm not sure this does anything
        [filter_second]
            id=Ares
        [/filter_second]
        #
        [primary_attack]
            name=storm
        [/primary_attack]
        hits=no
    [/animate_unit]
    [animate_unit]
        flag=attack
        [filter]
            id=Ares
        [/filter]
        # I'm not sure this does anything
        [filter_second]
            id=Athanta
        [/filter_second]
        #
        [primary_attack]
            name=sword
        [/primary_attack]
        hits=yes
    [/animate_unit]
    [kill]
        id=Athanta
        animate=yes
    [/kill]
    #        [music]
    #            name="frantic.ogg"
    #            immediate=yes
    #        [/music]
    {MOVE_UNIT (id=Ares) 12 18}
    [message]
        speaker=Ares
        message= _ "The blast will be powerful, we should not stay here."
    [/message]
    # make the AI move Ares to the exit
    #	[micro_ai]
    #	    side=5
    #	    ai_type=goto
    #	    action=delete
    #	    ca_id=ares_to_top
    #	[/micro_ai]
    [micro_ai]
        side=5
        ai_type=goto
        action=add
        ca_id=ares_to_bottom
        release_unit_at_goal=yes
        [filter]
            id=Ares
        [/filter]
        [filter_location]
            x,y=16,68
        [/filter_location]
    [/micro_ai]
    [message]
        speaker=Ares
        message= _ "The spreading darkness and ash will weaken the lesser races, but if the Khthon get to them first they could still be a problem. We will march south, to raze their cities and break the spines of their armies. A starving and defeated people will be much less useful to our enemy..."
    [/message]
    [message]
        speaker=Raenna
        message= _ "That doesn't sound good..."
    [/message]
    [message]
        role=Follower3
        message= _ "Can't we do something?"
    [/message]
    [objectives]
        side=3
        [objective]
            condition=win
            description=_ "Deactivate the Volcanic device"
        [/objective]

        [objective]
            condition=lose
            description= _ "Death of Raenna"
        [/objective]
        [objective]
            condition=lose
            description= _ "Volcanic Eruption"
        [/objective]
    [/objectives]
    [message]
        speaker=Raenna
        message= _ "We need to prevent the eruption, but that would not deal with our friends - they who would kill us for 'attrition.'"
    [/message]
    [message]
        role=Follower3
        message= _ "Can an immortal god be blown up? How do we stop the explosion?"
    [/message]
    [message]
        speaker=Raenna
        message= _ "I need to get to the device, maybe I can think of something..."
    [/message]
    [message]
        role=Follower3
        message= _ "You know how it works?"
    [/message]
    [message]
        speaker=Raenna
        message= _ "I do not..."
    [/message]
    [set_variable]
        name=count_down
        value=1
    [/set_variable]
    # Does this work? I think so.
    [set_variable]
        name=new_limit
        value=$turn_number
    [/set_variable]
    [set_variable]
        name=new_limit
        {QUANTITY add 25 20 15}
    [/set_variable]
    [modify_turns]
        value=$new_limit
    [/modify_turns]
[/event]

# Some seasoning...
# these are stupid and disruptive
#ifdef __UNUSED__
[event]
    name=moveto
    [filter]
        side=3
        x,y=16-23,39-44
    [/filter]
    [remove_shroud]
        side=3
        x=16-23
        y=39-44
    [/remove_shroud]
    [message]
        speaker=unit
        message= _ "This place smells like a giant litter-box..."
    [/message]
[/event]
[event]
    name=moveto
    [filter]
        side=3
        x,y=13-15,39-43
    [/filter]
    [message]
        speaker=unit
        message= _ "I see some recent boot-prints in the dust..."
    [/message]
[/event]
#endif

[event]
    name=die
    [filter]
        id=K_Guard1
    [/filter]
    [message]
        speaker=second_unit
        message= _ "They are human, but there was something wrong. I could see it in the vacant eyes."
    [/message]
[/event]

# Belleros and the sword
# 2010-12-18: I'm removing the sword, it was a stupid idea
[event]
    name=attack
    [filter]
        id=Raenna
    [/filter]
    [filter_second]
        id=Belleros
    [/filter_second]
    [message]
        speaker=Raenna
        message= _ "Belleros, are you still in there somewhere?  Can you hear me?"
    [/message]
    [message]
        speaker=Belleros
        message= _ "<i>Snarl!</i>"
    [/message]
    [message]
        speaker=Ares
        message= _ "Of course not, he's a Khthon!"
    [/message]
[/event]

[event]
    name=last_breath
    [filter]
        id=Belleros
        [or]
            id=$new_leader.id
        [/or]
    [/filter]
    [if]
        [variable]
            name=second_unit.id
            equals=Carusoe
        [/variable]
        [variable]
            name=despair_gift
            equals=1
        [/variable]
        [then]
            [music]
                name=vengeful.ogg
                immediate=yes
                append=yes
            [/music]
            [message]
                speaker=Carusoe
                message=_"<i>Die, rebel scum!</i>"
            [/message]
            [kill]
                id=$unit.id
                animate=yes
            [/kill]
            [delay]
                time=650
            [/delay]
            [message]
                speaker=Carusoe
                message=_" ...  That didn't feel as satisfying as I thought it would...  Nevertheless, my promise to the queen is fulfilled."
            [/message]
            [message]
                speaker=Raenna
                message=_"What are you talking about?  What promise?"
            [/message]
            [message]
                speaker=Carusoe
                message=_"This sword was a gift from Queen Astreya, she wanted me to take vengeance on the rebel commander."
            [/message]
            [unit]
                type=Phantom Shadow
                x,y=14,69
                side=3
                id=Despair1
            [/unit]
            [unit]
                type=Phantom Soldier
                x,y=18,69
                side=3
                id=Despair2
            [/unit]
            [message]
                speaker=Despair1
                message=_"And she is glad that you followed through, still a loyal subject of the Kingdom..."
            [/message]
            [message]
                speaker=Despair2
                message=_"Even if you do keep strange company..."
            [/message]
            [message]
                speaker=Despair1
                message=_"Indeed...  Queen Astreya does not abandon her subjects...  These others are enemies..."
            [/message]
            [message]
                speaker=Carusoe
                message=_"No, they are no longer enemies!  The humans led by the brown-haired woman, at least."
            [/message]
            [message]
                speaker=Despair1
                message=_"Very well.  The Queen offers what help she can, small as it is..."
            [/message]
            [message]
                speaker=Despair2
                message=_"As this is the edge of our realm, only the Wisps can help.  Come back closer to Central Ukiah, and it would be diffrent.  But this far out..."
            [/message]
            [message]
                speaker=Carusoe
                message=_"I see, shade.  We'll take whatever help we can get..."
            [/message]
            [message]
                speaker=Despair1
                message=_"Best of luck, Carusoe."
            [/message]
            [allow_recruit]
                side=3
                type=Phantom Unease
            [/allow_recruit]
            [kill]
                id=Despair1
            [/kill]
            [kill]
                id=Despair2
            [/kill]
        [/then]
        [else]
            [message]
                speaker=Raenna
                message= _ "Rest in peace, $unit.name|.  I know you were just being used and didn't want any of this."
            [/message]
        [/else]
    [/if]
[/event]

[event]
    name=moveto
    [filter]
        side=3
        y=1-18
    [/filter]
    [remove_shroud]
        side=3
        x=1-25
        y=1-18
    [/remove_shroud]
[/event]

# The magma (or whatever it's called) is drained -
# 2010-12-18: Change of plans
# this event needs to be overhauled, use filter_condition
[event]
    name=moveto
    first_time_only=no
    [filter]
        id=Raenna
        x=15,15,16,16
        y=7,8,8,7
    [/filter]
    #        [if]
    [filter_condition]
        [variable]
            name=count_down
            numerical_equals=1
        [/variable]
    [/filter_condition]
    #            [then]
    [set_variable]
        name=count_down
        value=2
    [/set_variable]
    [message]
        speaker=unit
        message= _ "... I have no idea what I'm looking at. However, it looks like I may be able to lift it."
    [/message]
    [remove_item]
        x,y=16,7
    [/remove_item]
    [unit_overlay]
        id=Raenna
        image=misc/machine-2.png~CS(30,10,-60)
    [/unit_overlay]
    {MODIFY_UNIT id=Raenna max_moves 4}
    {MODIFY_UNIT id=Raenna moves 0}
    [message]
        speaker=unit
        message= _ "<i>huh!</i> It is heavy though."
    [/message]
    [message]
        speaker=Carusoe
        message= _ "Maybe we can get the device away from the lava."
    [/message]
    {QUAKE rumble.ogg}
    [music]
        name="gathering_storm.ogg"
        immediate=yes
    [/music]
    [message]
        side=5
        message= _ "What are you doing!?"
    [/message]
    [message]
        speaker=Ares
        message= _ "Using humans was a mistake - yet another of Athanta's strange ideas. Why did I listen to her?"
    [/message]
    [message]
        speaker=Ares
        message= _ "Now we will have to do this the hard way, but we will prevail. Neither the Khthon nor the animals they use will stand in our way..."
    [/message]
    [modify_side]
        side=3
        team_name=good
    [/modify_side]
    [message]
        speaker=Raenna
        message= _ "I cannot stop this device from exploding. It will surely kill us, but I doubt it will kill Ares. We do need to get this away from the lava though, and hope it is enough to prevent an erruption."
    [/message]
    [modify_side]
        side=5
        [ai]
            {BMR_AI_LOCPROTECT (
                x=10-20,23-25
                y=58-70,31-32
            ) 60 1}
        [/ai]
    [/modify_side]
    [objectives]
        side=3
        [objective]
            condition=win
            description=_ "Move Device as far south as possible."
        [/objective]

        [objective]
            condition=lose
            description= _ "Death of Raenna"
        [/objective]
        [objective]
            condition=lose
            description= _ "Ares escapes"
        [/objective]

        {TURNS_RUN_OUT}
    [/objectives]
    #            [/then]
    #        [/if]
[/event]

[event]
    name=moveto
    first_time_only=no
    # this event needs to be overhauled, use filter_condition
    [filter]
        id=Raenna
        y=25-35
    [/filter]
    #        [if]
    [filter_condition]
        [variable]
            name=count_down
            numerical_equals=2
        [/variable]
    [/filter_condition]
    #            [then]
    [set_variable]
        name=count_down
        add=1
    [/set_variable]
    # this tag does not work
    #		    [remove_unit_overlay]
    #			x,y=$x1,$y1
    #			image=misc/machine-2.png
    #		    [/remove_unit_overlay]
    # doing it by hand...
    [store_unit]
        [filter]
            id=Raenna
        [/filter]
        variable=no_overlay
        kill=yes
    [/store_unit]
    [set_variable]
        name=no_overlay.overlays
        value=""
    [/set_variable]
    [unstore_unit]
        variable=no_overlay
    [/unstore_unit]
    {CLEAR_VARIABLE no_overlay}
    [item]
        x=$x1
        y=$y1
        image=misc/machine-2.png~CS(30,10,-60)
        halo=halo/machine-2-ha.png:200,halo/machine-2-hb.png:200,halo/machine-2-ha.png:200,halo/machine-2-hb.png:200,halo/machine-2-ha.png:200,halo/machine-2-hb.png:200,halo/machine-2-ba.png:100,halo/machine-2-bb.png:90,halo/machine-2-bc.png:90,halo/machine-2-ba.png:100,halo/machine-2-ha.png:150,halo/machine-2-ba.png:100,halo/machine-2-ha.png:200,halo/machine-2-hb.png:200,halo/machine-2-bd.png:90,halo/machine-2-be.png:90,halo/machine-2-ba.png:90,halo/machine-2-ha.png:150,halo/machine-2-hb.png:150
    [/item]
    [item]
        x=21
        y=18
        halo="halo/safe1.png:100,halo/safe2.png:100,halo/safe1.png:100,halo/safe.png:600,halo/safe3.png:100,halo/safe4.png:100,halo/safe5.png:100,halo/safe3.png:100,halo/safe.png:800"
    [/item]
    [set_variable]
        name=r_Y
        value=$y1
    [/set_variable]
    [set_variable]
        name=r_Y
        add=-1
    [/set_variable]
    {MOVE_UNIT (id=Raenna) $x1 $r_Y}
    {CLEAR_VARIABLE r_Y}
    [message]
        speaker=Raenna
        message= _ "<i>(Uhg)</i> I can't carry this thing any further, we will just have to hope that is far enough."
    [/message]
    {MODIFY_UNIT id=Raenna max_moves 7}
    [message]
        speaker=Carusoe
        message= _ "How do we stop Ares? We <i>must</i> do something to stop him!"
    [/message]
    [message]
        speaker=Raenna
        message= _ "This cave was sealed when Athanta and I first got here. Maybe it can be sealed again?"
    [/message]
    [message]
        speaker=Carusoe
        message= _ "There may be an answer in one of the side rooms!"
    [/message]
    [objectives]
        side=3
        [objective]
            condition=win
            description=_ "Seal the Cave"
        [/objective]
        [objective]
            condition=lose
            description= _ "Death of Raenna"
        [/objective]
        [objective]
            condition=lose
            description= _ "Ares escapes"
        [/objective]

        {TURNS_RUN_OUT}
        note=_ "The Prologue of Part 1 has a hint."
    [/objectives]
    #            [/then]
    #        [/if]
[/event]

[event]
    name=moveto
    first_time_only=no
    [filter]
        side=3
        x,y=21,18
    [/filter]
    #        [if]
    [filter_condition]
        [variable]
            name=count_down
            numerical_equals=3
        [/variable]
    [/filter_condition]
    #            [then]
    [message]
        speaker=unit
        message= _ "This looks promising! There's an outline of a hand, I place mine there and ..."
    [/message]
    [music]
        name="In_the_Land_of_Madness.ogg"
        immediate=yes
        append=no
    [/music]
    {QUAKE rumble.ogg}
    [terrain]
        terrain=Xu
        x=13-20
        y=65-67
    [/terrain]
    [redraw]
        side=3
    [/redraw]
    [scroll_to]
        x,y=16,66
    [/scroll_to]
    [delay]
        time=200
    [/delay]
    [message]
        speaker=Ares
        message= _ "<i>No!</i>  You..."
    [/message]
    #	    {MOVE_UNIT id=Ares 15 20}
    [message]
        speaker=Chimera
        message= _ "<i>*Snarl!*</i>"
    [/message]
    [message]
        speaker=Carusoe
        message= _ "The cave has been re-sealed...  Ares isn't going anywhere, but neither are we...  This is it."
    [/message]
    [message]
        speaker=Hrala Gareth
        message= _ "The end of our line...  At least our Drifters will ensure the Gareth name isn't forgotten."
    [/message]
    [message]
        speaker=Raenna
        message= _ "Hah!  You're stuck in here with us, <i>Lord</i> Ares!  We shall find out just how '<i>immortal</i>' you really are!"
    [/message]
    {COLOR_ADJUST 67 67 67}
    {QUAKE rumble.ogg}
    [message]
        speaker=Ares
        message= _ "<b>RRAAHHHH!</b>"
    [/message]
    {COLOR_ADJUST 100 100 100}
    {COLOR_ADJUST 170 170 170}
    {COLOR_ADJUST 220 220 220}
    [kill]
        side=3
    [/kill]
    {COLOR_ADJUST 254 254 254}
    [kill]
        side=5
    [/kill]
    [endlevel]
        {CONTINUE}
    [/endlevel]
    #            [/then]
    #        [/if]
[/event]

[event]
    name=moveto
    first_time_only=no
    [filter]
        id=Ares
        y=66-70
    [/filter]
    [if]
        [variable]
            name=count_down
            numerical_equals=2
        [/variable]
        [then]
            [message]
                speaker=unit
                message= _ "Make sure the humans don't escape the blast, they shall not escape their fate..."
            [/message]
            [message]
                speaker=Raenna
                message= _ "He's getting away, our brothers and sisters to the south are doomed..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/then]
    [/if]
[/event]

# open the West gate to SW corner
[event]
    name=moveto
    [filter]
        side=3
        x,y=5,55
    [/filter]
    [message]
        speaker=unit
        message= _ "This urn is attached to the floor... <i>*hrmph*</i>  It spins."
    [/message]
    [remove_item]
        x,y=10,60
    [/remove_item]
    [unit]
	side=6
	type=Ukian Regular
	facing=ne
	x,y=8,60
    [/unit]
    [unit]
	side=6
	type=Ukian Regular
	facing=ne
	x,y=10,61
    [/unit]
    [unit]
	side=6
	type=Ukian Harrier
	facing=ne
	x,y=9,63
    [/unit]
    {ARCHAIC_KHTHONIZED (
	side=6
	x,y=8-10,60-63
	)}
    [terrain]
        terrain=Ur
        x=10
        y=60
    [/terrain]
    [redraw]
        side=3
    [/redraw]
    [message]
        speaker=unit
        message= _ "I heard squealing metal. Something happened."
    [/message]
[/event]

# open the East gate to lab trigger ornate
[event]
    name=moveto
    [filter]
        side=3
        x,y=6,62
    [/filter]
    [message]
        speaker=unit
        message= _ "This urn is attached to the floor... <i>*hrmph*</i>  It spins."
    [/message]
    [unit]
	side=6
	type=Ukian Regular
	facing=sw
	x,y=18,58
    [/unit]
    [unit]
	side=6
	type=Ukian Regular
	facing=sw
	x,y=19,59
    [/unit]
    [unit]
	side=6
	type=Ukian Regular
	facing=sw
	x,y=18,57
    [/unit]
    {ARCHAIC_KHTHONIZED (
	side=6
	x,y=18-19,57-59
	)}
    [remove_item]
        x,y=17,59
    [/remove_item]
    [terrain]
        terrain=Ur
        x=17
        y=59
    [/terrain]
    [redraw]
        side=3
    [/redraw]
    [message]
        speaker=unit
        message= _ "I heard squealing metal. Something happened."
    [/message]
[/event]

# open the lab
[event]
    name=moveto
    [filter]
        side=3
        x,y=23,63
    [/filter]
    [message]
        speaker=unit
        message= _ "This urn is attached to the floor... But it spins?"
    [/message]
    [unit]
	side=6
	type=Ukian Regular
	facing=sw
	x,y=16,50
    [/unit]
    [unit]
	side=6
	type=Ukian Regular
	facing=sw
	x,y=17,51
    [/unit]
    [unit]
	side=6
	type=Ukian Regular
	facing=sw
	x,y=17,50
    [/unit]
    {ARCHAIC_KHTHONIZED (
	side=6
	x,y=16-17,50-51
	)}
    [remove_item]
        x,y=16,51
    [/remove_item]
    [terrain]
        terrain=Rrc
        x=16
        y=51
    [/terrain]
    [redraw]
        side=3
    [/redraw]
    [message]
        speaker=unit
        message= _ "I heard squealing metal. Something happened."
    [/message]
[/event]

[event]
    name=moveto
    [filter]
        side=3
        x,y=20,48
    [/filter]
    [message]
        speaker=unit
        message= _ "These books are old, but they have not turned to dust.  I can't read any of this though..."
    [/message]
[/event]

[event]
    name=moveto
    [filter]
        side=3
        x,y=24,50
    [/filter]
    [message]
        speaker=unit
        message= _ "A box of ... little widgets... I'm not sure what they are."
    [/message]
[/event]

# open the big gate
[event]
    name=moveto
    [filter]
        side=3
        x,y=23,53
    [/filter]
    [message]
        speaker=unit
        message= _ "This urn is also attached to the floor... And it spins as well."
    [/message]
    {QUAKE "rumble.ogg"}
    [unit]
	side=1
	type=Ukian Regular
	facing=sw
	x,y=8,41
    [/unit]
    [unit]
	side=1
	type=Ukian Veteran
	facing=sw
	id=KT_veteran
	x,y=9,42
    [/unit]
    [apply_gear]
	gear_id=scale_armor
	id=KT_veteran
    [/apply_gear]	
    [unit]
	side=1
	facing=sw
	type=Ukian Regular
	x,y=10,42
    [/unit]
    {ARCHAIC_KHTHONIZED (
	side=1
	x,y=8-10,41-42
	)}
    [terrain]
        terrain=Rrc^Gywo
        x=7,8,9
        y=42,42,43
    [/terrain]
    [redraw]
        side=3
    [/redraw]
    {GENERIC_UNIT 6 "Ukian Commando" 19 45}
    {GUARDIAN}
    {GENERIC_UNIT 1 "Ukian Commando" 11 48}
    {GUARDIAN}
    {GENERIC_UNIT 4 "Ukian Commando" 25 32}
    {GUARDIAN}
    {ARCHAIC_KHTHONIZED (type="Ukian Commando")}
    {MODIFY_AI_ADD_ASPECT 2 leader_goal (
        [facet]
            id=always
            [value]
                x=19
                y=34
            [/value]
        [/facet]
    )}
    {MODIFY_AI_ADD_ASPECT 5 leader_goal (
        [facet]
            id=always
            [value]
                x=19
                y=34
            [/value]
        [/facet]
    )}
[/event]

# open the upper big gate
[event]
    name=moveto
    [filter]
        side=3
        x,y=25,31
    [/filter]
    [message]
        speaker=unit
        message= _ "This urn is also attached to the floor... And it spins as well."
    [/message]
    {QUAKE "rumble.ogg"}
    [terrain]
        terrain=Re^Gyeo
        x=17,18,19,20
        y=34,33,33,32
    [/terrain]
    [redraw]
        side=3
    [/redraw]
    [unstore_unit]
        variable=echidna
    [/unstore_unit]
    [unstore_unit]
        variable=new_leader
        find_vacant=no
    [/unstore_unit]
    [set_variable]
        name=gate1
        value=1
    [/set_variable]
    {GENERIC_UNIT 6 "Ukian Commando" 23 26}
    {GUARDIAN}
    {GENERIC_UNIT 1 "Ukian Commando" 4 27}
    {GUARDIAN}
    {GENERIC_UNIT 4 "Ukian Commando" 6 34}
    {GUARDIAN}
    [micro_ai]
        action=delete
        ai_type=patrol
        side=4
        ca_id=chimera1
    [/micro_ai]
    [micro_ai]
        action=add
        ai_type=patrol
        side=4
        ca_id=chimera2
        ca_score=170000
        id=Chimera
        waypoint_x=12,5
        waypoint_y=16,52
    [/micro_ai]
    {MODIFY_AI_ADD_ASPECT 2 leader_goal (
        [facet]
            id=always
            [value]
                x=13
                y=27
            [/value]
        [/facet]
    )}
    {MODIFY_AI_ADD_ASPECT 5 leader_goal (
        [facet]
            id=always
            [value]
                x=13
                y=27
            [/value]
        [/facet]
    )}
[/event]

[event]
    name=moveto
    [filter]
        side=3
        x,y=16-21,32-34
    [/filter]
    [if]
        [variable]
            name=gate1
            numerical_equals=1
        [/variable]
        [else]
            [message]
                speaker=unit
                message= _ "I see light beyond this gate."
            [/message]
            [message]
                speaker=Raenna
                message= _ "There has to be some way to open it."
            [/message]
        [/else]
    [/if]
[/event]

# WTF is this about?
[event]
    name=moveto
    [filter]
        side=3
        x,y=24,31
    [/filter]
    [message]
        speaker=unit
        message= _ "This tablet has strange writing on it, a picture of a human figure, and an odd symbol..."
    [/message]
    [message]
        speaker=Raenna
        message= _ "Sounds important... Though I'm not sure what to make of it for now."
    [/message]
[/event]

[event]
    name=moveto
    [filter]
        side=3
        x,y=20,50
    [/filter]
    [message]
        speaker=unit
        message= _ "There is a human skeleton under this thing... And an old book."
    [/message]
    [message]
        speaker=unit
        message= _ "I cannot read the writing, but there are lots of diagrams."
    [/message]
    [message]
        speaker=Raenna
        message= _ "Interesting..."
    [/message]
[/event]
[/scenario]
